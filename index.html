<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="theme-color" content="#000000">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DASH5.08.1</title>
   
<script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.10/SmoothScroll.min.js" crossorigin="anonymous"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.7/css/dataTables.tailwindcss.css" rel="stylesheet">
<link href="https://cdn.datatables.net/rowgroup/1.1.4/css/rowGroup.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/select/1.3.3/css/select.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/scroller/2.4.0/css/scroller.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/fixedheader/4.0.1/css/fixedHeader.dataTables.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" rel="stylesheet">
<style>
:root {
--table-border:#e2e8f0;--table-header-bg:#f8fafc;--table-header-text:#334155;--table-hover-bg:#f8fafc;
--table-stripe-bg:#f9fafb;--table-highlight-bg:#f1f5f9;--table-positive:#10b981;--table-negative:#ef4444;
--table-neutral:#f59e0b;--table-muted:#64748b;--table-padding-x:16px;--table-padding-y:12px;
--table-compact-padding-x:8px;--table-compact-padding-y:6px;--table-header-font-size:11px;
--table-body-font-size:13px;--table-compact-font-size:11px;
}
body{background:linear-gradient(45deg,#2c3036 0%,#3e3e40 100%);margin:0;padding:0;height:100vh;width:100vw;overflow-x:hidden}
.button{border:.1em solid transparent;border-radius:.5em;background-color:#010101;box-shadow:.0625em .0625em .0625em rgba(255,255,255,.6);padding:10px 20px;cursor:pointer;transition:background-color 0.3s ease}
.button:hover{background-color:#3b82f6;color:#fff}
.chart-box{height:400px;width:100%;margin-bottom:1rem}
.bg-white{margin-bottom:1rem}
.p-6{padding:1rem}
table{width:100%;border-collapse:collapse;font-size:var(--table-body-font-size);background:white}
.dataTables_wrapper{width:100%;overflow-x:auto}
table.dataTable thead th,th{background:#2a2a2a;color:#ffffff;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;font-size:var(--table-header-font-size);padding:12px;text-align:left;border-bottom:2px solid #4a4a4a;border-right:1px solid #4a4a4a;white-space:nowrap;position:relative}
table.dataTable tbody td,td{padding:10px;border-bottom:1px solid #e0e0e0;border-top:1px solid #e0e0e0;border-right:1px solid #e0e0e0;color:#475569;vertical-align:middle;background-color:#ffffff}
table.dataTable tbody tr:last-child td{border-bottom:1px solid #e0e0e0}
table.dataTable tbody td:last-child,table.dataTable thead th:last-child{border-right:none}
table.dataTable tbody tr:hover,tr:hover{background-color:#f0f9ff !important;transition:background-color 0.15s ease}
.table-container{background:white;border:1px solid var(--table-border);border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.02);width:100%;padding:0 0.5rem;margin-bottom:1rem}
.table-header{background:var(--table-header-bg);padding:20px 24px;border-bottom:1px solid var(--table-border)}
.table-header h3{margin:0;font-size:16px;font-weight:600;color:#1e293b}
.table-header p{margin:8px 0 0 0;font-size:13px;color:var(--table-muted)}
.table-content{overflow-x:auto;-webkit-overflow-scrolling:touch}
.table-hover tbody tr:hover{background:var(--table-hover-bg);transition:background-color 0.15s ease}
.table-striped tbody tr:nth-child(even){background:var(--table-stripe-bg)}
.table-compact{font-size:var(--table-compact-font-size)}
.table-compact th,.table-compact td{padding:var(--table-compact-padding-y) var(--table-compact-padding-x)}
.table-responsive{display:block;width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;-ms-overflow-style:-ms-autohiding-scrollbar}
.text-left{text-align:left !important}
.text-center{text-align:center !important}
.text-right{text-align:right !important}
th.numeric,td.numeric{text-align:right;font-variant-numeric:tabular-nums}
th.sortable{cursor:pointer;user-select:none;position:relative;padding-right:28px}
th.sortable::after{content:'‚áÖ';position:absolute;right:8px;opacity:0.3;font-size:10px}
th.sortable:hover::after{opacity:0.6}
th.sortable.asc::after{content:'‚Üë';opacity:1}
th.sortable.desc::after{content:'‚Üì';opacity:1}
.table-highlight,tr.highlight{background:var(--table-highlight-bg) !important;font-weight:600}
.table-footer,tfoot tr{background:#f1f5f9;font-weight:600;border-top:2px solid var(--table-border)}
.table-group-header{background:#1e293b;color:white;font-weight:600;text-transform:uppercase;font-size:10px;letter-spacing:1px}
.value-positive,.text-success{color:var(--table-positive);font-weight:600}
.value-negative,.text-danger{color:var(--table-negative);font-weight:600}
.value-neutral,.text-warning{color:var(--table-neutral);font-weight:600}
.value-muted,.text-muted{color:var(--table-muted);font-style:italic}
.table-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;line-height:1.4}
.table-badge.success{background:rgba(16,185,129,0.1);color:var(--table-positive)}
.table-badge.danger{background:rgba(239,68,68,0.1);color:var(--table-negative)}
.table-badge.warning{background:rgba(245,158,11,0.1);color:var(--table-neutral)}
.data-table{font-size:11px;width:100%}
.data-table th{background:#1e293b;color:white;padding:8px 4px;font-size:10px;font-weight:500;text-align:center;border:1px solid #334155}
.data-table td{padding:6px 4px;font-size:11px;text-align:center;border:1px solid #f1f5f9}
.data-table tbody tr:hover{background:var(--table-hover-bg)}
.data-table .font-semibold{font-weight:600;color:#0f172a}
.data-table .text-gray-400{color:#94a3b8;font-style:italic}
.data-table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -20px;padding:0 20px}
.table-empty{text-align:center;padding:48px 24px;color:#64748b}
.table-empty-icon{font-size:48px;opacity:0.3;margin-bottom:16px}
.table-empty-text{font-size:14px}
.dataTables_wrapper .dataTables_length,.dataTables_wrapper .dataTables_filter,.dataTables_wrapper .dataTables_info,.dataTables_wrapper .dataTables_paginate{font-size:11px;box-shadow:inset 1px 1px 2px 0px rgba(255,255,255,.5);color:#64748b}
.dataTables_wrapper .dataTables_filter input{background-color:rgba(255,255,255,0.1);border:1px solid rgba(0,255,255,0.3);color:#e0e0e0;border-radius:4px;padding:6px 12px;font-size:13px;transition:all 0.3s ease}
.dataTables_wrapper .dataTables_filter input:focus{background-color:rgba(255,255,255,0.2);border-color:#00ffff;box-shadow:0 0 10px rgba(0,255,255,0.5);outline:none}
.fuel-summary{border-radius:0.5rem;padding:1rem;margin-bottom:1rem}
.dt-buttons .dt-button{background-color:#4A90E2;color:white;border-radius:4px;padding:8px 16px;font-size:14px;font-weight:bold;border:none;margin:3px;transition:background-color 0.3s ease,color 0.3s ease}
.dt-buttons .dt-button:hover{background-color:#357ABD;color:#FFF}
.dt-button-collection{background-color:#FFF;border:1px solid #CCC}
.dt-button-collection .dt-button{background-color:#F5F5F5;color:#333}
.dt-button-collection .dt-button:hover{background-color:#E0E0E0;color:#000}
#total-import-time{background-color:red;color:white;border-radius:4px;padding:5px 10px}
#map{height:420px;width:100%;border-radius:8px}
select,input[type="text"]{background-color:rgba(255,255,255,0.1);border:1px solid rgba(0,255,255,0.3);color:#e0e0e0;transition:all 0.3s ease}
select:focus,input[type="text"]:focus{background-color:rgba(255,255,255,0.2);border-color:#00ffff;box-shadow:0 0 10px rgba(0,255,255,0.5)}
input:checked+.slider{background-color:#2563eb}
input:checked+.slider:before{transform:translateX(20px)}
.mapping-controls{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:20px;margin-bottom:20px}
.form-check{margin-bottom:10px}
.form-check-input:checked{background-color:#198754;border-color:#198754}
.form-check-label{font-weight:500;color:#495057}
.control-buttons{margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6}
.btn-outline-success{margin-right:10px}
.mapping-title{color:#198754;font-weight:600;margin-bottom:15px}
.mapping-description{font-size:0.9em;color:#6c757d;margin-bottom:15px}
#aktualna-godzina{font-family:'Roboto Mono',monospace;letter-spacing:0.05em}
.scramble-animation{animation:scrambleGlow 0.5s ease-in-out}
@keyframes scrambleGlow{0%,100%{text-shadow:none}50%{text-shadow:0 0 10px rgba(59,130,246,0.5)}}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
@keyframes tableRowFadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.animate-pulse{animation:pulse 2s ease-in-out}
.accordion{transition:transform 0.3s,opacity 0.3s;will-change:transform}
.loaded{opacity:1 !important}
.table-row-animated{animation:tableRowFadeIn 0.3s ease-out}
.table-sorting{transition:opacity 0.2s ease;opacity:0.7}
.table-wrapper{display:flex;flex-wrap:wrap;margin:0 -0.5rem}
.bg-white.rounded-md.shadow-lg.overflow-hidden button:hover{color:#3b82f6}
@media(max-width:768px){
.table-mobile-stack thead{display:none}
.table-mobile-stack tr{display:block;margin-bottom:16px;border:1px solid var(--table-border);border-radius:8px;padding:12px}
.table-mobile-stack td{display:flex;justify-content:space-between;padding:8px 0;border:none;border-bottom:1px solid #f1f5f9}
.table-mobile-stack td:last-child{border-bottom:none}
.table-mobile-stack td::before{content:attr(data-label);font-weight:600;color:#475569;font-size:12px}
table.dataTable{font-size:0.9em}
table.dataTable tbody td,table.dataTable thead th{padding:4px}
.chart-box{height:420px}
.button{padding:8px 16px}
}
@media(min-width:760px){
.table-responsive{overflow-x:auto}
.table-container{width:50%;padding:0 0.5rem;margin-bottom:1rem}
}
@media print{
.table-container{page-break-inside:avoid;box-shadow:none;border:1px solid #ddd}
th{background:#f5f5f5 !important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.table-striped tbody tr:nth-child(even){background:#fafafa !important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
}

</style>
</head>
<body class="w-full">
<script>
class PerformanceOptimizer{constructor(){this.cacheKey='DASH5.07.8_cache';this.cacheExpiry=24*60*60*1000}init(){this.lazyLoadImages();if(!document.getElementById('perf-styles')){const style=document.createElement('style');style.id='perf-styles';style.textContent='.accordion{transition:transform .3s,opacity .3s;will-change:transform}.loaded{opacity:1!important}';document.head.appendChild(style)}}lazyLoadImages(){const images=document.querySelectorAll('img[data-src]');if(!images.length)return;if('IntersectionObserver' in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.classList.add('loaded');img.removeAttribute('data-src');observer.unobserve(img)}})},{rootMargin:'50px'});images.forEach(img=>{img.style.opacity='0';img.style.transition='opacity 0.3s';imageObserver.observe(img)})}else{images.forEach(img=>{img.src=img.dataset.src;img.removeAttribute('data-src')})}}cache(key,data=null){const fullKey=`${this.cacheKey}_${key}`;if(data===null){try{const item=localStorage.getItem(fullKey);if(!item)return null;const{value,expiry}=JSON.parse(item);if(Date.now()>expiry){localStorage.removeItem(fullKey);return null}return value}catch{return null}}else{try{const item={value:data,expiry:Date.now()+this.cacheExpiry};localStorage.setItem(fullKey,JSON.stringify(item))}catch(e){if(e.name==='QuotaExceededError'){this.cleanCache();try{localStorage.setItem(fullKey,JSON.stringify(item))}catch{}}}}}cleanCache(){const keys=Object.keys(localStorage).filter(key=>key.startsWith(this.cacheKey));if(keys.length>10){keys.slice(0,Math.floor(keys.length/2)).forEach(key=>localStorage.removeItem(key))}}}
function toggleAccordion(button){const closeOthers=document.getElementById('closeOthersCheckbox')?.checked;const content=button.nextElementSibling;if(content)content.classList.toggle('hidden');const icon=button.querySelector('i:last-child');if(icon)icon.classList.toggle('rotate-180');if(navigator.vibrate)setTimeout(()=>navigator.vibrate(5),0);if(closeOthers&&content&&!content.classList.contains('hidden')){document.querySelectorAll('.accordion-container').forEach(acc=>{if(!acc.contains(button)){const accButton=acc.querySelector('button');const accContent=accButton.nextElementSibling;const accIcon=accButton.querySelector('i:last-child');accContent?.classList.add('hidden');accIcon?.classList.remove('rotate-180')}})}}
function toggleFullScreen(){const doc=document;const docEl=doc.documentElement;const requestFullScreen=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullscreen||docEl.msRequestFullscreen;const exitFullScreen=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;if(!doc.fullscreenElement&&!doc.mozFullScreenElement&&!doc.webkitFullscreenElement&&!doc.msFullscreenElement){requestFullScreen.call(docEl)}else{exitFullScreen.call(doc)}}
function createFullScreenButton(){const btn=document.createElement('button');btn.innerHTML='‚õ∂';btn.className='fixed top-4 right-4 z-50 w-10 h-10 bg-gray-800/70 border border-gray-600/30 rounded-md backdrop-blur-sm hover:bg-gray-700/80 transition-all duration-300 shadow-inner active:shadow-[inset_0_2px_4px_rgba(0,0,0,0.6)] active:transform active:translate-y-0.5 text-gray-300 hover:text-white';btn.setAttribute('aria-label','Prze≈ÇƒÖcz tryb pe≈Çnoekranowy');btn.addEventListener('click',toggleFullScreen);document.body.appendChild(btn)}
const startAnimation=()=>{const timeDiv=document.getElementById('aktualna-godzina');if(!timeDiv)return;let timeIteration=0;const originalTime=timeDiv.innerText;timeDiv.classList.add('scramble-animation');const timeInterval=setInterval(()=>{timeDiv.innerText=originalTime.split("").map((letter,index)=>{if(index<timeIteration){return originalTime[index]}if(letter===':')return':';return String.fromCharCode(Math.floor(Math.random()*10)+48)}).join("");if(timeIteration>=originalTime.length){clearInterval(timeInterval);timeDiv.innerText=originalTime;setTimeout(()=>{timeDiv.classList.remove('scramble-animation')},500)}timeIteration+=1/3},40)};
function aktualizujDateGodzine(){try{const dzisiaj=new Date();const dzienTygodnia=['Niedziela','Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota'][dzisiaj.getDay()];const dzien=dzisiaj.getDate();const miesiac=['stycznia','lutego','marca','kwietnia','maja','czerwca','lipca','sierpnia','wrze≈õnia','pa≈∫dziernika','listopada','grudnia'][dzisiaj.getMonth()];const rok=dzisiaj.getFullYear();const godzina=dzisiaj.getHours().toString().padStart(2,'0');const minuta=dzisiaj.getMinutes().toString().padStart(2,'0');const sekunda=dzisiaj.getSeconds().toString().padStart(2,'0');const godzinaElement=document.getElementById('aktualna-godzina');if(godzinaElement){godzinaElement.textContent=`${godzina}:${minuta}:${sekunda}`}const nazwaElement=document.getElementById('nazwa-dnia');if(nazwaElement){nazwaElement.textContent=dzienTygodnia}const dataElement=document.getElementById('aktualna-data');if(dataElement){dataElement.textContent=`${dzien} ${miesiac} ${rok}`}console.log(`‚è∞ Czas zaktualizowany: ${godzina}:${minuta}:${sekunda}`)}catch(error){console.error("‚ùå WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji daty i godziny:",error)}}
function aktualizujSekundy(){try{const sekunda=new Date().getSeconds().toString().padStart(2,'0');const elementCzasu=document.getElementById('aktualna-godzina');if(elementCzasu&&elementCzasu.textContent.length>=8){elementCzasu.textContent=elementCzasu.textContent.slice(0,-2)+sekunda}}catch(error){console.error("‚ùå WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji sekund:",error)}}
function checkSmoothScrollStatus(){console.log('\nüîç Sprawdzanie statusu SmoothScroll...');const status={biblioteka:typeof SmoothScroll!=='undefined',obiektGlobalny:!!window.SmoothScroll,skryptWDOM:!!document.querySelector('script[src*="smoothscroll"]'),cssScrollBehavior:getComputedStyle(document.documentElement).scrollBehavior,przegladarka:navigator.userAgent};console.table(status);if(status.biblioteka){console.log('‚úÖ SmoothScroll jest dostƒôpny i mo≈ºna go u≈ºywaƒá')}else{console.log('‚ùå SmoothScroll nie jest dostƒôpny')}if(status.cssScrollBehavior==='smooth'){console.warn('‚ö†Ô∏è CSS scroll-behavior jest ustawiony na "smooth" - mo≈ºe to konfliktowaƒá z bibliotekƒÖ SmoothScroll')}return status}
window.checkSmoothScrollStatus=checkSmoothScrollStatus;
let scrambleInterval,secondsInterval,minuteInterval;
function initializeClock(){if(scrambleInterval)clearInterval(scrambleInterval);if(secondsInterval)clearInterval(secondsInterval);if(minuteInterval)clearInterval(minuteInterval);aktualizujDateGodzine();secondsInterval=setInterval(aktualizujSekundy,1000);minuteInterval=setInterval(aktualizujDateGodzine,60000);scrambleInterval=setInterval(startAnimation,50000);console.log('üïê Zegar zosta≈Ç zainicjalizowany')}
document.addEventListener('DOMContentLoaded',()=>{new PerformanceOptimizer().init();createFullScreenButton();initializeClock();document.querySelector('.accordion-container button i.fa-chart-line')?.closest('button')?.click();console.log('=== SmoothScroll Status ===');if(typeof SmoothScroll!=='undefined'){try{SmoothScroll({animationTime:200,stepSize:65,keyboardSupport:true,arrowScroll:50,pulseAlgorithm:true,pulseScale:4,pulseNormalize:1,touchpadSupport:true});console.log('‚úÖ SmoothScroll: WSPIERANE');console.log('‚úÖ Biblioteka zosta≈Ça za≈Çadowana poprawnie');console.log('‚úÖ SmoothScroll zosta≈Ç zainicjalizowany');if(window.SmoothScroll){console.log('‚úÖ Obiekt SmoothScroll jest dostƒôpny globalnie')}}catch(error){console.error('‚ùå SmoothScroll: B≈ÅƒÑD INICJALIZACJI');console.error('Szczeg√≥≈Çy b≈Çƒôdu:',error)}}else{console.error('‚ùå SmoothScroll: NIE WSPIERANE');console.error('‚ùå Biblioteka SmoothScroll nie zosta≈Ça za≈Çadowana');const smoothScrollScript=document.querySelector('script[src*="smoothscroll"]');if(smoothScrollScript){console.log('‚ÑπÔ∏è Tag <script> dla SmoothScroll jest obecny w DOM:',smoothScrollScript.src)}else{console.log('‚ÑπÔ∏è Tag <script> dla SmoothScroll NIE zosta≈Ç znaleziony w DOM')}}console.log('=========================')});
document.addEventListener('touchstart',e=>{if(e.touches.length>1||(e.type==='touchstart'&&e.touches.length>1)||e.detail===2){e.preventDefault()}},{passive:false});
function safeJSONParse(jsonString,defaultValue=null){try{return JSON.parse(jsonString)}catch(error){console.warn('B≈ÇƒÖd parsowania JSON:',error);return defaultValue}}
function safeSaveToLocalStorage(key,data){try{localStorage.setItem(key,JSON.stringify(data))}catch(error){console.error('B≈ÇƒÖd zapisu do localStorage:',error);if(error instanceof DOMException&&error.name==='QuotaExceededError'){const keys=Object.keys(localStorage).slice(0,5);keys.forEach(k=>localStorage.removeItem(k));try{localStorage.setItem(key,JSON.stringify(data))}catch{}}}}
function browserSupportCheck(){return{localStorage:!!window.localStorage,sessionStorage:!!window.sessionStorage,indexedDB:!!window.indexedDB,serviceWorker:'serviceWorker' in navigator,webWorkers:!!window.Worker,fullscreen:!!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled),smoothScroll:typeof SmoothScroll!=='undefined'}}
console.log('Wsparcie przeglƒÖdarki:',browserSupportCheck());
</script>
<div class="w-full px-1 py-1">
        <div class="mb-1">
            <div class="mb-1">
                <label for="file-input" id="dropzone" class="block border-2 border-dashed border-gray-300 rounded-md p-4 text-center cursor-pointer bg-white shadow hover:bg-blue-50 hover:border-blue-500 transition">
                    <i class="fas fa-cloud-upload-alt text-blue-500 text-2xl mb-2"></i>
                    <p class="text-gray-700 font-semibold">Kliknij lub przeciƒÖgnij i upu≈õƒá pliki</p>
                    <input type="file" id="file-input" class="hidden" multiple>
                </label>
                <p id="file-info" class="text-red-500 mt-2 text-sm"></p>
            </div>

            <div class="bg-white rounded-md shadow p-2 mb-2 flex flex-col space-y-2">
                <div class="flex items-center justify-between">
                    <h1 class="text-3xl font-bold cursor-pointer" id="aktualna-godzina" onclick="startAnimation();">00:00:00</h1>
                </div>
                <hr class="my-1"/>
                <div class="flex items-center text-xs justify-between">
                    <div class="flex items-center">
                        <p class="mr-2" id="nazwa-dnia"></p>
                        <p class="mr-2" id="aktualna-data"></p>
                        <p id="total-import-time" class="bg-red-500 text-white rounded px-2 py-1 flex items-center text-xs">
                            <i class="fas fa-gas-pump mr-1"></i>DASH5.08.1
                        </p>
                    </div>
                    <label class="flex items-center cursor-pointer">
                        <div class="relative inline-block w-11 h-6">
                            <input type="checkbox" id="closeOthersCheckbox" class="opacity-0 w-0 h-0" checked>
                            <span class="slider absolute cursor-pointer inset-0 bg-gray-200 transition-all duration-300 rounded-full before:absolute before:content-[''] before:h-5 before:w-5 before:rounded-full before:bg-white before:transition-all before:duration-300 before:left-[2px] before:bottom-[2px] before:shadow-sm"></span>
                        </div>
                        <span class="ml-2 text-sm text-gray-600">Auto-zamykanie</span>
                    </label>
                </div>
                <div class="accordion-container">
                    <button class="w-full px-2 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
                        <span><i class="fas fa-list-ul text-blue-500 mr-2"></i>Lista plik√≥w</span>
                        <i class="fas fa-chevron-down transition-transform duration-300"></i>
                    </button>
                    <div class="hidden p-0.5">
                        <ul id="file-list" class="list-disc pl-6 text-gray-700"></ul>
                    </div>
                </div>
            </div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-chart-line text-blue-500 mr-2"></i>Analiza wydatk√≥w kart FLOTA</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<div class="grid grid-cols-2 md:grid-cols-2 gap-2 mb-0 px-2 py-0">
<div class="fuel-summary bg-green-50">
<h3 class="text-lg font-bold mb-2 text-green-600">
<i class="fas fa-gas-pump text-green-500 mr-2"></i>Benzyna
</h3>
<p class="text-sm">Okres: <span id="benzynaOkres" class="text-sm"></span></p>
<p class="font-bold">Suma: <span id="benzynaSuma" class="font-bold text-green-600"></span></p>
</div>
<div class="fuel-summary bg-gray-50">
<h3 class="text-lg font-semibold mb-2">
<i class="fas fa-gas-pump text-blue-500 mr-2"></i>Olej napƒôdowy
</h3>
<p class="text-sm">Okres: <span id="olejNapedowyOkres" class="text-sm"></span></p>
<p class="font-bold">Suma: <span id="olejNapedowySuma" class="font-bold"></span></p>
</div>
</div>
<div id="dashboard-row-1" class="mb-0">
<div id="chart-container-0"></div>
</div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-table text-blue-500 mr-2"></i>Zaimportowane dane</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<h3 class="text-lg font-semibold mb-2">Wybierz kolumny:</h3>
<select id="columnVisibility" multiple class="w-full border border-gray-300 rounded-md py-2 px-3 mb-2"></select>
<div class="overflow-x-auto">
<table id="example" class="w-full table-auto table-hover"></table>
</div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-car text-blue-500 mr-2"></i>Podsumowanie i wykresy</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generate-summary" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700 mb-2">Wygeneruj</button>
<div class="table-wrapper">
<div id="summary-table-container" class="table-container"></div>
<div id="summary2-table-container" class="table-container"></div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4">
<div>
<h3 class="text-lg font-semibold mb-2 text-gray-700">Zlicz:</h3>
<select class="form-control bg-blue-50 border-blue-300" id="select-column">
<option value="Warto≈õƒá netto">Warto≈õƒá netto</option>
<option value="Ilo≈õƒá">Ilo≈õƒá</option>
<option value="activeCardsColumn">Liczba aktywnych kart</option>
<option value="transactionCount">Ilo≈õƒá transakcji</option>
</select>
</div>
<div>
<h3 class="text-lg font-semibold mb-2 text-gray-700">Numer rejestracyjny</h3>
<div class="flex space-x-2">
<select class="form-control bg-green-50 border-green-300 w-1/2" id="select-registration-number">
<option>Wybierz numer</option>
</select>
<input type="text" class="form-control bg-green-50 border-green-300 w-1/2" id="search-registration-number" placeholder="Wyszukaj">
</div>
</div>
<div>
<h3 class="text-lg font-semibold mb-2 text-gray-700">Grupa</h3>
<div class="flex space-x-2">
<select class="form-control bg-purple-50 border-purple-300 w-1/2" id="select-group">
<option>Wybierz grupƒô</option>
</select>
<input type="text" class="form-control bg-purple-50 border-purple-300 w-1/2" id="search-group" placeholder="Wyszukaj">
</div>
</div>
<div>
<h3 class="text-lg font-semibold mb-2 text-gray-700">Numer karty</h3>
<div class="flex space-x-2">
<select class="form-control bg-orange-50 border-orange-300 w-1/2" id="select-card-number">
<option>Wybierz numer karty</option>
</select>
<input type="text" class="form-control bg-orange-50 border-orange-300 w-1/2" id="search-card-number" placeholder="Wyszukaj">
</div>
</div>
</div>
<div id="chart-container-1"></div>
<div id="chart-container-2"></div>
<div id="chart-container-3"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>Podsumowanie paliwo - pojazd/miesiƒÖc/Ilo≈õƒá/warto≈õƒá/licznik</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary3Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary3-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>Wskazania licznika (podzia≈Ç na miesiƒÖce)</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary4Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary4-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-gas-pump text-blue-500 mr-2"></i>Zakupy wg stacji</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary5Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary5-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-calendar-week text-blue-500 mr-2"></i>Transakcje Weekend #6</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary6Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div class="grid grid-cols-2 md:grid-cols-2 gap-2">
<div class="bg-yellow-100 border border-yellow-200 p-2 rounded">
<h3 class="text-lg font-bold mb-1 text-yellow-700">
<i class="fas fa-calendar-check text-yellow-500 mr-2"></i>Sobota
</h3>
<p class="font-bold">Suma: <span id="SaturdaySuma" class="font-bold text-yellow-700"></span></p>
</div>
<div class="bg-red-100 border border-red-200 p-2 rounded">
<h3 class="text-lg font-bold mb-1 text-red-700">
<i class="fas fa-calendar-times text-red-500 mr-2"></i>Niedziela
</h3>
<p class="font-bold">Suma: <span id="SundaySuma" class="font-bold text-red-700"></span></p>
</div>
</div>
<div id="month-selector-container" class="mb-4"></div>
<div id="summary6-table-container" class="mt-2 table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-ellipsis-h text-blue-500 mr-2"></i>Inn..go #7</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary7Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary7-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-ellipsis-h text-blue-500 mr-2"></i>Inn..go #8</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary8Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary8-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-chart-pie text-blue-500 mr-2"></i>Statystyki produkt√≥w #9 #10</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary9Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary9-table-container" class="table-responsive"></div>
<div id="summary10-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-clipboard-list text-blue-500 mr-2"></i>Statystyki produkt√≥w wg pojazdu/#11 #12</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary11Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary11-table-container" class="table-responsive"></div>
<div id="summary12-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-burn text-blue-500 mr-2"></i>Spalanie</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary13Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary13-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-burn text-blue-500 mr-2"></i>≈örednia cena</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary14Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary14-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-burn text-blue-500 mr-2"></i>R√≥≈ºnice</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<button id="generateSummary15Button" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 mb-2">Wygeneruj</button>
<div id="summary15-table-container" class="table-responsive"></div>
</div>
</div>
<div class="accordion-container bg-white rounded-md shadow-lg overflow-hidden mb-2">
<button class="w-full px-4 py-3 text-left font-semibold flex items-center justify-between focus:outline-none" onclick="toggleAccordion(this)">
<span><i class="fas fa-cog text-blue-500 mr-2"></i>Ustawienia</span>
<i class="fas fa-chevron-down transition-transform duration-300"></i>
</button>
<div class="hidden p-0.5">
<div class="container mt-4">
<div class="mapping-controls">
<h5 class="mapping-title">
<i class="fas fa-cogs"></i> Ustawienia mapowania danych
</h5>
<p class="mapping-description">Kontroluj spos√≥b przetwarzania i mapowania danych z importowanych plik√≥w</p>
<div class="row">
<div class="col-md-6">
<div class="form-check form-switch">
<input class="form-check-input" type="checkbox" id="toggle-header-mapping" checked>
<label class="form-check-label" for="toggle-header-mapping">Mapowanie nag≈Ç√≥wk√≥w kolumn</label>
<div class="form-text">Automatyczne mapowanie nazw kolumn (np. "NrFaktury" ‚Üí "Nr karty")</div>
</div>
<div class="form-check form-switch">
<input class="form-check-input" type="checkbox" id="toggle-group-mapping" checked>
<label class="form-check-label" for="toggle-group-mapping">Mapowanie grup produkt√≥w</label>
<div class="form-text">Mapowanie nazw grup (np. "01" ‚Üí "Olej napƒôdowy")</div>
</div>
</div>
<div class="col-md-6">
<div class="form-check form-switch">
<input class="form-check-input" type="checkbox" id="toggle-group-code-mapping" checked>
<label class="form-check-label" for="toggle-group-code-mapping">Mapowanie kod√≥w grup</label>
<div class="form-text">Mapowanie kod√≥w ksiƒôgowych (np. "401-115-01-1" ‚Üí "Paliwo")</div>
</div>
<div class="form-check form-switch">
<input class="form-check-input" type="checkbox" id="toggle-registration-normalization" checked>
<label class="form-check-label" for="toggle-registration-normalization">Normalizacja numer√≥w rejestracyjnych</label>
<div class="form-text">Usuwanie spacji i mapowanie numer√≥w (np. "CBXXXXX" ‚Üí "CMGXXXXX")</div>
</div>
</div>
</div>
<div class="control-buttons">
<button type="button" class="btn btn-outline-success btn-sm" onclick="toggleAllMappings(true)">
<i class="fas fa-check-circle"></i> W≈ÇƒÖcz wszystkie
</button>
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllMappings(false)">
<i class="fas fa-times-circle"></i> Wy≈ÇƒÖcz wszystkie
</button>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="w-full px-2 py-2">
<button id="generateAllTablesButton" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all duration-300">Gen all</button>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.tailwindcss.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.1/js/buttons.dataTables.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/rowgroup/1.1.4/js/dataTables.rowGroup.min.js"></script>
<script src="https://cdn.datatables.net/staterestore/1.3.0/js/dataTables.stateRestore.js"></script>
<script src="https://cdn.datatables.net/scroller/2.4.0/js/dataTables.scroller.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/4.0.1/js/dataTables.fixedHeader.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.7/pagination/extjs.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.7/dataRender/ellipsis.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/offline-exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/highcharts-3d.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/modules/stock.js"></script>
<script src="https://code.highcharts.com/modules/xrange.js"></script>
<script src="https://code.highcharts.com/modules/drilldown.js"></script>
<script src="https://code.highcharts.com/themes/gray.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chroma-js@2.1.1/chroma.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // Funkcje pomocnicze dla prze≈ÇƒÖcznik√≥w
        function toggleAllMappings(enabled) {
            document.getElementById('toggle-header-mapping').checked = enabled;
            document.getElementById('toggle-group-mapping').checked = enabled;
            document.getElementById('toggle-group-code-mapping').checked = enabled;
            document.getElementById('toggle-registration-normalization').checked = enabled;
            
            ['toggle-header-mapping', 'toggle-group-mapping', 'toggle-group-code-mapping', 'toggle-registration-normalization'].forEach(id => {
                document.getElementById(id).dispatchEvent(new Event('change'));
            });
        }

        function saveMappingSettings() {
            const settings = {
                headerMapping: document.getElementById('toggle-header-mapping').checked,
                groupMapping: document.getElementById('toggle-group-mapping').checked,
                groupCodeMapping: document.getElementById('toggle-group-code-mapping').checked,
                registrationNormalization: document.getElementById('toggle-registration-normalization').checked
            };
            localStorage.setItem('mappingSettings', JSON.stringify(settings));
        }

        function loadMappingSettings() {
            const saved = localStorage.getItem('mappingSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('toggle-header-mapping').checked = settings.headerMapping ?? true;
                document.getElementById('toggle-group-mapping').checked = settings.groupMapping ?? true;
                document.getElementById('toggle-group-code-mapping').checked = settings.groupCodeMapping ?? true;
                document.getElementById('toggle-registration-normalization').checked = settings.registrationNormalization ?? true;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadMappingSettings();
            
            ['toggle-header-mapping', 'toggle-group-mapping', 'toggle-group-code-mapping', 'toggle-registration-normalization'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveMappingSettings);
                }
            });
        });

        document.addEventListener('dblclick', e => e.preventDefault());
        document.addEventListener('gesturestart', e => e.preventDefault());
</script>
<script>
// Global variables - dodane zmienne dla prze≈ÇƒÖcznik√≥w mapowania
let mainTable, summaryTable, summary2Table;
let jsonData = [];
let selectedGroup = '';
let selectedColumn = '';
let valueColumn = 'Warto≈õƒá netto';
let selectedRegistrationNumber = '';
let selectedCardNumber = '';
let useRowGrouping = true; 
const cardNumbersWithDescriptions = {};
const uniqueRegistrationNumbers = new Set();
const uniqueGroups = new Set();
const activeCardsColumn = 'Nr karty';
const transactionCountColumn = 'TRANSACTION_COUNT'; // Nowa zmienna dla opcji liczenia transakcji

// Zmienne kontrolujƒÖce mapowania - domy≈õlnie wszystkie aktywne
let enableHeaderMapping = true;
let enableGroupMapping = true;
let enableGroupCodeMapping = true;
let enableRegistrationNumberNormalization = true;

let columnIndices = {};

// Funkcja mapowania numer√≥w rejestracyjnych
function mapRegistrationNumber(regNumber) {
    if (!regNumber || typeof regNumber !== 'string') {
        return regNumber;
    }

    // Mapowanie pe≈Çnych numer√≥w rejestracyjnych
    const registrationMapping = {
  'CB032NM': 'CMG4651A',
  'CB885NL': 'CMG4649A',
  'CB976NL': 'CMG4724A',
  'CB027NM': 'CMG4647A',
  'CB977NL': 'CMG4728A',
  'CB698NL': 'CMG4650A',
  'CB026NM': 'CMG4773A',
  'CB884NL': 'CMG4729A',
  'CB864NL': 'CMG4743A',
  'CB196NL': 'CMG4652A',
  'CB861NL': 'CMG4732A',
  'CB623NK': 'CMG4648A',
  'CB449NL': 'CMG4758A',
  'CB029NM': 'CMG4754A',
  'CB964NK': 'CMG4891A',
  'CB695NL': 'CMG4850A',
  'CB447NL': 'CMG4757A',
  'CB697NL': 'CMG4731A',
  'CB195NL': 'CMG4755A',
  'CB949NL': 'CMG4759A',
  'CB185NN': 'CMG4750A',
  'CB807NN': 'CMG4751A',
  'CB671NN': 'CMG4748A',
  'CB629NN': 'CMG4752A',
  'CB827NN': 'CMG4753A',
  'CB826NN': 'CMG4746A',
  'CB498NN': 'CMG4727A',
  'CB802NN': 'CMG4726A',
  'CB499NN': 'CMG4745A',
  'CB805NN': 'CMG4730A',
  'CB801NN': 'CMG4725A',
  'CB184NN': 'CMG4756A',
  'CB674NN': 'CMG4890A',
  'WE5E887': 'CMG4248A',
  'WE5F505': 'CMG4259A',
  'WE5F508': 'CMG4260A',
  'WE5E883': 'CMG4284A',
  
// Nowe wpisy:
  'BI023FU': 'WE5U406',
  'CB240PW': 'WE5T559',
  'CB289PY': 'WE5F411',
  'CB520RM': 'WE5F414',
  'CT356AU': 'WE5F411',
  'DW4UT26': 'WE5F409',
  'DW5PJ62': 'WE5F409',
  'DW6WA09': 'WE5F506',
  'DW7WC05': 'WE5T554',
  'EL5S578': 'WE6A165',
  'EL6HA17': 'WE5F411',
  'EL6HF92': 'WE6A164',
  'EL9GY20': 'WE5T549',
  'GD4L893': 'WE6A165',
  'KR5CX40': 'WE5T564',
  'OP1009V': 'WE5F410',
  'PO1NF64': 'WE6N046',
  'PY57518': 'WE6A164',
  'PY70604': 'WE6A619',
  'PY99131': 'WE5T566',
  'RJA94800': 'WE5E884',
  'RZ425EJ': 'WE5T566',
  'WB2043Y': 'WE6E586',
  'WB6885Y': 'WE6E588',
  'WB7863X': 'WE6A618',
  'WD0601R': 'WE5F507',
  'WE1AT27': 'WE5E890',
  'WE4AT46': 'WE6E585',
  'WE6R101': 'WE6A166',
  'WE849VG': 'WE5E885',
  'WJ0025N': 'WE5T552',
  'WJ0860M': 'WE5T552',
  'WJ4435K': 'WE5E884',
  'WL1467U': 'WE5T562',
  'WN3683T': 'WE6A166',
  'WN4034S': 'WE5F409',
  'WN814R': 'WE5E886',
  'WND5828C': 'WE6A621',
  'WPN03788': 'WE5F402',
  'WPN07190': 'WE6N023',
  'WPN31427': 'WE5E884',
  'WPN8PW8': 'WE5F507',
  'WT4697G': 'WE6E588',
  'WT9021F': 'WE5T554',
  'WT9335F': 'WE5T554',
  'WY128XE': 'WE5T556',
  'WY441XJ': 'WE5E885',
  'WY548EL': 'WE5F506',
  'WZ039HE': 'WE5F405',
  'WZ180GG': 'WE5F406',
  'WZ246HE': 'WE5F502',
  'WZ307GV': 'WE6A166',
  'WZ730GF': 'WE5T551',
  'WZ917EG': 'WE6A166',
  'BI173GN': 'CMG16X3',
  'PO5WF01': 'CMG7H25',
  'EL7LKO6': 'CMG24C5',
  'EL8LS16': 'CMG24C5',
  'PY5093A': 'CMG89C8',
  'CB729MS': 'CMG76G5',
  'NE5386K': 'CMG24G9',
  'CT075CH': 'CMG7H25',
  'CT157CG': 'CMG7H25',
  'CT882CE': 'CMG7H25',
  'WD7984S': 'CMG23J9',
  'EKU14274': 'CMG34K2',
  'EKU15533': 'CMG51G3',
  'WJ5911L': 'CMG59X8',
  'BI798FM': 'CMG59X8',
  'WND54897': 'CMG79W6',
  'WP0080S': 'CMG56S2',
  'WY190XL': 'CMG17U4',
  'ZS905SE': 'CMG4730A',
  'KK93461': 'CMG4730A',
  'EL6JK38': 'CMG4730A',
  'WZ831GK': 'CMG63X1',
  'WX1326E': 'CMG63X1',
  'WZ249GV': 'CMG4752A',
  'EL7HX81': 'CMG4752A',
  'WY653XL': 'CB803NN',
  'LU924SJ': 'CB803NN',
  'WU8242P': 'CMG37G6',
  'WS829F': 'CMG31J9',
  'WPI9176J': 'CB693NL',
  'WN0987T': 'CB286NP',
  'WL821V': 'CMG91W6',
  'WGM0892G': 'CMG4732A',
  'WEB49VG': 'WE5E885',
  'WE8T727': 'CMG80W7',
  'CIN9187C': 'CMG57E6',
  'DLU7063C': 'CMG59N4',
  'DW1WL22': 'CB806NN',
  'EL1EF06': 'CMG4729A',
  'EL6ER38': 'CMG4647A',
  'EL8HX92': 'CMG5N89',
  'GA391KH': 'CMG06W4',
  'GD2G431': 'CMG85J7',
  'KK51242': 'CB675NN',
  'KK9512C': 'CMG2026A',
  'LSW42863': 'CMG43Y7',
  'LU078SG': 'CMG12U9',
  'NO3094V': 'CMG92W6',
  'NOL6745E': 'CB028NM',
  'PK0944R': 'CMG20W4',
  'PK7921L': 'CMG4731A',
  'PO2WF24': 'CMG30H2',
  'PO8LW83': 'CMG56E6',
  'PY06526': 'CMG5N89',
  'PY09266': 'CMG89W7',
  'PY1411E': 'CMG13N9',
  'PY72650': 'CMG15X3',
  'RMI5601C': 'CMG06W4',
  'WD8099P': 'CMG4W19',
  'PY72787': 'CMG4652A',
  'PY71142': 'CMG16W4',
  'NO2236W': 'CMG15W4',
  'KK64370': 'CMG59N4',
  'EL3GY54': 'CMG12U9',
  'RZE99880': 'CMG62N4',
  'PK6799R': 'CB828NN',
  'PK5606R': 'CMG92W7',
  'OP7350T': 'CMG14X3',
  'NOL2104F': 'CB950NL',
  'PY76088': 'CB675NN',
  'PK9289L': 'CMG4731A',
  'KK5199C': 'CMG08W4',
  'EKU32647': 'CMG94S3',
  'EKU32648': 'CMG1S17',
  'WB227CA': 'CMG64W7',
  'DLU3049C': 'CMG99W3',
  'CB752LH': 'CMG4725A',
  'BI121EC': 'CMG17W4',
'_ADOWARKA': '≈ÅADOWARKA',
'W√ìZEKWID≈ÅO': 'W√ìZEK',
'WOZEK': 'W√ìZEK',
'WIDLAK': 'W√ìZEK'
};
    
    // Sprawdzamy czy numer istnieje w mapowaniu
    return registrationMapping[regNumber] || regNumber;
}

// Group mapping
const groupMapping = {
    '01': 'Olej napƒôdowy', '02': 'Olej napƒôdowy', '03': 'Benzyna', '05': 'Benzyna',
    '06': 'LPG', '08': 'Bioester', '11': 'Oleje silnikowe', '12': 'P≈Çyny eksploatacyjne',
    '13': 'Oleje i smary przemys≈Çowe', '14': 'Produkty naftowe', '20': 'Us≈Çugi myjni',
    '21': 'Us≈Çugi inne', '24': 'Energia elektryczna', '29': 'Autokosmetyki',
    '30': 'Artyku≈Çy motoryzacyjne', '35': 'Op≈Çaty parkingowe', '36': 'Autostrady',
    '41': 'Autostrady', '49': 'Autostrady', '50': 'Artyku≈Çy konsumenckie',
    '51': 'Artyku≈Çy spo≈ºywcze', '52': 'Napoje', '53': 'Artyku≈Çy tytoniowe',
    '54': 'Alkohole', '80': 'Op≈Çata za karty', '81': 'AdBlue', '86': 'Us≈Çuga webserwisu',
    'Czƒô≈õci do norm czasowych': 'Materia≈Çy', 'Czƒô≈õci do obs≈Çugi technicznej': 'Materia≈Çy',
    'Czƒô≈õƒá': 'Materia≈Çy', 'Felga': 'Materia≈Çy', 'Opona letnia': 'Materia≈Çy',
    'Opona zimowa': 'Materia≈Çy', 'Normy czasowe': 'Us≈Çugi', 'Obs≈Çuga techniczna': 'Us≈Çugi',
    'Przechowanie opon': 'Us≈Çugi', 'Us≈Çuga oponiarska': 'Us≈Çugi', 'Us≈Çuga warsztatowa': 'Us≈Çugi',
    'Us≈Çuga inna': 'Us≈Çugi', 'Us≈Çuga kurierska': 'Us≈Çugi',
    'oplata serwisowa - najem dlugoterminowy VWFS': 'Najem d≈Çugoterminowy - op≈Çata serwisowa',
    'op≈Çata serwisowa - najem d≈Çugoterminowy VWFS': 'Najem d≈Çugoterminowy - op≈Çata serwisowa',
    'op≈Çata serwisowa - najem d≈Çugoterminowy': 'Najem d≈Çugoterminowy - op≈Çata serwisowa',
    'oplata serwisowa - najem dlugoterminowy': 'Najem d≈Çugoterminowy - op≈Çata serwisowa',
    'czynsz finansowy - najem dlugoterminowy VWFS': 'Najem d≈Çugoterminowy - czynsz',
    'czynsz finansowy - najem d≈Çugoterminowy VWFS': 'Najem d≈Çugoterminowy - czynsz',
    'czynsz finansowy - najem dlugoterminowy': 'Najem d≈Çugoterminowy - czynsz',
    'czynsz finansowy - najem d≈Çugoterminowy': 'Najem d≈Çugoterminowy - czynsz'
};

$(document).ready(() => {
    // Inicjalizacja prze≈ÇƒÖcznik√≥w mapowania
    initializeMappingToggles();
    
    const files = [];
    let fileImportTimes = new Map(); // Przechowuje czasy importu poszczeg√≥lnych plik√≥w
    let globalImportStartTime = null; // Czas rozpoczƒôcia ca≈Çego importu
    let globalImportEndTime = null; // Czas zako≈Ñczenia ca≈Çego importu
    let importedFileCount = 0;
    const $fileInput = $('#file-input');
    const $fileList = $('#file-list');
    const $totalImportTime = $("#total-import-time");
    const dropzone = $('#dropzone');

    // File drag and drop handling
    dropzone.on('click', () => $fileInput.click());
    $fileInput.on('change', (e) => handleFiles(e.target.files));

    ['dragover', 'dragleave', 'drop'].forEach(eventType => {
        dropzone.on(eventType, handleDragEvent);
    });

    function handleDragEvent(e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.toggleClass('dragging', e.type === 'dragover');
        if (e.type === 'drop') handleFiles(e.originalEvent.dataTransfer.files);
    }

    function handleFiles(selectedFiles) {
        const newFiles = Array.from(selectedFiles).filter(validateFile);
        if (newFiles.length === 0) return;

        renderFileList(newFiles);
        processFiles(newFiles);
    }

    function validateFile(file) {
        const fileType = file.name.split('.').pop().toLowerCase();
        if (!['xls', 'xlsx', 'csv'].includes(fileType)) {
            alert('Nieprawid≈Çowy format pliku. Proszƒô wczytaƒá plik typu xls, xlsx lub csv.');
            return false;
        }
        if (files.some(importedFile => importedFile.name === file.name)) {
            return false;
        }
        return true;
    }

    function renderFileList(newFiles) {
        const fragment = document.createDocumentFragment();
        newFiles.forEach((file) => {
            files.push(file);
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `${file.name} <span class="import-time" data-filename="${file.name}"></span> 
                            <button class='btn btn-danger btn-sm remove-file' data-index='${files.length}'>Usu≈Ñ</button>`;
            fragment.appendChild(li);
        });
        $fileList.append(fragment);
    }

    function processFiles(newFiles) {
    // Zapisz czas rozpoczƒôcia ca≈Çego procesu importu
    globalImportStartTime = performance.now();
    
    // Prosty status "Importowanie..."
    $totalImportTime.text(`‚è≥ Importowanie ${newFiles.length} ${newFiles.length === 1 ? 'pliku' : 'plik√≥w'}...`);

    Promise.all(newFiles.map((file, index) => readAndRenderDataAsync(file, files.length - newFiles.length + index)))
        .then(() => {
            // Zapisz czas zako≈Ñczenia ca≈Çego procesu importu
            globalImportEndTime = performance.now();
            console.log("Wszystkie pliki zosta≈Çy przetworzone.");
            updateImportSummary();
        })
        .catch(error => {
            globalImportEndTime = performance.now();
            alert(`WystƒÖpi≈Ç b≈ÇƒÖd podczas przetwarzania plik√≥w: ${error.message}`);
            updateImportSummary();
        });
}

    // Funkcja inicjalizujƒÖca obs≈Çugƒô prze≈ÇƒÖcznik√≥w mapowania
    function initializeMappingToggles() {
        $('#toggle-header-mapping').on('change', function() {
            enableHeaderMapping = this.checked;
            console.log('Header mapping:', enableHeaderMapping);
        });

        $('#toggle-group-mapping').on('change', function() {
            enableGroupMapping = this.checked;
            console.log('Group mapping:', enableGroupMapping);
        });

        $('#toggle-group-code-mapping').on('change', function() {
            enableGroupCodeMapping = this.checked;
            console.log('Group code mapping:', enableGroupCodeMapping);
        });

        $('#toggle-registration-normalization').on('change', function() {
            enableRegistrationNumberNormalization = this.checked;
            console.log('Registration number normalization:', enableRegistrationNumberNormalization);
        });
    }

    // Pozosta≈Çe funkcje bez zmian...
    async function detectFileEncoding(arrayBuffer) {
        const uint8Array = new Uint8Array(arrayBuffer);
        if (uint8Array.length >= 3 && 
            uint8Array[0] === 0xEF && 
            uint8Array[1] === 0xBB && 
            uint8Array[2] === 0xBF) {
            return 'UTF-8-BOM';
        }

        const textDecoder = new TextDecoder('utf-8', { fatal: false });
        const content = textDecoder.decode(uint8Array.slice(0, Math.min(1024, uint8Array.length)));
        
        if (/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈ºƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª]/.test(content)) {
            return 'UTF-8';
        }

        try {
            const windows1250Decoder = new TextDecoder('windows-1250', { fatal: true });
            windows1250Decoder.decode(uint8Array.slice(0, Math.min(1024, uint8Array.length)));
            return 'WINDOWS-1250';
        } catch (e) {
            return 'UTF-8';
        }
    }

    const readAsArrayBufferAsync = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsArrayBuffer(file);
    });

    async function readAndRenderDataAsync(file, index) {
        const fileStartTime = performance.now();
        try {
            const arrayBuffer = await readAsArrayBufferAsync(file);
            const encoding = await detectFileEncoding(arrayBuffer);
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                const decoder = new TextDecoder(encoding.replace('-BOM', ''));
                let csvContent = decoder.decode(arrayBuffer);
                
                if (encoding === 'UTF-8-BOM') {
                    csvContent = csvContent.replace(/^\uFEFF/, '');
                }

                const workbook = XLSX.read(csvContent, {
                    type: 'string',
                    raw: true,
                    cellDates: true,
                    dateNF: 'yyyy-mm-dd',
                    encoding: encoding
                });
                
                processWorkbook(workbook, file, fileStartTime);
            } else {
                const workbook = XLSX.read(arrayBuffer, {
                    type: 'array',
                    cellDates: true,
                    dateNF: 'yyyy-mm-dd'
                });
                
                processWorkbook(workbook, file, fileStartTime);
            }
        } catch (error) {
            console.error("B≈ÇƒÖd odczytu pliku:", error);
            // Zapisz czas nawet w przypadku b≈Çƒôdu
            const fileEndTime = performance.now();
            const fileImportTime = ((fileEndTime - fileStartTime) / 1000).toFixed(2);
            fileImportTimes.set(file.name, fileImportTime);
            throw error;
        }
    }

    function processWorkbook(workbook, file, fileStartTime) {
        const sheetName = workbook.SheetNames[0];
        let newData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {
            raw: false,
            dateNF: 'yyyy-mm-dd',
            header: 1,
            defval: ''
        });

        newData = newData
            .filter(row => row.some(value => value !== null && value !== undefined && value.toString().trim() !== ''))
            .map(row => row.map(value => {
                if (typeof value === 'string') {
                    return value
                        .replace(/\"\"/g, '"')
                        .normalize('NFKC')
                        .trim();
                }
                return value;
            }));

        // Mapowanie nag≈Ç√≥wk√≥w kolumn - kontrolowane prze≈ÇƒÖcznikiem
        if (enableHeaderMapping) {
            const headersToChange = {
                'NrFaktury': 'Nr karty',
                'MiejsceKosztu': 'Miejscowo≈õƒá',
                'Dzia≈Ç': 'Miejscowo≈õƒá',
                'DataKosztu': 'Data realizacji',
                'dataDokumentu': 'Data realizacji',
                'Data utworzenia': 'Data realizacji',
                'Tresc': 'Dane kosztowe',
                'Opis': 'Dane kosztowe',
                'ImportKodProduktu': 'Grupa prod',
                'OpisRodzajuKosztu': 'Grupa prod',
                'PozycjaOpis': 'Dane dodatkowe',
                'Ilosc': 'Ilo≈õƒá',
                'Ilo≈õƒá litr√≥w': 'Ilo≈õƒá',
                'ImportNrRejestracyjny': 'Nr rejestracyjny',
                'Rejestracja': 'Nr rejestracyjny',
                'Nazwa obiektu kosztowego': 'Nr rejestracyjny',
                'StanLicznika': 'Licznik',
                'Aktualny Przebieg': 'Licznik',
                'Warto≈õƒá netto fak': 'Warto≈õƒá netto',
                'NettoOpis': 'Warto≈õƒá netto',
                'Netto': 'Warto≈õƒá netto',
                'Nazwa': 'Nr rejestracyjny',
                'Oddzia≈Ç': 'Miejscowo≈õƒá',
                'Numer karty FLOTA': 'Nr karty',
                'Numer karty': 'Nr karty',
                'AktualnyPrzebieg': 'Licznik',
                'Rodzaj': 'Grupa prod',
                'Data pierwszej rejestracji': 'Data realizacji',
                'Kwota zakupu': 'Warto≈õƒá netto'
            };

            newData[0] = newData[0].map(header => {
                const normalizedHeader = typeof header === 'string' 
                    ? header.normalize('NFKC').trim() 
                    : header;
                return headersToChange[normalizedHeader] || normalizedHeader;
            });
        }

        columnIndices = Object.fromEntries(newData[0].map((header, index) => [header, index]));

        processNewData(newData, file);

        const fileEndTime = performance.now();
        const fileImportTime = ((fileEndTime - fileStartTime) / 1000).toFixed(2);
        
        // Zapisz czas importu tego pliku
        fileImportTimes.set(file.name, fileImportTime);
        importedFileCount++;

        // Aktualizuj wy≈õwietlanie czasu dla tego konkretnego pliku
        $(`.import-time[data-filename="${file.name}"]`).text(`(${fileImportTime}s)`);
        
        // Nie wywo≈Çuj updateImportSummary tutaj - zostanie wywo≈Çana po zako≈Ñczeniu wszystkich plik√≥w
    }

    function updateImportSummary() {
    if (globalImportStartTime && globalImportEndTime) {
        const totalRealTime = ((globalImportEndTime - globalImportStartTime) / 1000).toFixed(2);
        
        // Oblicz ≈õredni czas importu na plik
        const avgTimePerFile = fileImportTimes.size > 0 
            ? (Array.from(fileImportTimes.values())
                .reduce((sum, time) => sum + parseFloat(time), 0) / fileImportTimes.size).toFixed(2)
            : 0;
        
        // Oblicz sumƒô czas√≥w (dla por√≥wnania)
        const sumOfTimes = Array.from(fileImportTimes.values())
            .reduce((sum, time) => sum + parseFloat(time), 0).toFixed(2);
        
        // Zwiƒôz≈Ça informacja w HTML
        $totalImportTime.text(`‚úîÔ∏è Import ${importedFileCount} ${importedFileCount === 1 ? 'pliku' : 'plik√≥w'}: ${totalRealTime}s`);
        
        // Szczeg√≥≈Çowe informacje tylko w konsoli
        console.log('=== SZCZEG√ì≈ÅY IMPORTU ===');
        console.log(`üìÅ Liczba plik√≥w: ${importedFileCount}`);
        console.log(`‚è±Ô∏è Czas ca≈Çkowity: ${totalRealTime}s`);
        console.log(`üìä ≈öredni czas/plik: ${avgTimePerFile}s`);
        console.log(`Œ£ Suma czas√≥w indywidualnych: ${sumOfTimes}s`);
        
        if (fileImportTimes.size > 1) {
            const timeSaved = (sumOfTimes - totalRealTime).toFixed(2);
            console.log(`üîÑ Oszczƒôdno≈õƒá czasu (import r√≥wnoleg≈Çy): ${timeSaved}s`);
            console.log(`üìà Przyspieszenie: ${(sumOfTimes / totalRealTime).toFixed(2)}x`);
        }
        
        console.log('üìã Czasy importu poszczeg√≥lnych plik√≥w:');
        fileImportTimes.forEach((time, filename) => {
            console.log(`   ‚Ä¢ ${filename}: ${time}s`);
        });
        
        console.log('========================');
    }
}

    function processNewData(newData, index) {
        const surnameColumnIndex = columnIndices['Nazwisko'];
        const registrationNumberColumnIndex = columnIndices['Nr rejestracyjny'];
        const cardNumberIndex = columnIndices['Nr karty'];
        const groupProdIndex = columnIndices['Grupa prod'];

        if (jsonData.length === 0) {
            jsonData = newData;
        } else {
            jsonData = jsonData.concat(newData.slice(1));
        }

        newData.slice(1).forEach(row => {
            // Normalizacja numer√≥w rejestracyjnych - kontrolowana prze≈ÇƒÖcznikiem
            if (enableRegistrationNumberNormalization && registrationNumberColumnIndex !== undefined) {
                if (!row[registrationNumberColumnIndex] && surnameColumnIndex !== undefined) {
                    row[registrationNumberColumnIndex] = row[surnameColumnIndex] || '';
                }

                if (row[registrationNumberColumnIndex]) {
                    // Najpierw normalizujemy (usuwamy spacje i zamieniamy na wielkie litery)
                    let normalizedRegNumber = row[registrationNumberColumnIndex].toString().replace(/\s/g, '').toUpperCase();
                    
                    // Nastƒôpnie stosujemy mapowanie (CMG62H4 -> CMG6262)
                    normalizedRegNumber = mapRegistrationNumber(normalizedRegNumber);
                    
                    row[registrationNumberColumnIndex] = normalizedRegNumber;
                    uniqueRegistrationNumbers.add(normalizedRegNumber);
                }
            } else if (registrationNumberColumnIndex !== undefined && row[registrationNumberColumnIndex]) {
                // Je≈õli normalizacja wy≈ÇƒÖczona, ale mapowanie mo≈ºe byƒá nadal aktywne
                let regNumber = row[registrationNumberColumnIndex];
                // Stosujemy tylko mapowanie bez normalizacji
                regNumber = mapRegistrationNumber(regNumber);
                row[registrationNumberColumnIndex] = regNumber;
                uniqueRegistrationNumbers.add(regNumber);
            }

            if (cardNumberIndex !== undefined && groupProdIndex !== undefined) {
                const cardNumber = row[cardNumberIndex];
                const cardDescription = row[registrationNumberColumnIndex];
                if (cardNumber) {
                    cardNumbersWithDescriptions[cardNumber.toString().toUpperCase()] = cardDescription;
                }
            }

            // Mapowanie grup produkt√≥w - kontrolowane prze≈ÇƒÖcznikami
            if (groupProdIndex !== undefined) {
                const originalGroup = row[groupProdIndex];
                let newGroup = originalGroup;
                
                // Mapowanie kod√≥w grup - kontrolowane prze≈ÇƒÖcznikiem
                if (enableGroupCodeMapping) {
                    const groupMappings = {
                        '401-115-01-1': 'Paliwo',
                        '402-211-03-1': 'Us≈Çugi monitoring GPS',
                        '401-116-01-1': 'Materia≈Çy czƒô≈õci',
                        '401-116-02-1': 'Materia≈Çy opony',
                        '401-199-1': 'Materia≈Çy pozosta≈Çe',
                        '401-116-03-1': 'Materia≈Çy czƒô≈õci',
                        '402-211-04-1': 'Us≈Çugi przeglƒÖdy',
                        '402-211-05-1': 'Us≈Çugi myjnia',
                        '403-302-05-1': 'Autostrady',
                        '762-03-03-2': 'Szkody',
                        '762-03-03-1': 'Szkody',
                        '403-302-99-1': 'Podatki i op≈Çaty',
                        '402-211-02-1': 'Us≈Çugi opon',
                        '402-211-02-2': 'Us≈Çugi opon',
                        '402-211-01-1': 'Us≈Çugi',
                        '402-299-1': 'Us≈Çugi',
                        '248-02-0': 'Najem d≈Çugoterminowy - czynsz',
                        '406-605-': 'Ubezpieczenia',
                        '080-01-01': 'Zakupy Inwestycyjne nowe',
                        '080-01-02': 'Zakupy Inwestycyjne u≈ºywane',
                        '406-601-99': 'Reklama',
                        '247-01-0100568': 'Kaucje',
                        '403-301-02': 'Podatki i op≈Çaty',
                        '402-211-02-2': 'Podatki i op≈Çaty',
                        '402-201-99-1': 'Najem inne'
                    };

                    for (const [key, value] of Object.entries(groupMappings)) {
                        if (originalGroup.includes(key)) {
                            newGroup = value;
                            break;
                        }
                    }
                }

                // Podstawowe mapowanie grup - kontrolowane prze≈ÇƒÖcznikiem
                if (enableGroupMapping) {
                    newGroup = groupMapping[originalGroup] || newGroup;
                }

                row[groupProdIndex] = newGroup;
                uniqueGroups.add(newGroup);
            }
        });

        renderMainTable();
        updateUILists();
    }

    const renderMainTable = () => {
        const data = jsonData.slice(1);
        if (!mainTable) {
            createMainTable(jsonData);
        } else {
            mainTable.clear().rows.add(data).draw();
        }
    };

    const createMainTable = jsonData => {
        // Initialize column indices
        jsonData[0].forEach((col, index) => {
            columnIndices[col] = index;
        });

        // Add UI controls before table initialization
        addRowGroupingToggle();
        addRowGroupSelect(jsonData[0]);

        const hiddenColumns = [
            'MPK', 'Nazwa produktu', 'Rodzaj pojazdu', 'EAN', 
            'Data ksiƒôgowania', 'Pozycja faktury', 'Warto≈õƒá fak', 
            'Cena za litr', 'Stawka vat', 'Warto≈õƒá vat fak', 
            'Warto≈õƒá netto - stacja', 'Warto≈õƒá VAT - stacja', 
            'Warto≈õƒá brutto - stacja', 'CenaSprzedazySrednia', 
            'IdFloty', 'Cena_za≈ÇƒÖcznik'
        ];
        
    mainTable = $('#example').DataTable({
        data: jsonData.slice(1),
        columns: jsonData[0].map((col, index) => ({
            title: col,
            visible: !hiddenColumns.includes(col),
            render: (data, type) => renderTableCell(data, type, col),
            className: isColumnEditable(col) ? 'editable' : '',
        })),
        stateSave: true,
        processing: true,
        deferRender: true,
        scrollX: true,
        scroller: { 
            loadingIndicator: true, 
            displayBuffer: 10 
        },
        dom: '<"ex-buttons"Bf>lrtip',
        buttons: getTableButtons(),
        colReorder: true,
        responsive: true,
        ordering: true,
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        searching: true,
        scrollY: 450,
        drawCallback: updateTableFooter,
        footerCallback: updateTableFooter,
        initComplete: function(settings, json) {
            updateColumnSelect();
            initializeEditing();
        },
        rowGroup: {
            dataSrc: function(row) {
                const columnIndex = parseInt($('#rowGroupSelect').val());
                return row[columnIndex];
            },
            enable: useRowGrouping
        },
        order: []
    });

    initializeRowGrouping();
};

const getTableButtons = () => {
    return [
        {
            extend: 'collection',
            text: 'Export',
            className: 'ex-buttons',
            buttons: [
                { 
                    extend: 'csv', 
                    charset: 'UTF-8', 
                    bom: true, 
                    filename: function() {
                        const today = new Date();
                        const dateStr = today.getFullYear() + '-' + 
                                      String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(today.getDate()).padStart(2, '0');
                        return 'MainTable_' + dateStr;
                    },
                    exportOptions: { columns: ':visible' } 
                },
                { 
                    extend: 'excel', 
                    title: null,
                    filename: function() {
                        const today = new Date();
                        const dateStr = today.getFullYear() + '-' + 
                                      String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(today.getDate()).padStart(2, '0');
                        return 'MainTable_' + dateStr;
                    },
                    exportOptions: { columns: ':visible' },
                    customize: function(xlsx) {
                        // Eksport Excel domy≈õlnie zachowa nag≈Ç√≥wki kolumn
                        // Opcjonalnie mo≈ºemy dostosowaƒá style
                        var sheet = xlsx.xl.worksheets['sheet1.xml'];
                        
                        // Pogrubienie nag≈Ç√≥wk√≥w (pierwszy wiersz)
                        $('row:first c', sheet).each(function() {
                            $(this).attr('s', '2'); // styl pogrubiony
                        });
                    }
                },
                {
                    extend: 'pdfHtml5',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    title: null,
                    filename: function() {
                        const today = new Date();
                        const dateStr = today.getFullYear() + '-' + 
                                      String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(today.getDate()).padStart(2, '0');
                        return 'MainTable_' + dateStr;
                    },
                    exportOptions: { columns: ':visible' },
                    customize: function(doc) {
                        // Usuniƒôcie obiektu tytu≈Çu z dokumentu PDF
                        if (doc.content[0].text) {
                            doc.content.splice(0, 1);
                        }
                        
                        // Pobranie liczby kolumn
                        var columnCount = doc.content[0].table.body[0].length;
                        
                        // Bardziej agresywne dostosowanie wielko≈õci czcionki
                        var fontSize = 10;
                        if (columnCount > 20) {
                            fontSize = 5;
                        } else if (columnCount > 18) {
                            fontSize = 5.5;
                        } else if (columnCount > 16) {
                            fontSize = 6;
                        } else if (columnCount > 14) {
                            fontSize = 6.5;
                        } else if (columnCount > 12) {
                            fontSize = 7;
                        } else if (columnCount > 10) {
                            fontSize = 8;
                        } else if (columnCount > 8) {
                            fontSize = 9;
                        }
                        
                        // Ustawienie stylu dla ca≈Çej tabeli
                        doc.styles.tableHeader = {
                            bold: true,
                            fontSize: fontSize,
                            color: 'white',           // Bia≈Ça czcionka
                            fillColor: '#050952',     // Ciemnoniebieski kolor t≈Ça
                            alignment: 'center'
                        };
                        
                        doc.styles.tableBodyEven = {
                            fontSize: fontSize
                        };
                        
                        doc.styles.tableBodyOdd = {
                            fontSize: fontSize,
                            fillColor: '#f5f5f5'
                        };
                        
                        // Zwiƒôkszony lewy margines (20pt), pozosta≈Çe bez zmian
                        doc.pageMargins = [20, 10, 10, 10];
                        
                        // Opcja 1: Pozw√≥l pdfmake automatycznie dopasowaƒá kolumny
                        if (columnCount > 12) {
                            // Dla du≈ºej liczby kolumn u≈ºyj automatycznego dopasowania
                            doc.content[0].table.widths = Array(columnCount).fill('auto');
                        } else {
                            // Dla mniejszej liczby kolumn u≈ºyj r√≥wnomiernego podzia≈Çu
                            doc.content[0].table.widths = Array(columnCount).fill('*');
                        }
                        
                        // Zawijanie tekstu w kom√≥rkach z mniejszymi marginesami
                        doc.content[0].table.body.forEach(function(row, rowIndex) {
                            row.forEach(function(cell) {
                                cell.noWrap = false;
                                // Mniejsze marginesy dla oszczƒôdno≈õci miejsca
                                cell.margin = [1, 2, 1, 2];
                                
                                // Skr√≥cenie d≈Çugich tekst√≥w
                                if (cell.text && cell.text.length > 30) {
                                    cell.text = cell.text.substring(0, 27) + '...';
                                }
                                
                                // Wyr√≥wnanie
                                if (rowIndex === 0) {
                                    cell.alignment = 'center';
                                    // Dodatkowe wymuszenie koloru dla nag≈Ç√≥wk√≥w
                                    cell.fillColor = '#050952';
                                    cell.color = 'white';
                                } else if (cell.text && !isNaN(cell.text)) {
                                    cell.alignment = 'right';
                                } else {
                                    cell.alignment = 'left';
                                }
                            });
                        });
                        
                        // Uproszczony layout tabeli
                        doc.content[0].layout = {
                            hLineWidth: function(i, node) {
                                return (i === 0 || i === 1 || i === node.table.body.length) ? 0.5 : 0.25;
                            },
                            vLineWidth: function(i, node) {
                                return 0.25;
                            },
                            hLineColor: function(i, node) {
                                return '#999999';
                            },
                            vLineColor: function(i, node) {
                                return '#cccccc';
                            },
                            paddingLeft: function(i, node) {
                                return 2;
                            },
                            paddingRight: function(i, node) {
                                return 2;
                            },
                            paddingTop: function(i, node) {
                                return 1;
                            },
                            paddingBottom: function(i, node) {
                                return 1;
                            }
                        };
                        
                        // Dodatkowa opcja: tryb "fit to page" dla bardzo szerokich tabel
                        if (columnCount > 15) {
                            doc.pageOrientation = 'landscape';
                            doc.content[0].fontSize = fontSize - 1; // Dodatkowe zmniejszenie
                            
                            // Opcja kompresji kolumn
                            doc.content[0].table.dontBreakRows = true;
                            doc.content[0].table.keepWithHeaderRows = 1;
                        }
                        
                        // Usuniƒôta sekcja footer - brak informacji o dacie generowania
                    }
                }
            ]
        },
        {
            text: 'Zapisz zmiany',
            action: function () {
                saveChanges();
            }
        }
    ];
};

const isColumnEditable = (columnName) => {
    const editableColumns = [
        'Nr rejestracyjny',
        'Ilo≈õƒá',
        'Imiƒô',
        'Dane kosztowe',
        'Dane dodatkowe',
        'Nazwisko',
        'Licznik',
        'Warto≈õƒá netto',
        'Grupa prod'
    ];
    return editableColumns.includes(columnName);
};

const initializeEditing = () => {
    $('#example').on('click', 'td.editable', function(e) {
        const cell = mainTable.cell(this);
        const columnName = mainTable.column(this).header().textContent;
        const originalValue = cell.data();
        
        if ($(this).find('input, select').length === 0) {
            const input = createEditInput(columnName, originalValue);
            $(this).html(input);
            input.focus();

            input.on('blur keyup', function(e) {
                if (e.type === 'blur' || (e.type === 'keyup' && e.key === 'Enter')) {
                    const newValue = validateAndFormatValue($(this).val(), columnName, originalValue);
                    cell.data(newValue).draw();
                    markCellAsEdited(cell.node());
                }
                if (e.type === 'keyup' && e.key === 'Escape') {
                    cell.data(originalValue).draw();
                }
            });
        }
    });
};

const createEditInput = (columnName, value) => {
    let input;
    
    switch(columnName) {
        case 'Grupa prod':
            input = $('<select>')
                .append([
                    'Olej napƒôdowy', 
                    'Benzyna', 
                    'Autostrady', 
                    'AdBlue', 
                    'Oleje silnikowe', 
                    'LPG', 
                    'Energia elektryczna'
                ].map(option => 
                    $('<option>').val(option).text(option)
                ));
            input.val(value);
            break;
            
        case 'Ilo≈õƒá':
        case 'Warto≈õƒá netto':
            input = $('<input>')
                .attr('type', 'number')
                .attr('step', '0.01')
                .val(value);
            break;
            
        default:
            input = $('<input>')
                .attr('type', 'text')
                .val(value);
    }
    
    return input.addClass('form-control');
};

const validateAndFormatValue = (value, columnName, originalValue) => {
    switch(columnName) {
        case 'Ilo≈õƒá':
        case 'Warto≈õƒá netto':
            const numValue = parseFloat(value);
            return isNaN(numValue) ? originalValue : numValue.toFixed(2);
            
        case 'Nr rejestracyjny':
            return value.toUpperCase();
            
        default:
            return value;
    }
};

const markCellAsEdited = (cell) => {
    $(cell).addClass('edited');
};

const saveChanges = () => {
    const editedData = [];
    mainTable.$('td.edited').each(function() {
        const row = mainTable.row(this).data();
        const columnName = mainTable.column(this).header().textContent;
        const newValue = mainTable.cell(this).data();
        
        editedData.push({
            rowData: row,
            column: columnName,
            newValue: newValue
        });
    });
    
    console.log('Zapisane zmiany:', editedData);
    mainTable.$('td.edited').removeClass('edited');
};

const addStyles = () => {
    const style = document.createElement('style');
    style.textContent = `
        .editable {
            cursor: pointer;
            position: relative;
        }
        .editable:hover::after {
            content: "‚úé";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }
        .edited {
            background-color: #fff3cd !important;
        }
        .form-control {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
        }
        #rowGroupingToggleContainer {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #rowGroupSelect {
            margin-bottom: 10px;
        }
    `;
    document.head.appendChild(style);
};

const addRowGroupingToggle = () => {
    const toggleHtml = `
        <div id="rowGroupingToggleContainer">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="rowGroupingToggle" ${useRowGrouping ? 'checked' : ''} style="margin-right: 10px;">
                <span>W≈ÇƒÖcz grupowanie wierszy</span>
            </label>
        </div>
    `;
    
    $('#example').before(toggleHtml);

    $('#rowGroupingToggle').on('change', function() {
        useRowGrouping = this.checked;
        if (mainTable) {
            mainTable.rowGroup().enable(useRowGrouping).draw();
        }
    });
};

const addRowGroupSelect = (columns) => {
    const selectHtml = `
        <div>
            <label for="rowGroupSelect">Grupuj dane wg:</label>
            <select id="rowGroupSelect"></select>
        </div>
    `;
    
    $('#example').before(selectHtml);

    const $rowGroupSelect = $('#rowGroupSelect');
    columns.forEach((col, index) => {
        $rowGroupSelect.append($('<option></option>').val(index).text(col));
    });

    const defaultGroupColumn = columns.indexOf('Nr rejestracyjny');
    if (defaultGroupColumn !== -1) {
        $rowGroupSelect.val(defaultGroupColumn);
    }
};

const initializeRowGrouping = () => {
    $('#rowGroupSelect').on('change', function() {
        const selectedColumn = parseInt($(this).val());
        mainTable.order([selectedColumn, 'asc'])
            .rowGroup()
            .dataSrc(function(row) {
                return row[selectedColumn];
            })
            .draw();
    });

    $('#rowGroupSelect').trigger('change');
};

const renderTableCell = (data, type, col) => {
    if (data == null) return '';
    if (type === 'export' || type === 'sort' || type === 'filter') return data;

    switch (col) {
        case 'Data realizacji':
            const date = new Date(data);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        case 'Nr karty':
            return data.toString().replace(/\B(?=(\d{4})+(?!\d))/g, ' ');
        case 'Warto≈õƒá netto':
            return parseFloat(data).toFixed(2);
        case 'Grupa prod':
            const colors = {
                'Olej napƒôdowy': { bg: '#FFE5B2', color: '#4D3000' },
                'Benzyna': { bg: '#FF9E9E', color: '#8B0000' },
                'Autostrady': { bg: '#90EE90', color: '#006400' },
                'AdBlue': { bg: '#ADD8E6', color: '#00008B' },
                'Oleje silnikowe': { bg: '#D3D3D3', color: '#2F4F4F' },
                'LPG': { bg: '#98FB98', color: '#006400' },
                'Us≈Çugi': { bg: '#ADD8E6', color: '#00008B' },
                'Materia≈Çy': { bg: '#FFE4B5', color: '#8B4513' },
                'Energia elektryczna': { bg: '#87CEEB', color: '#00008B' }
            };
            const style = colors[data] || { bg: '#e0e0e0', color: '#757575' };
            return `<span style="background-color: ${style.bg}; color: ${style.color}; display: inline-block; width: 100%; padding: 2px 5px; border-radius: 3px;">${data}</span>`;
        default:
            return data;
    }
};

const updateTableFooter = function() {
    const api = this.api();
    if (columnIndices['Warto≈õƒá netto'] !== undefined) {
        const colIndex = columnIndices['Warto≈õƒá netto'];
        const sum = api.column(colIndex, { page: 'current' })
            .data()
            .reduce((a, b) => a + parseFloat(b), 0);
        $(api.column(colIndex).footer()).html('Suma: ' + sum.toFixed(2));
    }
    $('.dataTables_scrollBody thead tr').css({ visibility: 'collapse' });
};

const updateColumnSelect = () => {
    const $select = $('#columnVisibility');
    if (!$select.length || !mainTable) return;

    $select.empty();
    
    jsonData[0].forEach((col, index) => {
        const $option = $('<option></option>')
            .val(index)
            .text(col)
            .prop('selected', mainTable.column(index).visible());
        $select.append($option);
    });

    $select.off('change').on('change', function() {
        const columnsToHide = [];
        const columnsToShow = [];

        $('option', this).each(function() {
            const columnIndex = $(this).val();
            ($(this).is(':selected') ? columnsToShow : columnsToHide).push(columnIndex);
        });

        mainTable.columns(columnsToHide).visible(false, false);
        mainTable.columns(columnsToShow).visible(true, false);
        mainTable.columns.adjust().draw(false);
    });
};

// Initialize styles on load
addStyles();

function updateUILists() {
    updateSelectOptions('#groupSelect', Array.from(uniqueGroups));
    updateSelectOptions('#registrationNumberSelect', Array.from(uniqueRegistrationNumbers));
    updateSelectOptions('#cardNumberSelect', Object.keys(cardNumbersWithDescriptions));
}

function updateSelectOptions(selectId, options) {
    const $select = $(selectId);
    $select.empty().append('<option value="">Wszystkie</option>');
    options.forEach(option => {
        $select.append($('<option></option>').val(option).text(option));
    });
}

    $("#generate-summary").on('click', () => {
        generateSummaryTable();
        generateSummary2Table();
        renderCharts();
    });

    function generateSummaryTable() {
        const mainTableData = mainTable.rows().data().toArray();
        const summaryData = mainTableData.reduce((summary, row) => {
            const group = row[columnIndices['Grupa prod']];
            const quantity = parseFloat(row[columnIndices['Ilo≈õƒá']]) || 0;
            const netValue = parseFloat(row[columnIndices['Warto≈õƒá netto']]);
            if (!isNaN(quantity) && !isNaN(netValue)) {
                if (!summary[group]) summary[group] = { 'Ilo≈õƒá': 0, 'Warto≈õƒá netto': 0 };
                summary[group]['Ilo≈õƒá'] += quantity;
                summary[group]['Warto≈õƒá netto'] += netValue;
            }
            return summary;
        }, {});

        const summaryTable = $('<table class="table table-striped summary-table"></table>');
        summaryTable.append('<thead><tr><th>Produkt</th><th>Ilo≈õƒá</th><th>Warto≈õƒá netto</th></tr></thead>');
        let tableBody = '<tbody>';
        Object.entries(summaryData)
            .sort((a, b) => b[1]['Warto≈õƒá netto'] - a[1]['Warto≈õƒá netto'])
            .forEach(([group, value]) => {
                tableBody += `<tr><td>${group}</td><td>${value['Ilo≈õƒá'].toFixed(2)}</td><td>${value['Warto≈õƒá netto'].toFixed(2)}</td></tr>`;
            });
        summaryTable.append(tableBody + '</tbody>');
        $("#summary-table-container").html(summaryTable);

        initializeDataTable("#summary-table-container table", {
            ordering: false,
            order: [[2, 'desc']]
        });
    }

    // Zaktualizowana funkcja generateSummary2Table z obs≈ÇugƒÖ opcji "Ilo≈õƒá transakcji"
    function generateSummary2Table() {
        const mainTableData = mainTable.rows().data().toArray();
        const summary2Data = {};
        
        mainTableData.forEach(row => {
            const rowRegistrationNumber = row[columnIndices['Nr rejestracyjny']];
            const rowCardNumber = row[columnIndices['Nr karty']];
            if ((selectedRegistrationNumber === '' || rowRegistrationNumber === selectedRegistrationNumber) &&
                (selectedCardNumber === '' || rowCardNumber === selectedCardNumber)) {
                const date = row[columnIndices['Data realizacji']];
                const value = parseFloat(row[columnIndices[valueColumn]]);
                const group = row[columnIndices['Grupa prod']];
                
                if (date && (selectedGroup === '' || group === selectedGroup || selectedGroup === 'Wszystkie grupy')) {
                    const year = new Date(date).getFullYear();
                    const month = new Date(date).getMonth() + 1;
                    
                    if (!summary2Data[month]) summary2Data[month] = {};
                    if (!summary2Data[month][year]) {
                        summary2Data[month][year] = { 
                            'value': 0, 
                            'activeCardsCount': new Set(),
                            'transactionCount': 0  // Dodane pole dla liczenia transakcji
                        };
                    }
                    
                    // Logika zliczania w zale≈ºno≈õci od wybranej opcji
                    if (valueColumn === transactionCountColumn) {
                        // Zliczanie transakcji - ka≈ºdy wiersz to jedna transakcja
                        summary2Data[month][year]['transactionCount'] += 1;
                    } else if (valueColumn === activeCardsColumn) {
                        // Zliczanie unikalnych kart
                        summary2Data[month][year]['activeCardsCount'].add(row[columnIndices[activeCardsColumn]]);
                    } else if (!isNaN(value)) {
                        // Sumowanie warto≈õci liczbowych
                        summary2Data[month][year]['value'] += value;
                    }
                }
            }
        });

        const uniqueYears = Array.from(new Set(mainTableData.map(row => new Date(row[columnIndices['Data realizacji']]).getFullYear()))).sort((a, b) => a - b);
        
        // Funkcja do obliczania warto≈õci dla kolorowania
        const coloringData = uniqueYears.reduce((acc, year) => {
            const yearValues = Array(12).fill(0).map((_, month) => {
                const monthData = summary2Data[month + 1]?.[year];
                if (!monthData) return 0;
                
                if (valueColumn === transactionCountColumn) {
                    return monthData['transactionCount'];
                } else if (valueColumn === activeCardsColumn) {
                    return monthData['activeCardsCount'].size;
                } else {
                    return monthData['value'];
                }
            });
            acc[year] = findExtremesIndices(yearValues);
            return acc;
        }, {});

        const summary2Table = $('<table class="table table-striped summary2-table"></table>');
        summary2Table.append(`<thead><tr><th>MiesiƒÖc</th>${uniqueYears.map(year => `<th>${year}</th>`).join('')}</tr></thead>`);

        let tableBody = '<tbody>';
        for (let month = 1; month <= 12; month++) {
            tableBody += `<tr><td>${getMonthName(month)}</td>`;
            uniqueYears.forEach(year => {
                const monthData = summary2Data[month]?.[year];
                let value = '0';
                
                if (monthData) {
                    if (valueColumn === transactionCountColumn) {
                        value = monthData['transactionCount'].toFixed(0);
                    } else if (valueColumn === activeCardsColumn) {
                        value = monthData['activeCardsCount'].size.toFixed(0);
                    } else {
                        value = monthData['value'].toFixed(2);
                    }
                }
                
                let cellStyle = '';
                if (coloringData[year].highest.has(month - 1)) {
                    cellStyle = ' style="color: red;"';
                } else if (coloringData[year].lowest.has(month - 1)) {
                    cellStyle = ' style="color: green;"';
                }
                tableBody += `<td${cellStyle}>${value}</td>`;
            });
            tableBody += '</tr>';
        }
        summary2Table.append(tableBody + '</tbody>');
        $("#summary2-table-container").html(summary2Table);

        initializeDataTable("#summary2-table-container table", { ordering: false });
    }

    function initializeDataTable(selector, additionalOptions = {}) {
        const dataTable = $(selector);
        if ($.fn.dataTable.isDataTable(dataTable)) {
            dataTable.DataTable().destroy();
        }
        dataTable.DataTable({
            dom: '<"ex-buttons"Bf>lrtip',
            buttons: [
                {
                    extend: 'collection',
                    text: 'Export',
                    className: 'ex-buttons',
                    buttons: [
                        { extend: 'csv', charset: 'UTF-8', bom: true },
                        { extend: 'excel', title: null },
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            title: 'List PDF',
                            customize: function(doc) {
                                doc.styles.title = { color: 'blue', fontSize: '25', bold: true };
                                doc.content[1].table.widths = Array(doc.content[1].table.body[0].length + 1).join('*').split('');
                            }
                        }
                    ]
                }
            ],
            paging: false,
            searching: false,
            info: false,
            ...additionalOptions
        });
    }

    const getMonthName = monthNumber => ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec", "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"][monthNumber - 1];

    function findExtremesIndices(values) {
        const sortedIndices = values.map((v, i) => [v, i]).sort((a, b) => a[0] - b[0]);
        const lowestIndices = sortedIndices.slice(0, 4).map(v => v[1]);
        const highestIndices = sortedIndices.slice(-4).map(v => v[1]);
        return { lowest: new Set(lowestIndices), highest: new Set(highestIndices) };
    }

    function updateUILists() {
        const updateList = (searchId, selectId, dataSource, optionFormatter) => {
            const searchTerm = $(`#${searchId}`).val().toUpperCase();
            const options = ['<option value="">Wszystkie</option>'];
            Array.from(dataSource)
                .filter(item => {
                    if (typeof item === 'string') {
                        return item.toUpperCase().includes(searchTerm);
                    } else if (typeof item === 'object') {
                        return item.number.toUpperCase().includes(searchTerm) ||
                            item.description.toUpperCase().includes(searchTerm);
                    }
                    return false;
                })
                .sort((a, b) => {
                    if (typeof a === 'string') return a.localeCompare(b);
                    return a.number.localeCompare(b.number);
                })
                .forEach(item => {
                    options.push(optionFormatter(item));
                });
            $(`#${selectId}`).html(options.join(''));
        };

        updateList('search-registration-number', 'select-registration-number', uniqueRegistrationNumbers,
            number => `<option value="${number}">${number}</option>`);
        updateList('search-group', 'select-group', uniqueGroups,
            group => `<option value="${group}">${group}</option>`);
        updateList('search-card-number', 'select-card-number',
            Object.entries(cardNumbersWithDescriptions).map(([number, description]) => ({ number, description })),
            item => `<option value="${item.number}">${item.number} - ${item.description}</option>`);
    }

    ['registration-number', 'group', 'card-number'].forEach(item => {
        $(`#search-${item}`).on('input', () => updateUILists());
    });

    // Zaktualizowany event handler z obs≈ÇugƒÖ opcji "Ilo≈õƒá transakcji"
    $("#select-column, #select-group, #select-registration-number, #select-card-number").on("change", function() {
        selectedColumn = $("#select-column").val();
        
        // Ustawienie odpowiedniej kolumny warto≈õci
        if (selectedColumn === 'activeCardsColumn') {
            valueColumn = activeCardsColumn;
        } else if (selectedColumn === 'transactionCount') {
            valueColumn = transactionCountColumn;
        } else {
            valueColumn = selectedColumn;
        }
        
        selectedGroup = $("#select-group").val();
        selectedRegistrationNumber = $("#select-registration-number").val();
        selectedCardNumber = $("#select-card-number").val();
        generateSummary2Table();
        renderCharts();
    });

    // Zaktualizowana funkcja renderCharts z obs≈ÇugƒÖ opcji "Ilo≈õƒá transakcji"
    function renderCharts() {
        if (!mainTable || !$.fn.DataTable.isDataTable(mainTable)) {
            console.error("Tabela mainTable nie jest zainicjowana lub nie zawiera danych.");
            return;
        }
                
        const mainTableData = mainTable.rows().data().toArray();
        const filteredData = mainTableData.filter(row =>
            (selectedRegistrationNumber === '' || row[columnIndices['Nr rejestracyjny']] === selectedRegistrationNumber) &&
            (selectedGroup === '' || row[columnIndices['Grupa prod']] === selectedGroup || selectedGroup === 'Wszystkie grupy') &&
            (selectedCardNumber === '' || row[columnIndices['Nr karty']] === selectedCardNumber)
        );

        if (filteredData.length === 0) {
            console.error("Brak danych do wygenerowania wykresu.");
            return;
        }

        const seriesData = new Map();
        const allMonths = new Set();

        filteredData.forEach(row => {
            const date = new Date(row[columnIndices['Data realizacji']]);
            const value = parseFloat(row[columnIndices[valueColumn]]);
            const group = row[columnIndices['Grupa prod']];
            const cardNumber = row[columnIndices['Nr karty']];

            if (date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const category = `${year}-${('0' + (month + 1)).slice(-2)}`;
                allMonths.add(category);

                if (!seriesData.has(group)) seriesData.set(group, new Map());
                if (!seriesData.get(group).has(category)) {
                    seriesData.get(group).set(category, { 
                        value: 0, 
                        activeCardsCount: new Set(),
                        transactionCount: 0  // Dodane pole dla liczenia transakcji
                    });
                }

                // Logika zliczania w zale≈ºno≈õci od wybranej opcji
                if (valueColumn === transactionCountColumn) {
                    seriesData.get(group).get(category).transactionCount += 1;
                } else if (valueColumn === activeCardsColumn) {
                    seriesData.get(group).get(category).activeCardsCount.add(cardNumber);
                } else if (!isNaN(value)) {
                    seriesData.get(group).get(category).value += value;
                }
            }
        });

        const chartData = Array.from(seriesData).map(([group, groupData]) => ({
            name: group,
            data: Array.from(allMonths).sort().map(category => {
                let value = 0;
                if (groupData.has(category)) {
                    const categoryData = groupData.get(category);
                    if (valueColumn === transactionCountColumn) {
                        value = categoryData.transactionCount;
                    } else if (valueColumn === activeCardsColumn) {
                        value = categoryData.activeCardsCount.size;
                    } else {
                        value = categoryData.value;
                    }
                }
                return [Date.parse(category), parseFloat(value.toFixed(2))];
            })
        }));

        // Ustawienie odpowiedniego tytu≈Çu wykresu
        let columnDisplayName = valueColumn;
        if (valueColumn === transactionCountColumn) {
            columnDisplayName = 'Ilo≈õƒá transakcji';
        } else if (valueColumn === activeCardsColumn) {
            columnDisplayName = 'Liczba aktywnych kart';
        }

        const chartTitle = `${columnDisplayName} - ${selectedGroup || 'Wszystkie grupy'} - ${selectedCardNumber ? (cardNumbersWithDescriptions[selectedCardNumber.toUpperCase()] || selectedCardNumber) : (selectedRegistrationNumber || 'Wszystkie auta')}`;

        const chartOptions = {
            chart: {
                backgroundColor: Highcharts.theme?.chart?.backgroundColor ?? 'transparent',
                animation: { duration: 1000 },
                height: null,
                zoomType: 'xy'
            },
            title: { text: chartTitle, style: Highcharts.theme?.title?.style },
            credits: { enabled: false },
            xAxis: {
                type: 'datetime',
                labels: {
                    formatter: function() { return Highcharts.dateFormat('%Y-%m', this.value); },
                    style: { color: '#ffffff', fontSize: '10px' }
                },
                dateTimeLabelFormats: { month: '%b' }
            },
            yAxis: {
                title: { text: columnDisplayName, style: { color: '#a3ff12' } },
                labels: { style: { fontSize: '12px', color: '#ffffff' } }
            },
            tooltip: { shared: true, crosshairs: true },
            series: chartData,
            rangeSelector: {
                enabled: true,
                buttons: [
                    { type: 'year', count: 1, text: '1 rok' },
                    { type: 'year', count: 2, text: '2 lata' },
                    { type: 'all', text: 'Ca≈Çy okres' }
                ],
                buttonTheme: { width: 70 }
            },
            scrollbar: { enabled: true }
        };

        ['chart-container-1', 'chart-container-2', 'chart-container-3'].forEach((containerId) => {
            const specificOptions = {
                'chart-container-1': { chart: { type: 'column' }, plotOptions: { column: { pointPadding: 0.3, groupPadding: 0.7, pointWidth: 14 } } },
                'chart-container-2': { chart: { type: 'bar' }, plotOptions: { bar: { pointWidth: 11, stacking: 'normal' } } },
                'chart-container-3': { chart: { type: 'areaspline' }, plotOptions: { areaspline: { pointWidth: 9, fillOpacity: 0.5, zIndex: 0 } } }
            }[containerId];

            Highcharts.chart(containerId, { ...chartOptions, ...specificOptions });
        });
    }

    function applyTheme() {
    // Load custom font for enhanced typography
    Highcharts.createElement('link', {
        href: 'https://fonts.cdnfonts.com/css/front-page-supplement',
        rel: 'stylesheet',
        type: 'text/css'
    }, null, document.getElementsByTagName('head')[0]);

    // Define modern color palette with improved accessibility and visual hierarchy
    Highcharts.theme = {
    colors: [
        '#FFCC02', // Z≈Çoty ≈º√≥≈Çty
        '#223FD7', // Intensywny niebieski
        '#FE1544', // Soczysta czerwie≈Ñ
        '#06FE45', // Jasna ziele≈Ñ
        '#BCE214', // ≈ª√≥≈Çto-zielony limonkowy
        '#8B49D1', // Fioletowy amarant
        '#07E6B7', // Turkus
        '#049FFF', // Nasycony b≈Çƒôkit
        '#F30DF3', // R√≥≈º neonowy
        '#EDFE02'  // Jaskrawa cytryna
    ],
        chart: {
            backgroundColor: {
                linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                stops: [
                    [0, '#2c3036'], // Slate 800
                    [1, '#3e3e40']  // Slate 900
                ]
            },
            style: {
                fontFamily: 'Inter, system-ui, sans-serif'
            },
            plotBorderColor: '#475569' // Slate 600
        },
        title: {
            style: {
                color: '#F1F5F9', // Slate 100
                textTransform: 'none',
                fontSize: '1.25rem',
                fontWeight: '550'
            }
        },
        subtitle: {
            style: {
                color: '#CBD5E1', // Slate 300
                textTransform: 'none'
            }
        },
        xAxis: {
            gridLineColor: '#334155', // Slate 700
            labels: {
                style: {
                    color: '#CBD5E1' // Slate 300
                }
            },
            lineColor: '#475569', // Slate 600
            minorGridLineColor: '#1E293B', // Slate 800
            tickColor: '#475569', // Slate 600
            title: {
                style: {
                    color: '#E2E8F0' // Slate 200
                }
            }
        },
        yAxis: {
            gridLineColor: '#334155', // Slate 700
            labels: {
                style: {
                    color: '#CBD5E1' // Slate 300
                }
            },
            lineColor: '#475569', // Slate 600
            minorGridLineColor: '#1E293B', // Slate 800
            tickColor: '#475569', // Slate 600
            title: {
                style: {
                    color: '#E2E8F0' // Slate 200
                }
            }
        },
        tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)', // Slate 900 with opacity
            style: {
                color: '#F8FAFC' // Slate 50
            },
            borderWidth: 0,
            borderRadius: 8,
            shadow: true,
            animation: true
        },
        plotOptions: {
            series: {
                dataLabels: {
                    color: '#E2E8F0', // Slate 200
                    style: {
                        textOutline: '1px contrast'
                    }
                },
                marker: {
                    lineColor: '#1E293B' // Slate 800
                }
            }
        },
        legend: {
            backgroundColor: 'transparent',
            itemStyle: {
                color: '#E2E8F0', // Slate 200
                fontWeight: '470'
            },
            itemHoverStyle: {
                color: '#F8FAFC' // Slate 50
            },
            itemHiddenStyle: {
                color: '#64748B' // Slate 500
            }
        },
        credits: {
            style: {
                color: '#64748B' // Slate 500
            }
        },
        drilldown: {
            activeAxisLabelStyle: {
                color: '#F1F5F9' // Slate 100
            },
            activeDataLabelStyle: {
                color: '#F1F5F9' // Slate 100
            }
        },
        navigation: {
            buttonOptions: {
                symbolStroke: '#E2E8F0', // Slate 200
                theme: {
                    fill: '#334155' // Slate 700
                }
            }
        }
    };

    // Apply the custom theme to all charts
    Highcharts.setOptions(Highcharts.theme);
}

// Initialize theme and render charts
applyTheme();
renderCharts();
});

function generateSummary3Table() {
    const mainTableData = mainTable.rows().data().toArray();
    const summary3Data = new Map();
    const indices = {
        group: jsonData[0].indexOf('Grupa prod'),
        regNumber: jsonData[0].indexOf('Nr rejestracyjny'),
        date: jsonData[0].indexOf('Data realizacji'),
        liters: jsonData[0].indexOf('Ilo≈õƒá'),
        netValue: jsonData[0].indexOf('Warto≈õƒá netto'),
        counter: jsonData[0].indexOf('Licznik')
    };

    const months = ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec", "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"];

    mainTableData.forEach(row => {
        const group = row[indices.group];
        if (group !== 'Olej napƒôdowy' && group !== 'Benzyna') return;

        const date = new Date(row[indices.date]);
        if (!date) return;

        const liters = parseFloat(row[indices.liters]);
        const netValue = parseFloat(row[indices.netValue]);
        const counterValue = parseFloat(row[indices.counter]);
        if (isNaN(liters) || isNaN(netValue) || isNaN(counterValue)) return;

        const key = `${row[indices.regNumber]}_${date.getFullYear()}_${date.getMonth() + 1}`;
        let entry = summary3Data.get(key);
        if (!entry) {
            entry = {
                RegistrationNumber: row[indices.regNumber],
                Month: date.getMonth() + 1,
                Year: date.getFullYear(),
                TotalLiters: 0,
                TotalNetValue: 0,
                MaxCounterValue: -1
            };
            summary3Data.set(key, entry);
        }
        entry.TotalLiters += liters;
        entry.TotalNetValue += netValue;
        entry.MaxCounterValue = Math.max(entry.MaxCounterValue, counterValue);
    });

    const tableData = Array.from(summary3Data.values()).map(entry => [
        entry.RegistrationNumber,
        months[entry.Month - 1],
        entry.Year,
        entry.TotalLiters.toFixed(2),
        entry.TotalNetValue.toFixed(2),
        entry.MaxCounterValue
    ]);

    if ($.fn.dataTable.isDataTable("#summary3-table")) {
        $("#summary3-table").DataTable().destroy();
    }

    $("#summary3-table-container").html('<table id="summary3-table" class="table table-striped"></table>');

    $("#summary3-table").DataTable({
        data: tableData,
        columns: [
            { title: "Rejestracja" },
            { title: "MiesiƒÖc" },
            { title: "Rok" },
            { title: "‚àë litry" },
            { title: "‚àë netto" },
            { title: "‚äÉ licznik" }
        ],
        dom: '<"ex-buttons"Bf>lrtip',
        buttons: [
            {
                extend: 'collection',
                text: 'Export',
                className: 'ex-buttons',
                buttons: [
                    { extend: 'csv', charset: 'UTF-8', bom: true },
                    { extend: 'excel', title: null },
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        title: 'List PDF',
                        customize: doc => {
                            doc.styles.title = {
                                color: 'blue',
                                fontSize: '25',
                                bold: true
                            };
                        },
                    },
                ],
            }
        ],
        paging: true,
        pageLength: 10,
        searching: true,
        info: false,
        order: [[2, 'desc'], [1, 'desc']]
    });
}


function generateSummary4Table() {
    const mainTableData = mainTable.rows().data().toArray();
    const summary4Data = {};

    mainTableData.forEach(row => {
        const registrationNumber = row[jsonData[0].indexOf('Nr rejestracyjny')];
        const date = row[jsonData[0].indexOf('Data realizacji')];
        const productGroup = row[jsonData[0].indexOf('Grupa prod')];
        const counterValue = parseFloat(row[jsonData[0].indexOf('Licznik')]);

        if (registrationNumber && date && productGroup && !isNaN(counterValue) && counterValue >= 400) {
            const year = new Date(date).getFullYear();
            const month = new Date(date).getMonth() + 1;

            summary4Data[registrationNumber] ??= {};
            summary4Data[registrationNumber][year] ??= {
                'Rok': year,
                'CounterValues': Array.from({ length: 12 }, () => [])
            };

            summary4Data[registrationNumber][year]['CounterValues'][month - 1].push(counterValue);
        }
    });

    const getValidCounterValue = (currentValues, previousMonthValue, nextMonthValue) => {
        if (currentValues.length === 0) return { value: '', corrected: false, color: '' };
        if (currentValues.length === 1 && !previousMonthValue && !nextMonthValue) return { value: currentValues[0], corrected: false, color: '' };

        currentValues.sort((a, b) => a - b);

        const removeExtraDigits = (value, referenceValue) => {
            while (value > referenceValue * 10) {
                value = Math.floor(value / 10);
            }
            return value;
        };

        const isReasonableValue = (value, referenceValue) => {
            const lowerBound = referenceValue * 0.5;
            const upperBound = referenceValue * 1.5;
            return value >= lowerBound && value <= upperBound;
        };

        // Ignorowanie warto≈õci wyra≈∫nie odbiegajƒÖcych od sƒÖsiad√≥w
        const validValues = currentValues.filter(value => {
            if (previousMonthValue && nextMonthValue) {
                const avgValue = (previousMonthValue + nextMonthValue) / 2;
                return isReasonableValue(value, avgValue);
            }
            if (previousMonthValue) return isReasonableValue(value, previousMonthValue);
            if (nextMonthValue) return isReasonableValue(value, nextMonthValue);
            return true;
        });

        if (validValues.length === 0) {
            return { value: previousMonthValue || nextMonthValue || '', corrected: true, color: 'purple' };
        }

        let validValue;
        if (previousMonthValue && nextMonthValue) {
            const avgValue = (previousMonthValue + nextMonthValue) / 2;
            validValue = validValues.reduce((a, b) => Math.abs(b - avgValue) < Math.abs(a - avgValue) ? b : a);
            return { value: validValue, corrected: validValue !== Math.max(...currentValues), color: 'red' };
        } else if (previousMonthValue) {
            validValue = validValues.filter(v => v >= previousMonthValue && v <= previousMonthValue * 1.5).pop() || validValues[0];
            return { value: validValue, corrected: validValue !== Math.max(...currentValues), color: 'orange' };
        } else if (nextMonthValue) {
            validValue = validValues.filter(v => v <= nextMonthValue).pop() || validValues[0];
            return { value: validValue, corrected: validValue !== Math.max(...currentValues), color: 'purple' };
        } else {
            validValue = validValues[Math.floor(validValues.length / 2)];
            return { value: validValue, corrected: validValue !== Math.max(...currentValues), color: 'green' };
        }
    };

    const summary4Table = $('<table class="table table-striped summary4-table"></table>');
    const tableHeader = '<thead><tr><th>Rejestracja</th><th>Rok</th><th>Sty</th><th>Lut</th><th>Mar</th><th>Kwi</th><th>Maj</th><th>Cze</th><th>Lip</th><th>Sie</th><th>Wrz</th><th>Pa≈∫</th><th>Lis</th><th>Gru</th><th>Przebieg</th></tr></thead>';
    summary4Table.append(tableHeader);

    let tableBody = '<tbody>';
    Object.keys(summary4Data).forEach(registrationNumber => {
        let previousYearDecemberValue = null;

        Object.keys(summary4Data[registrationNumber]).forEach((year, yearIndex, yearsArray) => {
            tableBody += '<tr>';
            tableBody += `<td>${registrationNumber}</td><td>${year}</td>`;

            let previousMonthValue = previousYearDecemberValue;
            let monthlyValues = [];

            for (let month = 1; month <= 12; month++) {
                const currentValues = summary4Data[registrationNumber][year]['CounterValues'][month - 1];

                let nextMonthValue = null;
                if (month < 12) {
                    nextMonthValue = summary4Data[registrationNumber][year]['CounterValues'][month]?.[0] || null;
                } else if (yearIndex < yearsArray.length - 1) {
                    nextMonthValue = summary4Data[registrationNumber][yearsArray[yearIndex + 1]]['CounterValues'][0]?.[0] || null;
                }

                const { value: validCounterValue, corrected, color } = getValidCounterValue(currentValues, previousMonthValue, nextMonthValue);
                const cellStyle = corrected ? `style="color: ${color};"` : '';
                tableBody += `<td ${cellStyle}>${validCounterValue}</td>`;

                if (validCounterValue !== '') {
                    previousMonthValue = validCounterValue;
                    monthlyValues.push(validCounterValue);
                }
            }

            const mileage = monthlyValues.length > 0
                ? Math.max(0, monthlyValues[monthlyValues.length - 1] - (previousYearDecemberValue || monthlyValues[0]))
                : '';

            tableBody += `<td>${mileage}</td></tr>`;
            previousYearDecemberValue = monthlyValues[monthlyValues.length - 1];
        });
    });
    tableBody += '</tbody>';
    summary4Table.append(tableBody);

    $("#summary4-table-container").html(summary4Table);

    if ($.fn.dataTable.isDataTable("#summary4-table-container table")) {
        $("#summary4-table-container table").DataTable().destroy();
    }

    $("#summary4-table-container table").DataTable({
        dom: '<"ex-buttons"Bf>lrtip',
        buttons: [
            {
                extend: 'collection',
                text: 'Export',
                className: 'ex-buttons',
                buttons: [
                    { extend: 'csv', charset: 'UTF-8', bom: true, filename: `Podsumowanie_${new Date().toISOString().replace(/[:\.]/g, '-')}_4` },
                    { extend: 'excel', title: null },
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        title: 'Podsumowanie 4',
                        customize: doc => {
                            doc.styles.title = { color: 'blue', fontSize: '25', bold: true };
                        }
                    }
                ]
            }
        ],
        paging: true,
        pageLength: 10,
        searching: true,
        info: false,
        order: [[1, 'asc']]
    });
}

const L = window.L;

let map;
let markers = [];
let ortofotomapLayer;

function filterByYear(year) {
    const table = $("#summary5-table-container table").DataTable();
    $.fn.dataTable.ext.search = [];
    if (year !== 'all') {
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            return data[3] == year;
        });
    }
    table.draw();
    updateMap();
}

function clearYearFilter() {
    $.fn.dataTable.ext.search = [];
}

function generateSummary5Table() {
    if (!mainTable || !$.fn.DataTable.isDataTable(mainTable)) {
        console.error("mainTable nie jest zainicjalizowane.");
        return;
    }

    const mainTableData = mainTable.rows().data().toArray();
    const stationNumberIndex = jsonData[0].indexOf('Nr stacji');
    const locationIndex = jsonData[0].indexOf('Miejscowo≈õƒá');
    const stationTypeIndex = jsonData[0].indexOf('Typ Stacji');
    const dateIndex = jsonData[0].indexOf('Data realizacji');
    const netValueIndex = jsonData[0].indexOf('Warto≈õƒá netto');
    const quantityIndex = jsonData[0].indexOf('Ilo≈õƒá');

    const summary5Data = {};

    for (const row of mainTableData) {
        const stationNumber = row[stationNumberIndex];
        const location = row[locationIndex];
        const stationType = row[stationTypeIndex];
        const date = row[dateIndex];
        const netValue = parseFloat(row[netValueIndex]);
        const quantity = parseFloat(row[quantityIndex]);

        if (stationNumber && location && stationType && date && !isNaN(netValue) && !isNaN(quantity)) {
            const year = new Date(date).getFullYear();
            const month = new Date(date).getMonth();

            summary5Data[stationNumber] ??= {};
            summary5Data[stationNumber][year] ??= {
                'Rok': year,
                'Miejscowo≈õƒá': location,
                'Typ': stationType,
                'SumaNettoFak': new Array(12).fill(0),
                'SumaIlo≈õƒá': new Array(12).fill(0),
                'Ilo≈õƒáTransakcji': new Array(12).fill(0),
                'SumaNetto': 0,
                'SumaIlo≈õƒáTotal': 0,
                'SumaTransakcjiTotal': 0,
            };

            summary5Data[stationNumber][year]['SumaNettoFak'][month] += netValue;
            summary5Data[stationNumber][year]['SumaIlo≈õƒá'][month] += quantity;
            summary5Data[stationNumber][year]['Ilo≈õƒáTransakcji'][month]++;
            summary5Data[stationNumber][year]['SumaNetto'] += netValue;
            summary5Data[stationNumber][year]['SumaIlo≈õƒáTotal'] += quantity;
            summary5Data[stationNumber][year]['SumaTransakcjiTotal']++;
        }
    }

    const sortedYears = [...new Set(Object.values(summary5Data).flatMap(station => Object.keys(station)))].sort((a, b) => b - a);

    const sortedSummaryData = {};

    for (const year of sortedYears) {
        const stationsData = Object.entries(summary5Data)
            .map(([stationNumber, stationData]) => ({
                stationNumber,
                ...stationData[year]
            }))
            .filter(station => station.SumaNetto || station.SumaIlo≈õƒáTotal);

        stationsData.sort((a, b) => b.SumaNetto - a.SumaNetto);
        sortedSummaryData[year] = stationsData;
    }

    $("#year-buttons").remove();
    $("#data-type-buttons").remove();

    const yearButtons = $('<div id="year-buttons" class="mb-3"></div>');
    yearButtons.append('<button class="btn btn-secondary mr-2" onclick="clearYearFilter(); $(\'#summary5-table-container table\').DataTable().draw();">Wszystkie lata</button>');
    sortedYears.forEach(year => {
        yearButtons.append(`<button class="btn btn-secondary mr-2" onclick="filterByYear(${year})">${year}</button>`);
    });
    $("#summary5-table-container").before(yearButtons);

    const dataTypeButtons = $('<div id="data-type-buttons" class="mb-3"></div>');
    dataTypeButtons.append('<button class="btn btn-primary mr-2" onclick="changeDataType(\'netto\')">Warto≈õƒá netto</button>');
    dataTypeButtons.append('<button class="btn btn-primary mr-2" onclick="changeDataType(\'ilosc\')">Ilo≈õƒá</button>');
    dataTypeButtons.append('<button class="btn btn-primary mr-2" onclick="changeDataType(\'transakcje\')">Ilo≈õƒá transakcji</button>');
    $("#summary5-table-container").before(dataTypeButtons);

    const summary5Table = $('<table class="table table-striped summary5-table"></table>');
    const tableHeader = '<thead><tr><th>Stacja</th><th>Miejscowo≈õƒá</th><th>Typ</th><th>Rok</th><th>Sty</th><th>Lut</th><th>Mar</th><th>Kwi</th><th>Maj</th><th>Cze</th><th>Lip</th><th>Sie</th><th>Wrz</th><th>Pa≈∫</th><th>Lis</th><th>Gru</th><th>Suma</th></tr></thead>';
    summary5Table.append(tableHeader);

    let tableBody = '<tbody>';
    for (const year of sortedYears) {
        const yearData = sortedSummaryData[year];
        const top50Stations = new Set(yearData.slice(0, 50).map(station => station.stationNumber));
        
        for (const stationData of yearData) {
            const { stationNumber, Miejscowo≈õƒá, Typ, SumaNettoFak, SumaIlo≈õƒá, Ilo≈õƒáTransakcji, SumaNetto, SumaIlo≈õƒáTotal, SumaTransakcjiTotal } = stationData;
            const isTop50 = top50Stations.has(stationNumber);
            const rowStyle = isTop50 ? ' style="background-color: #90EE90;"' : '';
            
            tableBody += `<tr data-year="${year}"${rowStyle}>`;
            tableBody += `<td>${stationNumber}</td>`;
            tableBody += `<td>${Miejscowo≈õƒá}</td>`;
            tableBody += `<td>${Typ}</td>`;
            tableBody += `<td>${year}</td>`;
            for (let month = 0; month < 12; month++) {
                tableBody += `<td data-netto="${SumaNettoFak[month].toFixed(2)}" data-ilosc="${SumaIlo≈õƒá[month].toFixed(2)}" data-transakcje="${Ilo≈õƒáTransakcji[month]}">${SumaNettoFak[month].toFixed(2)}</td>`;
            }
            tableBody += `<td data-netto="${SumaNetto.toFixed(2)}" data-ilosc="${SumaIlo≈õƒáTotal.toFixed(2)}" data-transakcje="${SumaTransakcjiTotal}">${SumaNetto.toFixed(2)}</td>`;
            tableBody += '</tr>';
        }
    }
    tableBody += '</tbody>';
    summary5Table.append(tableBody);

    $("#summary5-table-container").html(summary5Table);

    if ($.fn.dataTable.isDataTable("#summary5-table-container table")) {
        $("#summary5-table-container table").DataTable().destroy();
    }

    clearYearFilter();

    $("#summary5-table-container table").DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'collection',
                text: 'Eksportuj',
                className: 'ex-buttons',
                buttons: [
                    { extend: 'csv', charset: 'UTF-8', bom: true },
                    { extend: 'excel', title: null },
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        title: 'Lista stacji',
                        customize: function (doc) {
                            doc.styles.title = {
                                color: 'blue',
                                fontSize: '25',
                                bold: true
                            };
                        },
                    },
                ],
            }
        ],
        paging: true,
        pageLength: 50,
        searching: true,
        info: false,
        order: [],
        drawCallback: function() {
            updateMap();
        },
        createdRow: function(row, data, dataIndex) {
            const table = this.api();
            const visibleData = table.rows({ search: 'applied' }).data().toArray();
            const sortedData = [...visibleData].sort((a, b) => parseFloat(b[b.length - 1]) - parseFloat(a[a.length - 1]));
            const top50Stations = new Set(sortedData.slice(0, 50).map(row => row[0]));
            
            if (top50Stations.has(data[0])) {
                $(row).css('background-color', '#90EE90');
            }
        }
    });

    if (!map) {
        $("#summary5-table-container").after('<div id="map" style="height: 400px; margin-top: 20px;"></div>');
        initMap();
    }

    updateMap();
    styleButtons();
}

function styleButtons() {
    const buttons = document.querySelectorAll('#year-buttons button, #data-type-buttons button');
    buttons.forEach(button => {
        button.style.backgroundColor = '#4f46e5';
        button.style.color = 'white';
        button.style.padding = '6px 14px';
        button.style.border = 'none';
        button.style.borderRadius = '8px';
        button.style.cursor = 'pointer';
        button.style.marginRight = '10px';
        button.style.transition = 'background-color 0.3s';

        button.addEventListener('mouseover', () => {
            button.style.backgroundColor = '#4338ca';
        });

        button.addEventListener('mouseout', () => {
            button.style.backgroundColor = '#4f46e5';
        });
    });
}

function changeDataType(type) {
    const table = $("#summary5-table-container table").DataTable();
    const rows = table.rows().nodes();

    $(rows).find('td:nth-child(n+5)').each(function() {
        const cell = $(this);
        const value = cell.data(type);
        if (type === 'transakcje') {
            cell.text(Math.round(value));
        } else {
            cell.text(parseFloat(value).toFixed(2));
        }
    });
}

function initMap() {
    map = L.map('map', {
        crs: L.CRS.EPSG3857,
        maxZoom: 22,
        fullscreenControl: true
    }).setView([52.069, 19.480], 6);

    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    });

    const ortofotomapLayerHighRes = L.tileLayer.wms('https://mapy.geoportal.gov.pl/wss/service/PZGIK/ORTO/WMS/HighResolution', {
        layers: 'Raster',
        format: 'image/png',
        transparent: true,
        version: '1.3.0',
        crs: L.CRS.EPSG3857,
        attribution: "¬© <a href='https://geoportal.gov.pl/'>Geoportal</a>",
        maxZoom: 22
    });

    const baseMaps = {
        "OpenStreetMap": osmLayer,
        "Ortofotomapa High Res": ortofotomapLayerHighRes
    };

    osmLayer.addTo(map);
    L.control.layers(baseMaps).addTo(map);

    L.easyButton('fa-camera', function() {
        if (map.hasLayer(ortofotomapLayerHighRes)) {
            map.removeLayer(ortofotomapLayerHighRes);
        } else {
            map.addLayer(ortofotomapLayerHighRes);
        }
    }, 'Prze≈ÇƒÖcz ortofotomapƒô').addTo(map);
}

const geocodeCache = new Map();

async function geocodeAddress(address) {
    if (geocodeCache.has(address)) {
        return geocodeCache.get(address);
    }

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=pl`);
        const data = await response.json();
    
        if (data.length > 0) {
            const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
            geocodeCache.set(address, coords);
            return coords;
        }
    } catch (error) {
        console.error(`B≈ÇƒÖd geokodowania adresu ${address}:`, error);
    }
    
    return null;
}

async function updateMap() {
    const table = $("#summary5-table-container table").DataTable();
    const visibleRows = table.rows({ search: 'applied' }).data();

    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    const sortedRows = Array.from(visibleRows)
        .sort((a, b) => parseFloat(b[b.length - 1]) - parseFloat(a[a.length - 1]))
        .slice(0, 50);

    for (let row of sortedRows) {
        const stationNumber = row[0];
        const location = row[1];
        const value = parseFloat(row[row.length - 1]);

        const coords = await geocodeAddress(location);

        if (coords) {
            const marker = L.marker(coords).addTo(map);
            marker.bindPopup(`<b>Stacja: ${stationNumber}</b><br>Miejscowo≈õƒá: ${location}<br>Warto≈õƒá: ${value.toFixed(2)} PLN`);
            markers.push(marker);
        }
    }

    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds());
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

$('#summary5-table-container table').on('search.dt', debounce(function() {
    updateMap();
}, 300));

$(document).ready(function() {
    generateSummary5Table();
});

const monthNames = ["Sty", "Lut", "Mar", "Kwi", "Maj", "Cze", "Lip", "Sie", "Wrz", "Pa≈∫", "Lis", "Gru"];

function generateSummary6Table() {
    const mainTableData = mainTable.rows().data().toArray();
    let summary6Data = [];
    let availableMonths = new Set(); // Zbi√≥r dostƒôpnych miesiƒôcy

    // Zbieranie dostƒôpnych miesiƒôcy
    mainTableData.forEach(row => {
        const date = row[jsonData[0].indexOf('Data realizacji')];
        if (date) {
            const dateObj = new Date(date);
            const monthYear = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
            availableMonths.add(monthYear);
        }
    });

    // Tworzenie selecta z miesiƒÖcami
    const monthSelect = $('<select id="monthSelector" class="form-select mb-3">');
    monthSelect.append('<option value="">Wszystkie miesiƒÖce</option>');
    
    // Sortowanie miesiƒôcy
    const sortedMonths = Array.from(availableMonths).sort().reverse();
    
    sortedMonths.forEach(monthYear => {
        const [year, month] = monthYear.split('-');
        const monthName = monthNames[parseInt(month) - 1];
        monthSelect.append(`<option value="${monthYear}">${monthName} ${year}</option>`);
    });

    // Dodanie selecta do kontenera
    $("#month-selector-container").html(monthSelect);

    // Style CSS
    const customStyles = `
        <style>
            tr.bold-red-text td {
                font-weight: bold;
                color: #ff0000;
            }
            table { 
                width: 100%; 
            } 
        </style>
    `;
    $('head').append(customStyles);

    function updateTable(selectedMonth = '') {
        let filteredData = [];
        let saturdaySum = 0;
        let sundaySum = 0;

        for (const row of mainTableData) {
            const registrationNumber = row[jsonData[0].indexOf('Nr rejestracyjny')];
            const date = row[jsonData[0].indexOf('Data realizacji')];
            const liters = parseFloat(row[jsonData[0].indexOf('Ilo≈õƒá')]);
            const netValue = parseFloat(row[jsonData[0].indexOf('Warto≈õƒá netto')]);
            const productGroup = row[jsonData[0].indexOf('Grupa prod')];

            if (registrationNumber && date && !isNaN(liters) && !isNaN(netValue) && 
                productGroup !== 'Us≈Çuga webserwisu' && productGroup !== 'Op≈Çata za karty') {
                
                const dateObj = new Date(date);
                const rowMonthYear = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                
                if (selectedMonth && rowMonthYear !== selectedMonth) continue;

                const dayOfWeek = dateObj.getDay();

                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    const dayNames = ['Niedziela', 'Poniedzia≈Çek', 'Wtorek', '≈öroda', 'Czwartek', 'PiƒÖtek', 'Sobota'];
                    const dayName = dayNames[dayOfWeek];

                    if (dayOfWeek === 6) {
                        saturdaySum += netValue;
                    } else if (dayOfWeek === 0) {
                        sundaySum += netValue;
                    }

                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const correctedFormattedDate = `${year}-${month}-${day}`;

                    filteredData.push({
                        'Rejestracja': registrationNumber,
                        'Data': correctedFormattedDate,
                        'Ilo≈õƒá': liters,
                        'Netto': netValue,
                        'Produkt': productGroup,
                        'Dzie≈Ñ': dayName
                    });
                }
            }
        }

        // Aktualizacja sum
        $('#SaturdaySuma').text(saturdaySum.toFixed(2) + ' PLN');
        $('#SundaySuma').text(sundaySum.toFixed(2) + ' PLN');

        // Generowanie tabeli
        const summary6Table = $('<table class="table table-striped summary6-table"></table>');
        const tableHeader = '<thead><tr><th>Rejestracja</th><th>Data</th><th>Ilo≈õƒá</th><th>Netto</th><th>Produkt</th><th>Dzie≈Ñ</th></tr></thead>';
        summary6Table.append(tableHeader);

        let tableBody = '<tbody>';
        for (const row of filteredData) {
            const rowClass = row['Dzie≈Ñ'] === 'Niedziela' ? 'bold-red-text' : '';
            tableBody += `<tr class="${rowClass}">`;
            tableBody += `<td>${row['Rejestracja']}</td>`;
            tableBody += `<td>${row['Data']}</td>`;
            tableBody += `<td>${row['Ilo≈õƒá'].toFixed(2)}</td>`;
            tableBody += `<td>${row['Netto'].toFixed(2)}</td>`;
            tableBody += `<td>${row['Produkt']}</td>`;
            tableBody += `<td>${row['Dzie≈Ñ']}</td>`;
            tableBody += '</tr>';
        }
        tableBody += '</tbody>';
        summary6Table.append(tableBody);

        $("#summary6-table-container").html(summary6Table);

        if ($.fn.dataTable.isDataTable("#summary6-table-container table")) {
            $("#summary6-table-container table").DataTable().destroy();
        }

        $("#summary6-table-container table").DataTable({
            dom: '<"ex-buttons"Bf>lrtip',
            buttons: {
                buttons: [
                    {
                        extend: 'collection',
                        text: 'Export',
                        className: 'ex-buttons',
                        buttons: [
                            {
                                extend: 'csv',
                                charset: 'UTF-8',
                                bom: true,
                            },
                            { extend: 'excel', title: null },
                            {
                                extend: 'pdfHtml5',
                                orientation: 'portrait',
                                pageSize: 'A4',
                                title: 'Summary6',
                                customize: function (doc) {
                                    doc.styles.title = {
                                        color: 'blue',
                                        fontSize: '25',
                                        bold: true
                                    };
                                    doc.content[1].table.widths = Array(doc.content[1].table.body[0].length + 1).join('*').split('');
                                },
                            },
                        ],
                    }
                ],
            },
            paging: true,
            pageLength: 10,
            searching: true,
            info: false,
            createdRow: function(row, data, dataIndex) {
                if (data[5] === 'Niedziela') {
                    $(row).addClass('bold-red-text');
                }
            }
        });
    }

    // Inicjalne za≈Çadowanie tabeli
    updateTable();

    // Obs≈Çuga zmiany miesiƒÖca
    $('#monthSelector').on('change', function() {
        updateTable($(this).val());
    });
}

function generateSummary7Table() {
    const mainTableData = mainTable.rows().data().toArray();
    const summary7Data = {};

    for (const row of mainTableData) {
        const costData = row[jsonData[0].indexOf('Dane kosztowe')] || '';
        const cardNumber = row[jsonData[0].indexOf('Nr karty')];
        const registrationNumber = row[jsonData[0].indexOf('Nr rejestracyjny')];
        const liters = parseFloat(row[jsonData[0].indexOf('Ilo≈õƒá')]);
        const netValue = parseFloat(row[jsonData[0].indexOf('Warto≈õƒá netto')]);
        const productGroup = row[jsonData[0].indexOf('Grupa prod')];
        const date = new Date(row[jsonData[0].indexOf('Data realizacji')]);

        if (!isNaN(liters) && !isNaN(netValue) && cardNumber && registrationNumber && productGroup && date) {
            const year = date.getFullYear();
            const month = date.getMonth();

            const groupKey = costData || `wg Nr rejestracyjnego: ${registrationNumber}`;
            const dataKey = `${year}|${productGroup}|${cardNumber}|${registrationNumber}`;

            summary7Data[groupKey] = summary7Data[groupKey] || {};
            summary7Data[groupKey][dataKey] = summary7Data[groupKey][dataKey] || Array(12).fill().map(() => ({ 'Ilo≈õƒá': 0, 'Warto≈õƒá netto': 0 }));

            summary7Data[groupKey][dataKey][month]['Ilo≈õƒá'] += liters;
            summary7Data[groupKey][dataKey][month]['Warto≈õƒá netto'] += netValue;
        }
    }

    const summary7Table = $('<table class="table table-striped summary7-table"></table>');
    const tableHeader = '<thead><tr><th>Dane kosztowe</th><th>Rok</th><th>Produkt</th><th>Nr karty</th><th>Nr rejestracyjny</th>' +
        monthNames.map(month => `<th>${month}</th>`).join('') + '<th>Suma</th></tr></thead>';
    summary7Table.append(tableHeader);

    let tableBody = '<tbody>';
    for (const [groupKey, groupEntries] of Object.entries(summary7Data)) {
        for (const [dataKey, monthData] of Object.entries(groupEntries)) {
            const [year, productGroup, cardNumber, registrationNumber] = dataKey.split('|');
            let rowSum = { 'Ilo≈õƒá': 0, 'Warto≈õƒá netto': 0 };

            tableBody += `<tr>`;
            tableBody += `<td>${groupKey}</td>`;
            tableBody += `<td>${year}</td>`;
            tableBody += `<td>${productGroup}</td>`;
            tableBody += `<td>${cardNumber}</td>`;
            tableBody += `<td>${registrationNumber}</td>`;
            
            for (let month = 0; month < 12; month++) {
                rowSum['Ilo≈õƒá'] += monthData[month]['Ilo≈õƒá'];
                rowSum['Warto≈õƒá netto'] += monthData[month]['Warto≈õƒá netto'];
                tableBody += `<td data-amount="${monthData[month]['Ilo≈õƒá'].toFixed(2)}" data-value="${monthData[month]['Warto≈õƒá netto'].toFixed(2)}">
                    ${monthData[month]['Ilo≈õƒá'].toFixed(2)}
                </td>`;
            }
            tableBody += `<td data-amount="${rowSum['Ilo≈õƒá'].toFixed(2)}" data-value="${rowSum['Warto≈õƒá netto'].toFixed(2)}">
                ${rowSum['Ilo≈õƒá'].toFixed(2)}
            </td>`;
            tableBody += `</tr>`;
        }
    }
    tableBody += '</tbody>';
    summary7Table.append(tableBody);

    $("#summary7-table-container").html(summary7Table);

    // Dodaj prze≈ÇƒÖcznik
    const switchHtml = `
        <div class="switch-container" style="margin-bottom: 10px;">
            <label class="switch">
                <input type="checkbox" id="dataSwitch">
                <span class="slider"></span>
            </label>
            <span id="switchLabel">Ilo≈õƒá</span>
        </div>
    `;
    $("#summary7-table-container").prepend(switchHtml);

    // Obs≈Çuga prze≈ÇƒÖcznika
    $("#dataSwitch").change(function() {
        const isChecked = $(this).is(":checked");
        const label = isChecked ? "Warto≈õƒá netto" : "Ilo≈õƒá";
        $("#switchLabel").text(label);
        
        $(".summary7-table td").each(function() {
            const amount = $(this).data('amount');
            const value = $(this).data('value');
            if (amount !== undefined && value !== undefined) {
                $(this).text(isChecked ? value : amount);
            }
        });
    });

    if ($.fn.dataTable.isDataTable("#summary7-table-container table")) {
        $("#summary7-table-container table").DataTable().destroy();
    }

    $("#summary7-table-container table").DataTable({
        dom: '<"ex-buttons"Bf>lrtip',
        buttons: {
            buttons: [
                {
                    extend: 'collection',
                    text: 'Export',
                    className: 'ex-buttons',
                    buttons: [
                        {
                            extend: 'csv',
                            charset: 'UTF-8',
                            bom: true,
                        },
                        { extend: 'excel', title: null },
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            title: 'Summary 7',
                            customize: function (doc) {
                                doc.styles.title = {
                                    color: 'blue',
                                    fontSize: '25',
                                    bold: true
                                };
                            },
                        },
                    ],
                }
            ],
        },
        paging: true,
        pageLength: 10,
        searching: true,
        info: false,
        order: [[0, 'asc'], [1, 'asc'], [2, 'asc'], [3, 'asc'], [4, 'asc']],
        rowGroup: {
            dataSrc: 0,
            startRender: function (rows, group) {
                return $('<tr/>').append(
                    $('<td/>').attr('colspan', 18).append(
                        $('<strong/>').text(group)
                    )
                );
            }
        }
    });
}

function generateSummary8Table() {
    const mainTableData = mainTable.rows().data().toArray();
    const summary8Data = {};

    for (const row of mainTableData) {
        const costData = row[jsonData[0].indexOf('Dane kosztowe')] || 'Na';
        const netValue = parseFloat(row[jsonData[0].indexOf('Warto≈õƒá netto')]);
        const prodGroup = row[jsonData[0].indexOf('Grupa prod')] || 'NaN';

        if (!isNaN(netValue)) {
            summary8Data[costData] = summary8Data[costData] || {
                totalNetValue: 0,
                prodGroups: {}
            };

            summary8Data[costData].totalNetValue += netValue;
            summary8Data[costData].prodGroups[prodGroup] = (summary8Data[costData].prodGroups[prodGroup] || 0) + netValue;
        }
    }

    const summary8Table = $('<table class="table table-striped summary8-table"></table>');
    const tableHeader = '<thead><tr><th>Dane kosztowe</th><th>Produkt</th><th>Suma netto</th></tr></thead>';
    summary8Table.append(tableHeader);

    let tableBody = '<tbody>';
    for (const [costData, costDataInfo] of Object.entries(summary8Data)) {
        for (const [prodGroup, netValue] of Object.entries(costDataInfo.prodGroups)) {
            tableBody += '<tr>';
            tableBody += `<td>${costData}</td>`;
            tableBody += `<td>${prodGroup}</td>`;
            tableBody += `<td>${netValue.toFixed(2)}</td>`;
            tableBody += '</tr>';
        }

        tableBody += '<tr style="background-color: #ffcccc;">';
        tableBody += `<td>${costData}</td>`;
        tableBody += '<td>Suma</td>';
        tableBody += `<td style="color: red;">${costDataInfo.totalNetValue.toFixed(2)}</td>`;
        tableBody += '</tr>';
    }
    tableBody += '</tbody>';
    summary8Table.append(tableBody);

    $("#summary8-table-container").html(summary8Table);

    if ($.fn.dataTable.isDataTable("#summary8-table-container table")) {
        $("#summary8-table-container table").DataTable().destroy();
    }

    $("#summary8-table-container table").DataTable({
        dom: '<"ex-buttons"Bf>lrtip',
        buttons: {
            buttons: [
                {
                    extend: 'collection',
                    text: 'Export',
                    className: 'ex-buttons',
                    buttons: [
                        {
                            extend: 'csv',
                            charset: 'UTF-8',
                            bom: true,
                        },
                        { extend: 'excel', title: null },
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            title: 'Summary 8',
                            customize: function (doc) {
                                doc.styles.title = {
                                    color: 'blue',
                                    fontSize: '25',
                                    bold: true
                                };
                            },
                        },
                    ],
                }
            ],
        },
        paging: true,
        pageLength: 10,
        searching: true,
        info: false,
        order: [[0, 'asc']]
    });
}

// Constants
const COLUMNS = new Map([
    ['REGISTRATION_NUMBER', 'Nr rejestracyjny'],
    ['PRODUCT_GROUP', 'Grupa prod'],
    ['NET_VALUE', 'Warto≈õƒá netto'],
    ['QUANTITY', 'Ilo≈õƒá'],
    ['DATE', 'Data realizacji']
]);

const MONTH_NAMES = ["Sty", "Lut", "Mar", "Kwi", "Maj", "Cze", "Lip", "Sie", "Wrz", "Pa≈∫", "Lis", "Gru"];

// Utility functions
function getShortMonthName(month) {
    return MONTH_NAMES[month - 1];
}

function processData(mainTableData, valueColumn, includeRegistrationNumber = false) {
    const summaryData = new Map();

    const columnIndexes = new Map([
        ['regNumber', jsonData[0].indexOf(COLUMNS.get('REGISTRATION_NUMBER'))],
        ['group', jsonData[0].indexOf(COLUMNS.get('PRODUCT_GROUP'))],
        ['value', jsonData[0].indexOf(valueColumn)],
        ['date', jsonData[0].indexOf(COLUMNS.get('DATE'))]
    ]);

    for (const row of mainTableData) {
        const value = parseFloat(row[columnIndexes.get('value')]);
        if (isNaN(value)) continue;

        const key = includeRegistrationNumber ? row[columnIndexes.get('regNumber')] : row[columnIndexes.get('group')];
        const group = row[columnIndexes.get('group')];
        const [year, month] = row[columnIndexes.get('date')].split('-');

        let keyData = summaryData.get(key);
        if (!keyData) {
            keyData = new Map();
            summaryData.set(key, keyData);
        }

        if (includeRegistrationNumber) {
            let groupData = keyData.get(group);
            if (!groupData) {
                groupData = new Map();
                keyData.set(group, groupData);
            }

            let yearData = groupData.get(year);
            if (!yearData) {
                yearData = new Float64Array(13);
                groupData.set(year, yearData);
            }

            yearData[parseInt(month)] += value;
            yearData[0] += value; // Total for the year
        } else {
            let yearData = keyData.get(year);
            if (!yearData) {
                yearData = new Float64Array(13);
                keyData.set(year, yearData);
            }

            yearData[parseInt(month)] += value;
            yearData[0] += value; // Total for the year
        }
    }

    return summaryData;
}

function generateSummaryTables(tableType1, tableType2) {
    const mainTableData = mainTable.rows().data().toArray();
    const includeRegistrationNumber = tableType1 === 11 || tableType1 === 12;
    const valueColumn1 = (tableType1 === 9 || tableType1 === 11) ? COLUMNS.get('NET_VALUE') : COLUMNS.get('QUANTITY');
    const valueColumn2 = (tableType2 === 9 || tableType2 === 11) ? COLUMNS.get('NET_VALUE') : COLUMNS.get('QUANTITY');

    const summaryData1 = processData(mainTableData, valueColumn1, includeRegistrationNumber);
    const summaryData2 = processData(mainTableData, valueColumn2, includeRegistrationNumber);

    const tableId1 = `summary${tableType1}-table`;
    const tableId2 = `summary${tableType2}-table`;

    createSummaryTable(tableId1, summaryData1, includeRegistrationNumber, valueColumn1);
    createSummaryTable(tableId2, summaryData2, includeRegistrationNumber, valueColumn2);

    addSingleFilterSet(tableId1, tableId2, includeRegistrationNumber);
}

function createSummaryTable(tableId, summaryData, includeRegistrationNumber, valueColumn) {
    const tableContainer = document.getElementById(`${tableId}-container`);
    const table = document.createElement('table');
    table.id = tableId;
    table.className = 'table table-striped';

    // Generate table header
    const headerRow = includeRegistrationNumber 
        ? ['Rejestracja', 'Produkt', 'Rok', ...MONTH_NAMES, 'Suma']
        : ['Produkt', 'Rok', ...MONTH_NAMES, 'Suma'];
    const thead = document.createElement('thead');
    thead.innerHTML = `<tr>${headerRow.map(text => `<th>${text}</th>`).join('')}</tr>`;
    table.appendChild(thead);

    // Generate table body
    const tbody = document.createElement('tbody');
    const rows = [];

    for (const [key, data] of summaryData) {
        if (includeRegistrationNumber) {
            for (const [group, yearData] of data) {
                for (const [year, monthData] of yearData) {
                    const rowData = [key, group, year];
                    for (let month = 1; month <= 12; month++) {
                        rowData.push(monthData[month].toFixed(2));
                    }
                    rowData.push(monthData[0].toFixed(2)); // Year total
                    rows.push(rowData);
                }
            }
        } else {
            for (const [year, monthData] of data) {
                const rowData = [key, year];
                for (let month = 1; month <= 12; month++) {
                    rowData.push(monthData[month].toFixed(2));
                }
                rowData.push(monthData[0].toFixed(2)); // Year total
                rows.push(rowData);
            }
        }
    }

    // Sort rows
    rows.sort((a, b) => {
        const yearIndex = includeRegistrationNumber ? 2 : 1;
        const yearDiff = b[yearIndex] - a[yearIndex];
        if (yearDiff !== 0) return yearDiff;
        return parseFloat(b[b.length - 1]) - parseFloat(a[a.length - 1]);
    });

    // Append sorted rows to tbody
    tbody.innerHTML = rows.map(rowData => `<tr>${rowData.map(data => `<td>${data}</td>`).join('')}</tr>`).join('');
    table.appendChild(tbody);

    tableContainer.innerHTML = '';
    tableContainer.appendChild(table);

    // Initialize DataTable
    if ($.fn.dataTable.isDataTable(`#${tableId}`)) {
        $(`#${tableId}`).DataTable().destroy();
    }

    $(`#${tableId}`).DataTable({
        dom: '<"ex-buttons"Bf>lrtip',
        buttons: {
            buttons: [
                {
                    extend: 'collection',
                    text: 'Export',
                    className: 'ex-buttons',
                    buttons: [
                        {
                            extend: 'csv',
                            charset: 'UTF-8',
                            bom: true,
                            filename: `Podsumowanie_${new Date().toISOString().replace(/[:\.]/g, '-')}_${tableId.replace('summary', '').replace('-table', '')}`,
                        },
                        { extend: 'excel', title: null },
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            title: `Koszty${valueColumn === COLUMNS.get('NET_VALUE') ? 'Warto≈õƒá' : 'Ilo≈õƒá'}${tableId.replace('summary', '').replace('-table', '')}`,
                            customize: function (doc) {
                                doc.styles.title = {
                                    color: 'blue',
                                    fontSize: '25',
                                    bold: true
                                };
                            },
                        },
                    ],
                }
            ],
        },
        paging: true,
        pageLength: 12,
        searching: true,
        info: false,
        ordering: true,
        responsive: true,
        orderCellsTop: true,
        columnDefs: [
            { type: 'date-pl', targets: includeRegistrationNumber ? 2 : 1 }
        ],
        order: [], // Disable initial sorting
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Wyszukaj...",
            paginate: {
                next: "Nastƒôpna",
                previous: "Poprzednia"
            }
        }
    });
}

function addSingleFilterSet(tableId1, tableId2, includeRegistrationNumber) {
    const filterContainerId = `summary-filters-${includeRegistrationNumber ? '11-12' : '9-10'}`;
    const existingContainer = document.getElementById(filterContainerId);
    if (existingContainer) existingContainer.remove();

    const filterContainer = document.createElement('div');
    filterContainer.id = filterContainerId;
    filterContainer.className = 'mb-5 flex flex-wrap gap-2';

    const columns = includeRegistrationNumber 
        ? ['Rejestracja', 'Produkt', 'Rok']
        : ['Produkt', 'Rok'];

    columns.forEach(column => {
        const select = document.createElement('select');
        select.id = `${filterContainerId}-${column.toLowerCase().replace(' ', '-')}`;
        select.className = 'bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition-all duration-300';
        select.innerHTML = `<option value="">Wszystkie ${column}</option>`;
        filterContainer.appendChild(select);
    });

    document.querySelector(`#${tableId1}-container`).insertAdjacentElement('beforebegin', filterContainer);

    updateFilterOptions(tableId1, tableId2, columns);

    columns.forEach((column, index) => {
        const select = document.getElementById(`${filterContainerId}-${column.toLowerCase().replace(' ', '-')}`);
        select.addEventListener('change', function() {
            const val = $.fn.dataTable.util.escapeRegex(this.value);
            $(`#${tableId1}`).DataTable().column(index).search(val ? `^${val}$` : '', true, false).draw();
            $(`#${tableId2}`).DataTable().column(index).search(val ? `^${val}$` : '', true, false).draw();
        });
    });
}

function updateFilterOptions(tableId1, tableId2, columns) {
    const includeRegistrationNumber = columns.length === 3;
    const filterContainerId = `summary-filters-${includeRegistrationNumber ? '11-12' : '9-10'}`;

    columns.forEach((column, index) => {
        const uniqueValues = new Set();
        document.querySelectorAll(`#${tableId1} tbody tr, #${tableId2} tbody tr`).forEach(row => {
            uniqueValues.add(row.cells[index].textContent);
        });

        const select = document.getElementById(`${filterContainerId}-${column.toLowerCase().replace(' ', '-')}`);
        select.innerHTML = `<option value="">Wszystkie ${column}</option>`;
        Array.from(uniqueValues).sort().forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        });
    });
}

function generateSummary13Table() {
    const container = $('#summary13-table-container');
    container.empty();

    // Configuration constants
    const CONFIG = {
        FUEL_GROUPS: ['Olej napƒôdowy', 'Benzyna', 'LPG'],
        MIN_DISTANCE_FOR_CONSUMPTION: 10,
        MAX_CONSUMPTION_THRESHOLD: 50,
        MIN_CONSUMPTION_THRESHOLD: 2,
        ANOMALY_THRESHOLD: 0.15,
        MIN_TIME_BETWEEN_REFILLS: 1,
        MAX_DAILY_DISTANCE: 1000,
        STATISTICAL_CONFIDENCE_MIN_SAMPLES: 3,
        ODOMETER_ROLLBACK_THRESHOLD: 10000
    };

    const commonClass = 'bg-indigo-500 text-white py-1 px-2 rounded-md hover:bg-indigo-700 transition-all duration-300 text-sm';

    // Helper functions
    const createFilterElement = (type, id, placeholder = '') => {
        const element = $(`<${type}>`, {
            id: `summary13-${id}`,
            class: commonClass,
            placeholder: placeholder
        });
        if (type === 'select') {
            element.append('<option value="">Wszystkie ' + placeholder + '</option>');
        }
        return element;
    };

    const sanitizeNumericValue = (value, defaultValue = 0) => {
        if (value === null || value === undefined || value === '') return defaultValue;
        const cleaned = typeof value === 'string' ? value.replace(/[^\d,.-]/g, '').replace(',', '.') : value;
        const parsed = parseFloat(cleaned);
        return isNaN(parsed) ? defaultValue : parsed;
    };

    const isValidDate = (date) => date instanceof Date && !isNaN(date.getTime());

    const calculateStatistics = (values) => {
        if (!values || values.length === 0) return null;
        
        const sorted = [...values].sort((a, b) => a - b);
        const mean = sorted.reduce((sum, val) => sum + val, 0) / sorted.length;
        
        const variance = sorted.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / sorted.length;
        const stdDev = Math.sqrt(variance);
        
        const median = sorted.length % 2 === 0 
            ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
            : sorted[Math.floor(sorted.length / 2)];
            
        const q1 = sorted[Math.floor(sorted.length * 0.25)];
        const q3 = sorted[Math.floor(sorted.length * 0.75)];
        const iqr = q3 - q1;
        
        return { mean, median, stdDev, q1, q3, iqr, count: sorted.length };
    };

    const removeOutliers = (values, method = 'iqr') => {
        if (!values || values.length < CONFIG.STATISTICAL_CONFIDENCE_MIN_SAMPLES) return values;
        
        const stats = calculateStatistics(values);
        if (!stats) return values;
        
        if (method === 'iqr') {
            const lowerBound = stats.q1 - 1.5 * stats.iqr;
            const upperBound = stats.q3 + 1.5 * stats.iqr;
            return values.filter(val => val >= lowerBound && val <= upperBound);
        } else {
            const threshold = 2 * stats.stdDev;
            return values.filter(val => Math.abs(val - stats.mean) <= threshold);
        }
    };

    // Create UI elements
    const filtersDiv = $('<div>', { id: 'summary13-filters', class: 'mb-5 flex flex-wrap gap-2' });
    const registrationSearchInput = createFilterElement('input', 'registration-search', "Szukaj Nr rejestracyjny (u≈ºyj ';' aby rozdzieliƒá numery)");
    const registrationFilterSelect = createFilterElement('select', 'registration-filter', 'numery rejestracyjne');
    const yearFilterSelect = createFilterElement('select', 'year-filter', 'lata');

    const createDateInput = (id, placeholder) => {
        const wrapper = $('<div>', { class: 'relative' });
        const input = createFilterElement('input', id, placeholder).attr('type', 'date');
        const icon = $('<span>', {
            class: 'absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 pointer-events-none'
        }).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 4h10M5 11h14M5 16h14M5 21h14"/></svg>');
        return wrapper.append(icon, input);
    };

    const dateFromWrapper = createDateInput('date-from', 'Data od');
    const dateToWrapper = createDateInput('date-to', 'Data do');
    
    // Dodaj prze≈ÇƒÖcznik grupowania wierszy
    const toggleRowGroupBtn = $('<button>', {
        id: 'toggle-rowgroup-btn',
        class: `${commonClass} ml-2 bg-yellow-500 hover:bg-yellow-700`,
        text: 'Grupowanie: W≈ÇƒÖczone'
    });
    
    const toggleColumnsBtn = $('<button>', {
        id: 'toggle-columns-btn',
        class: `${commonClass} ml-2`,
        text: 'Ukryj kolumny'
    });

    // Przyciski prze≈ÇƒÖczania widok√≥w
    const yearlyViewBtn = $('<button>', {
        id: 'yearly-view-btn',
        class: `${commonClass} ml-2 bg-green-500 hover:bg-green-700`,
        text: 'Podsumowanie roczne'
    });

    const detailViewBtn = $('<button>', {
        id: 'detail-view-btn',
        class: `${commonClass} ml-2 bg-blue-500 hover:bg-blue-700`,
        text: 'Widok szczeg√≥≈Çowy',
        style: 'display: none;'
    });

    filtersDiv.append(
        registrationSearchInput, registrationFilterSelect, yearFilterSelect,
        dateFromWrapper, dateToWrapper, toggleRowGroupBtn, yearlyViewBtn, detailViewBtn,
        $('<div>', { class: 'w-full' }), toggleColumnsBtn
    );

    container.append(filtersDiv);

    // Kontenery na kolumny i tabele
    const columnsCheckboxesDiv = $('<div>', {
        id: 'columns-checkboxes',
        class: 'mt-2',
        css: { display: 'none', background: '#f9f9f9', padding: '10px', border: '1px solid #ccc' }
    });
    container.append(columnsCheckboxesDiv);

    // Kontener na tabelƒô szczeg√≥≈ÇowƒÖ
    const detailTableContainer = $('<div>', {
        id: 'summary13-detail-container'
    });
    const detailTableElement = $('<table>', {
        id: 'Summary13DetailTable',
        class: 'display',
        style: 'width:100%'
    });
    detailTableContainer.append(detailTableElement);
    container.append(detailTableContainer);

    // Kontener na tabelƒô rocznƒÖ
    const yearlyTableContainer = $('<div>', {
        id: 'summary13-yearly-container',
        style: 'display: none;'
    });
    const yearlyTableElement = $('<table>', {
        id: 'Summary13YearlyTable',
        class: 'display',
        style: 'width:100%'
    });
    yearlyTableContainer.append(yearlyTableElement);
    container.append(yearlyTableContainer);

    // Data processing
    const rawData = jsonData.slice(1)
        .filter(row => CONFIG.FUEL_GROUPS.includes(row[columnIndices['Grupa prod']]))
        .map(row => ({
            regNumber: row[columnIndices['Nr rejestracyjny']] || '',
            date: new Date(row[columnIndices['Data realizacji']]),
            group: row[columnIndices['Grupa prod']] || '',
            quantity: sanitizeNumericValue(row[columnIndices['Ilo≈õƒá']]),
            odometer: sanitizeNumericValue(row[columnIndices['Licznik']], null),
            netValue: sanitizeNumericValue(row[columnIndices['Warto≈õƒá netto']]),
            location: row[columnIndices['Miejscowo≈õƒá']] || '',
            costData: row[columnIndices['Dane kosztowe']] || '',
            originalRow: row
        }))
        .filter(row => 
            row.regNumber && 
            isValidDate(row.date) && 
            row.quantity > 0 && 
            row.netValue >= 0
        )
        .sort((a, b) => {
            const dateCompare = a.date - b.date;
            return dateCompare !== 0 ? dateCompare : a.regNumber.localeCompare(b.regNumber);
        });

    // Enhanced vehicle data processing
    const vehicleProfiles = {};
    const processedData = [];
    const dataQualityFlags = {};
    
    // Nowy obiekt do przechowywania statystyk rocznych
    const yearlyStatistics = {};

    // First pass: Build vehicle profiles and detect anomalies
    rawData.forEach((row, index) => {
        const { regNumber, date, quantity, odometer } = row;
        const year = date.getFullYear();
        
        if (!vehicleProfiles[regNumber]) {
            vehicleProfiles[regNumber] = {
                entries: [],
                odometerHistory: [],
                consumptionHistory: [],
                statistics: null,
                hasReliableOdometer: false,
                yearlyConsumption: {} // Dodane: przechowuje dane spalania per rok
            };
        }

        const profile = vehicleProfiles[regNumber];
        profile.entries.push({ ...row, index });

        // Inicjalizuj dane roczne je≈õli nie istniejƒÖ
        if (!profile.yearlyConsumption[year]) {
            profile.yearlyConsumption[year] = [];
        }

        // Validate and process odometer readings
        if (odometer !== null && odometer > 0) {
            const lastOdometer = profile.odometerHistory.length > 0 
                ? profile.odometerHistory[profile.odometerHistory.length - 1] 
                : null;

            let isValidOdometer = true;
            let odometerFlags = [];

            if (lastOdometer) {
                const odometerDiff = odometer - lastOdometer.reading;
                const daysDiff = (date - lastOdometer.date) / (1000 * 60 * 60 * 24);
                const dailyDistance = daysDiff > 0 ? odometerDiff / daysDiff : 0;

                // Check for odometer rollback or unrealistic values
                if (odometerDiff < 0 && Math.abs(odometerDiff) < CONFIG.ODOMETER_ROLLBACK_THRESHOLD) {
                    odometerFlags.push('potential_rollback');
                    isValidOdometer = false;
                } else if (dailyDistance > CONFIG.MAX_DAILY_DISTANCE) {
                    odometerFlags.push('excessive_daily_distance');
                    isValidOdometer = false;
                } else if (odometerDiff > 0 && daysDiff >= CONFIG.MIN_TIME_BETWEEN_REFILLS) {
                    // Valid distance calculation
                    const consumption = (quantity / odometerDiff) * 100;
                    
                    if (consumption >= CONFIG.MIN_CONSUMPTION_THRESHOLD && 
                        consumption <= CONFIG.MAX_CONSUMPTION_THRESHOLD &&
                        odometerDiff >= CONFIG.MIN_DISTANCE_FOR_CONSUMPTION) {
                        profile.consumptionHistory.push({
                            consumption,
                            distance: odometerDiff,
                            date,
                            quantity,
                            index,
                            year // Dodane: zapisz rok
                        });
                        
                        // Dodaj do danych rocznych
                        profile.yearlyConsumption[year].push(consumption);
                    }
                }
            }

            if (isValidOdometer) {
                profile.odometerHistory.push({
                    reading: odometer,
                    date,
                    index,
                    flags: odometerFlags
                });
                profile.hasReliableOdometer = true;
            }
        }

        dataQualityFlags[index] = {
            hasValidOdometer: odometer !== null && odometer > 0,
            odometerFlags: [],
            isEstimated: false,
            isAnomalous: false,
            confidenceLevel: 'unknown'
        };
    });

    // Oblicz statystyki roczne dla ka≈ºdego pojazdu
    Object.keys(vehicleProfiles).forEach(regNumber => {
        const profile = vehicleProfiles[regNumber];
        
        // Oblicz statystyki og√≥lne (dla ca≈Çego okresu)
        if (profile.consumptionHistory.length >= CONFIG.STATISTICAL_CONFIDENCE_MIN_SAMPLES) {
            const consumptions = profile.consumptionHistory.map(entry => entry.consumption);
            const cleanedConsumptions = removeOutliers(consumptions, 'iqr');
            profile.statistics = calculateStatistics(cleanedConsumptions);
        }
        
        // Oblicz statystyki roczne
        Object.keys(profile.yearlyConsumption).forEach(year => {
            const yearConsumptions = profile.yearlyConsumption[year];
            if (yearConsumptions.length >= CONFIG.STATISTICAL_CONFIDENCE_MIN_SAMPLES) {
                const cleanedYearlyConsumptions = removeOutliers(yearConsumptions, 'iqr');
                const yearStats = calculateStatistics(cleanedYearlyConsumptions);
                
                const key = `${regNumber}_${year}`;
                yearlyStatistics[key] = yearStats;
            }
        });
    });

    // Second pass: Process entries with yearly statistics
    Object.keys(vehicleProfiles).forEach(regNumber => {
        const profile = vehicleProfiles[regNumber];

        // Process each entry for the vehicle
        profile.entries.forEach((entry, entryIndex) => {
            const { regNumber, date, group, quantity, odometer, netValue, location, costData, index } = entry;
            const year = date.getFullYear();
            
            let distance = null;
            let consumption = null;
            let avgConsumption = null;
            let fuelDifference = null;
            let estimatedOdometer = odometer;
            let flags = dataQualityFlags[index];

            // Calculate distance and consumption
            if (entryIndex > 0 && profile.hasReliableOdometer) {
                const prevEntry = profile.entries[entryIndex - 1];
                const prevOdometerEntry = profile.odometerHistory.find(h => h.index === prevEntry.index);
                const currentOdometerEntry = profile.odometerHistory.find(h => h.index === index);

                if (prevOdometerEntry && currentOdometerEntry) {
                    distance = currentOdometerEntry.reading - prevOdometerEntry.reading;
                    
                    if (distance > CONFIG.MIN_DISTANCE_FOR_CONSUMPTION) {
                        consumption = (quantity / distance) * 100;
                        flags.confidenceLevel = 'high';
                    }
                } else if (!currentOdometerEntry && profile.statistics) {
                    // Estimate distance based on average consumption
                    distance = (quantity / profile.statistics.mean) * 100;
                    consumption = profile.statistics.mean;
                    flags.isEstimated = true;
                    flags.confidenceLevel = 'estimated';
                    
                    // Estimate odometer reading
                    if (prevOdometerEntry) {
                        estimatedOdometer = prevOdometerEntry.reading + distance;
                    }
                }
            }

            // Get YEARLY average consumption instead of overall average
            const yearlyStatsKey = `${regNumber}_${year}`;
            const yearStats = yearlyStatistics[yearlyStatsKey];
            
            if (yearStats && yearStats.count >= CONFIG.STATISTICAL_CONFIDENCE_MIN_SAMPLES) {
                avgConsumption = yearStats.mean;
                flags.confidenceLevel = flags.confidenceLevel === 'unknown' ? 'medium' : flags.confidenceLevel;
                
                // Calculate fuel difference based on yearly average
                if (consumption !== null && distance !== null) {
                    const expectedFuel = (avgConsumption * distance) / 100;
                    fuelDifference = quantity - expectedFuel;
                }
                
                // Mark anomalous entries based on yearly statistics
                if (consumption !== null && !flags.isEstimated) {
                    const deviation = Math.abs(consumption - yearStats.mean) / yearStats.mean;
                    if (deviation > CONFIG.ANOMALY_THRESHOLD) {
                        flags.isAnomalous = true;
                    }
                }
            }

            // Create processed row
            const processedRow = [
                regNumber,
                date.toISOString().split('T')[0],
                group,
                quantity.toFixed(2),
                estimatedOdometer !== null ? estimatedOdometer.toFixed(0) : 'b.d.',
                distance !== null ? distance.toFixed(0) : 'b.d.',
                consumption !== null ? consumption.toFixed(2) : 'b.d.',
                avgConsumption !== null ? avgConsumption.toFixed(2) : 'b.d.', // Teraz to jest ≈õrednia roczna
                flags.isAnomalous,
                fuelDifference !== null ? fuelDifference.toFixed(2) : 'b.d.',
                netValue.toFixed(2),
                location,
                flags.isEstimated, // Odometer estimated
                flags.isEstimated, // Distance estimated
                flags.isEstimated, // Consumption estimated
                costData,
                flags.confidenceLevel // New column for data confidence
            ];

            processedData.push(processedRow);
        });
    });

    // Funkcja generujƒÖca dane roczne
    function generateYearlyData() {
        const yearlyData = {};
        
        processedData.forEach(row => {
            const regNumber = row[0];
            const date = new Date(row[1]);
            const year = date.getFullYear();
            const group = row[2];
            const quantity = parseFloat(row[3]);
            const distance = parseFloat(row[5]);
            const consumption = parseFloat(row[6]);
            const netValue = parseFloat(row[10]);
            const costData = row[15]; // Dane kosztowe
            const key = `${regNumber}_${year}_${group}`;
            
            if (!yearlyData[key]) {
                yearlyData[key] = {
                    regNumber,
                    year,
                    group,
                    totalQuantity: 0,
                    totalDistance: 0,
                    totalNetValue: 0,
                    consumptionValues: [],
                    refillCount: 0,
                    firstDate: date,
                    lastDate: date,
                    odometerStart: null,
                    odometerEnd: null,
                    costDataSet: new Set() // U≈ºywamy Set do przechowywania unikalnych warto≈õci
                };
            }
            
            const entry = yearlyData[key];
            entry.totalQuantity += quantity;
            entry.totalNetValue += netValue;
            entry.refillCount++;
            
            // Zbierz dane kosztowe
            if (costData) {
                entry.costDataSet.add(costData);
            }
            
            if (!isNaN(distance) && distance > 0) {
                entry.totalDistance += distance;
            }
            
            if (!isNaN(consumption) && consumption > 0) {
                entry.consumptionValues.push(consumption);
            }
            
            if (date < entry.firstDate) entry.firstDate = date;
            if (date > entry.lastDate) entry.lastDate = date;
            
            // Pobierz odczyty licznika
            const odometer = parseFloat(row[4]);
            if (!isNaN(odometer) && odometer > 0) {
                if (entry.odometerStart === null || odometer < entry.odometerStart) {
                    entry.odometerStart = odometer;
                }
                if (entry.odometerEnd === null || odometer > entry.odometerEnd) {
                    entry.odometerEnd = odometer;
                }
            }
        });
        
        // Konwertuj na tablicƒô i oblicz ≈õrednie
        return Object.values(yearlyData).map(entry => {
            // Oblicz rzeczywiste ≈õrednie spalanie na podstawie sumy paliwa i dystansu
            const avgConsumption = entry.totalDistance > 0 
                ? (entry.totalQuantity / entry.totalDistance) * 100
                : null;
            
            const actualDistance = entry.odometerStart !== null && entry.odometerEnd !== null 
                ? entry.odometerEnd - entry.odometerStart
                : entry.totalDistance;
            
            const monthsSpan = (entry.lastDate.getFullYear() - entry.firstDate.getFullYear()) * 12 + 
                            (entry.lastDate.getMonth() - entry.firstDate.getMonth()) + 1;
            
            // Po≈ÇƒÖcz unikalne dane kosztowe
            const costDataCombined = Array.from(entry.costDataSet).join('; ');
            
            return [
                entry.regNumber,
                entry.year,
                entry.group,
                entry.totalQuantity.toFixed(2),
                actualDistance > 0 ? actualDistance.toFixed(0) : 'b.d.',
                avgConsumption !== null ? avgConsumption.toFixed(2) : 'b.d.',
                entry.totalNetValue.toFixed(2),
                entry.refillCount,
                entry.firstDate.toISOString().split('T')[0],
                entry.lastDate.toISOString().split('T')[0],
                monthsSpan,
                entry.odometerStart !== null ? entry.odometerStart.toFixed(0) : 'b.d.',
                entry.odometerEnd !== null ? entry.odometerEnd.toFixed(0) : 'b.d.',
                costDataCombined // Dodana kolumna z danymi kosztowymi
            ];
        }).sort((a, b) => {
            const regCompare = a[0].localeCompare(b[0]);
            return regCompare !== 0 ? regCompare : b[1] - a[1];
        });
    }

    // Generujemy dane roczne raz na poczƒÖtku
    const yearlyData = generateYearlyData();
    
    let detailTable = null;
    let yearlyTable = null;
    let isRowGroupEnabled = true;  // Domy≈õlnie grupowanie jest w≈ÇƒÖczone

    // Enhanced rendering functions
    const renderWithConfidence = (data, type, row, columnIndex) => {
        if (type !== 'display') return data;
        
        const confidence = row[16]; // Confidence level column
        const isEstimated = row[12 + (columnIndex - 4)]; // Adjust for estimated flags
        
        let color = 'black';
        let style = '';
        
        if (isEstimated) {
            color = 'purple';
            style = 'font-weight: bold; font-style: italic;';
        } else if (confidence === 'high') {
            color = 'green';
        } else if (confidence === 'medium') {
            color = 'orange';
        } else if (confidence === 'low') {
            color = 'red';
        }
        
        return `<span style="color: ${color}; ${style}" title="Confidence: ${confidence}">${data}</span>`;
    };

    const renderConsumption = (data, type, row) => {
        if (type !== 'display') return data;
        
        const avgYearlyConsumption = parseFloat(row[7]);
        const consumption = parseFloat(data);
        const isAnomalous = row[8];
        const isEstimated = row[14];
        
        let color = 'black';
        let style = '';
        
        if (isEstimated) {
            color = 'purple';
            style = 'font-weight: bold; font-style: italic;';
        } else if (isAnomalous && !isNaN(consumption) && !isNaN(avgYearlyConsumption)) {
            color = consumption > avgYearlyConsumption ? 'red' : 'green';
            style = 'font-weight: bold;';
        }
        
        const confidenceTitle = `Confidence: ${row[16] || 'unknown'}`;
        return `<span style="color: ${color}; ${style}" title="${confidenceTitle}">${data}</span>`;
    };

    const renderDifference = (data, type, row) => {
        if (type !== 'display') return data;
        
        const difference = parseFloat(data);
        if (isNaN(difference)) return data;
        
        const color = difference > 0 ? 'red' : 'green';
        const confidenceTitle = `Confidence: ${row[16] || 'unknown'}`;
        
        return `<span style="color: ${color}; font-weight: bold;" title="${confidenceTitle}">${difference.toFixed(2)}</span>`;
    };

    // Funkcja renderujƒÖca nag≈Ç√≥wek grupy dla tabeli szczeg√≥≈Çowej - POPRAWIONA
    function detailRowGroupRender(rows, group, level) {
        if (level === 0) {
            return $('<tr/>').append('<td colspan="13">' + group + '</td>');
        } else if (level === 1) {
            const regNumber = rows.data()[0][0];
            const year = group;
            
            const visibleRows = rows.nodes().toArray().filter(node => $(node).is(':visible'));
            const visibleData = visibleRows.map(node => detailTable.row(node).data());
            
            const totals = visibleData.reduce((acc, row) => {
                return {
                    quantity: acc.quantity + (parseFloat(row[3]) || 0),
                    distance: acc.distance + (parseFloat(row[5]) || 0),
                    difference: acc.difference + (parseFloat(row[9]) || 0),
                    netValue: acc.netValue + (parseFloat(row[10]) || 0)
                };
            }, { quantity: 0, distance: 0, difference: 0, netValue: 0 });

            // Oblicz rzeczywiste ≈õrednie spalanie dla grupy
            const groupAvgConsumption = totals.distance > 0 ? (totals.quantity / totals.distance) * 100 : null;

            return $('<tr/>').append(
                `<td colspan="2"><strong>${regNumber} - ${year}</strong></td>` +
                `<td></td>` +
                `<td class="text-left">${totals.quantity.toFixed(2)}</td>` +
                `<td></td>` +
                `<td class="text-left">${totals.distance > 0 ? totals.distance.toFixed(0) : 'b.d.'}</td>` +
                `<td></td>` +
                `<td class="text-left">${groupAvgConsumption !== null ? groupAvgConsumption.toFixed(2) : 'b.d.'}</td>` +
                `<td class="text-left">${totals.difference !== 0 ? totals.difference.toFixed(2) : 'b.d.'}</td>` +
                `<td class="text-left">${totals.netValue.toFixed(2)}</td>` +
                `<td></td><td></td><td></td>`
            );
        }
    }

    // Funkcja renderujƒÖca nag≈Ç√≥wek grupy dla tabeli rocznej
    function yearlyRowGroupRender(rows, group) {
        const visibleRows = rows.nodes().toArray().filter(node => $(node).is(':visible'));
        const visibleData = visibleRows.map(node => yearlyTable.row(node).data());
        
        const totals = visibleData.reduce((acc, row) => {
            return {
                quantity: acc.quantity + (parseFloat(row[3]) || 0),
                distance: acc.distance + (parseFloat(row[4]) || 0),
                netValue: acc.netValue + (parseFloat(row[6]) || 0),
                refillCount: acc.refillCount + (parseInt(row[7]) || 0)
            };
        }, { quantity: 0, distance: 0, netValue: 0, refillCount: 0 });

        const avgConsumption = totals.distance > 0 ? (totals.quantity / totals.distance) * 100 : 0;

        return $('<tr/>').append(
            `<td colspan="1"><strong>${group}</strong></td>` +
            `<td></td>` +
            `<td></td>` +
            `<td class="text-left">${totals.quantity.toFixed(2)}</td>` +
            `<td class="text-left">${totals.distance > 0 ? totals.distance.toFixed(0) : 'b.d.'}</td>` +
            `<td class="text-left">${avgConsumption > 0 ? avgConsumption.toFixed(2) : 'b.d.'}</td>` +
            `<td class="text-left">${totals.netValue.toFixed(2)}</td>` +
            `<td class="text-left">${totals.refillCount}</td>` +
            `<td></td><td></td><td></td><td></td><td></td><td></td>` // Dodatkowe puste miejsce dla kolumny "Dane kosztowe"
        );
    }

    // Inicjalizacja tabeli szczeg√≥≈Çowej
    function initializeDetailTable() {
        const options = {
            data: processedData,
            columns: [
                { title: 'Nr rejestracyjny', data: 0 },
                { title: 'Data realizacji', data: 1 },
                { title: 'Grupa prod', data: 2 },
                { title: 'Ilo≈õƒá', data: 3 },
                { title: 'Licznik', data: 4, render: (data, type, row) => renderWithConfidence(data, type, row, 4) },
                { title: 'Dystans (km)', data: 5, render: (data, type, row) => renderWithConfidence(data, type, row, 5) },
                { title: 'Spalanie (l/100km)', data: 6, render: renderConsumption },
                { title: '≈ör. r. (l/100 km)', data: 7 },
                { title: 'R√≥≈ºnica (l)', data: 9, render: renderDifference },
                { title: 'Warto≈õƒá netto', data: 10 },
                { title: 'Miejscowo≈õƒá', data: 11 },
                { title: 'Dane kosztowe', data: 15 },
                { title: 'Pewno≈õƒá danych', data: 16, visible: false }
            ],
            dom: '<"ex-buttons"Bf>lrtip',
            buttons: [
                {
                    extend: 'collection',
                    text: 'Export',
                    buttons: [
                        'csv',
                        'excel',
                        {
                            extend: 'pdfHtml5',
                            text: 'PDF',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            exportOptions: { columns: ':visible' },
                            customize: function (doc) {
                                doc.defaultStyle.fontSize = 8;
                                doc.styles.tableHeader.fontSize = 9;
                                doc.content[1].table.widths = new Array(doc.content[1].table.body[0].length).fill('*');
                            }
                        }
                    ]
                }
            ],
            paging: true,
            pageLength: 20,
            searching: true,
            info: false,
            order: [[0, 'asc'], [1, 'asc']]
        };

        // Dodaj grupowanie je≈õli jest w≈ÇƒÖczone
        if (isRowGroupEnabled) {
            options.rowGroup = {
                dataSrc: [0, function(row) {
                    return new Date(row[1]).getFullYear();
                }],
                startRender: detailRowGroupRender
            };
        }

        if (detailTable) {
            detailTable.destroy();
        }

        detailTable = $('#Summary13DetailTable').DataTable(options);
    }

    // Inicjalizacja tabeli rocznej
    function initializeYearlyTable() {
        const options = {
            data: yearlyData,
            columns: [
                { title: 'Nr rejestracyjny', data: 0 },
                { title: 'Rok', data: 1 },
                { title: 'Grupa prod', data: 2 },
                { title: '≈ÅƒÖczna ilo≈õƒá (l)', data: 3 },
                { title: '≈ÅƒÖczny dystans (km)', data: 4 },
                { title: '≈ör. spalanie (l/100km)', data: 5 },
                { title: '≈ÅƒÖczna warto≈õƒá netto', data: 6 },
                { title: 'Liczba tankowa≈Ñ', data: 7 },
                { title: 'Pierwszy wpis', data: 8 },
                { title: 'Ostatni wpis', data: 9 },
                { title: 'Okres (miesiƒÖce)', data: 10 },
                { title: 'Licznik poczƒÖtkowy', data: 11 },
                { title: 'Licznik ko≈Ñcowy', data: 12 },
                { title: 'Dane kosztowe', data: 13 } // Dodana kolumna
            ],
            dom: '<"ex-buttons"Bf>lrtip',
            buttons: [
                {
                    extend: 'collection',
                    text: 'Export',
                    buttons: [
                        'csv',
                        'excel',
                        {
                            extend: 'pdfHtml5',
                            text: 'PDF',
                            orientation: 'landscape',
                            pageSize: 'A4',
                            exportOptions: { columns: ':visible' },
                            customize: function (doc) {
                                doc.defaultStyle.fontSize = 8;
                                doc.styles.tableHeader.fontSize = 9;
                                doc.content[1].table.widths = new Array(doc.content[1].table.body[0].length).fill('*');
                            }
                        }
                    ]
                }
            ],
            paging: true,
            pageLength: 20,
            searching: true,
            info: false,
            order: [[0, 'asc'], [1, 'desc']]
        };

        // Dodaj grupowanie je≈õli jest w≈ÇƒÖczone
        if (isRowGroupEnabled) {
            options.rowGroup = {
                dataSrc: 0,
                startRender: yearlyRowGroupRender
            };
        }

        if (yearlyTable) {
            yearlyTable.destroy();
        }

        yearlyTable = $('#Summary13YearlyTable').DataTable(options);
    }

    // Populate filter dropdowns
    const uniqueRegistrations = [...new Set(processedData.map(row => row[0]))].sort();
    const uniqueYears = [...new Set(processedData.map(row => new Date(row[1]).getFullYear()))].sort((a, b) => b - a);

    uniqueRegistrations.forEach(reg => {
        registrationFilterSelect.append(`<option value="${reg}">${reg}</option>`);
    });

    uniqueYears.forEach(year => {
        yearFilterSelect.append(`<option value="${year}">${year}</option>`);
    });

    // Event handlers for view switching
    yearlyViewBtn.on('click', function() {
        detailTableContainer.hide();
        yearlyTableContainer.show();
        $(this).hide();
        detailViewBtn.show();
        
        // Od≈õwie≈º checkboxy kolumn dla widoku rocznego
        updateColumnCheckboxes('yearly');
    });

    detailViewBtn.on('click', function() {
        yearlyTableContainer.hide();
        detailTableContainer.show();
        $(this).hide();
        yearlyViewBtn.show();
        
        // Od≈õwie≈º checkboxy kolumn dla widoku szczeg√≥≈Çowego
        updateColumnCheckboxes('detail');
    });

    // Szybki prze≈ÇƒÖcznik grupowania wierszy
    toggleRowGroupBtn.on('click', function() {
        // Poka≈º wska≈∫nik ≈Çadowania
        const loadingIndicator = $('<div>', {
            id: 'rowgroup-loading',
            class: 'text-center py-2 px-4 bg-blue-100 text-blue-800 rounded ml-2',
            html: '<span class="spinner-border spinner-border-sm mr-2"></span>Aktualizacja widoku...'
        });
        $(this).after(loadingIndicator);
        $(this).prop('disabled', true);
        
        // Op√≥≈∫nij aktualizacjƒô, aby UI m√≥g≈Ç siƒô od≈õwie≈ºyƒá
        setTimeout(() => {
            isRowGroupEnabled = !isRowGroupEnabled;
            $(this).text(`Grupowanie: ${isRowGroupEnabled ? 'W≈ÇƒÖczone' : 'Wy≈ÇƒÖczone'}`);
            
            // Aktualizuj tylko aktywnƒÖ tabelƒô
            const isYearlyVisible = yearlyTableContainer.is(':visible');
            
            if (isYearlyVisible) {
                // Reinicjalizuj tabelƒô rocznƒÖ
                initializeYearlyTable();
            } else {
                // Reinicjalizuj tabelƒô szczeg√≥≈ÇowƒÖ
                initializeDetailTable();
            }
            
            // Zastosuj filtry
            applyFilters();
            
            // Przywr√≥ƒá widoczno≈õƒá kolumn
            updateColumnVisibility();
            
            // Usu≈Ñ wska≈∫nik ≈Çadowania
            $('#rowgroup-loading').remove();
            $(this).prop('disabled', false);
        }, 50);
    });

    // Filter functionality
    function applyFilters() {
        const regSearchValue = $('#summary13-registration-search').val().toLowerCase();
        const regFilterValue = $('#summary13-registration-filter').val();
        const yearFilterValue = $('#summary13-year-filter').val();
        const dateFromValue = $('#summary13-date-from').val();
        const dateToValue = $('#summary13-date-to').val();

        // Funkcja filtrujƒÖca - u≈ºywana dla obu tabel
        const filterFunction = function(settings, data, dataIndex) {
            const regNumber = data[0].toLowerCase();
            
            // Dla tabeli rocznej, data jest w kolumnach 8 i 9, a rok w kolumnie 1
            const isYearlyTable = settings.nTable.id === 'Summary13YearlyTable';
            const dataYear = isYearlyTable ? data[1].toString() : new Date(data[1]).getFullYear().toString();
            const dataDate = isYearlyTable ? new Date(data[8]) : new Date(data[1]);

            // Registration search filter (semicolon separated)
            if (regSearchValue) {
                const searchTerms = regSearchValue.split(';').map(term => term.trim()).filter(term => term.length > 0);
                if (searchTerms.length > 0 && !searchTerms.some(term => regNumber.includes(term))) {
                    return false;
                }
            }

            // Registration dropdown filter
            if (regFilterValue && data[0] !== regFilterValue) {
                return false;
            }

            // Year filter
            if (yearFilterValue && dataYear !== yearFilterValue) {
                return false;
            }

            // Date range filter
            if (dateFromValue && dataDate < new Date(dateFromValue)) {
                return false;
            }

            if (dateToValue && dataDate > new Date(dateToValue)) {
                return false;
            }

            return true;
        };

        // Zastosuj filtr do obu tabel
        $.fn.dataTable.ext.search.push(filterFunction);
        
        if (detailTable) detailTable.draw();
        if (yearlyTable) yearlyTable.draw();
        
        $.fn.dataTable.ext.search.pop();
    }

    // Attach filter event handlers
    $('#summary13-registration-search, #summary13-registration-filter, #summary13-year-filter, #summary13-date-from, #summary13-date-to')
        .on('input change', applyFilters);

    // Definicje kolumn dla obu tabel
    const detailColumns = [
        { title: 'Nr rejestracyjny', visible: true },
        { title: 'Data realizacji', visible: true },
        { title: 'Grupa prod', visible: true },
        { title: 'Ilo≈õƒá', visible: true },
        { title: 'Licznik', visible: true },
        { title: 'Dystans (km)', visible: true },
        { title: 'Spalanie (l/100km)', visible: true },
        { title: '≈ör. r. (l/100 km)', visible: true },
        { title: 'R√≥≈ºnica (l)', visible: true },
        { title: 'Warto≈õƒá netto', visible: true },
        { title: 'Miejscowo≈õƒá', visible: true },
        { title: 'Dane kosztowe', visible: true }
    ];

    const yearlyColumns = [
        { title: 'Nr rejestracyjny', visible: true },
        { title: 'Rok', visible: true },
        { title: 'Grupa prod', visible: true },
        { title: '≈ÅƒÖczna ilo≈õƒá (l)', visible: true },
        { title: '≈ÅƒÖczny dystans (km)', visible: true },
        { title: '≈ör. spalanie (l/100km)', visible: true },
        { title: '≈ÅƒÖczna warto≈õƒá netto', visible: true },
        { title: 'Liczba tankowa≈Ñ', visible: true },
        { title: 'Pierwszy wpis', visible: true },
        { title: 'Ostatni wpis', visible: true },
        { title: 'Okres (miesiƒÖce)', visible: true },
        { title: 'Licznik poczƒÖtkowy', visible: true },
        { title: 'Licznik ko≈Ñcowy', visible: true },
        { title: 'Dane kosztowe', visible: true } // Dodana kolumna
    ];

    // Zmienne przechowujƒÖce stan widoczno≈õci kolumn
    const detailColumnsVisibility = {};
    const yearlyColumnsVisibility = {};

    // Funkcja do aktualizacji checkbox√≥w dla aktualnego widoku
    function updateColumnCheckboxes(view = 'detail') {
        columnsCheckboxesDiv.empty();
        
        const columns = view === 'detail' ? detailColumns : yearlyColumns;
        const table = view === 'detail' ? detailTable : yearlyTable;
        
        columns.forEach((col, index) => {
            // Sprawd≈∫ aktualnƒÖ widoczno≈õƒá kolumny
            let isVisible = col.visible;
            
            if (table) {
                const column = table.column(index);
                if (column) {
                    isVisible = column.visible();
                }
            }
            
            // Zapisz stan widoczno≈õci
            if (view === 'detail') {
                detailColumnsVisibility[index] = isVisible;
            } else {
                yearlyColumnsVisibility[index] = isVisible;
            }
            
            const checkbox = $('<input>', {
                type: 'checkbox',
                id: `col-${view}-${index}`,
                'data-column': index,
                'data-view': view,
                checked: isVisible
            });
            
            const label = $('<label>', {
                for: `col-${view}-${index}`,
                text: col.title,
                class: 'ml-1 mr-3'
            });
            
            columnsCheckboxesDiv.append(checkbox, label);
            
            checkbox.on('change', function() {
                const columnIndex = $(this).data('column');
                const isVisible = $(this).prop('checked');
                
                // Zapisz stan widoczno≈õci
                if (view === 'detail') {
                    detailColumnsVisibility[columnIndex] = isVisible;
                } else {
                    yearlyColumnsVisibility[columnIndex] = isVisible;
                }
                
                updateColumnVisibility();
            });
        });
    }

    // Funkcja do aktualizacji widoczno≈õci kolumn
    function updateColumnVisibility() {
        // Sprawd≈∫, kt√≥ry widok jest aktywny
        const isYearlyVisible = yearlyTableContainer.is(':visible');
        const view = isYearlyVisible ? 'yearly' : 'detail';
        const table = isYearlyVisible ? yearlyTable : detailTable;
        const visibilityState = isYearlyVisible ? yearlyColumnsVisibility : detailColumnsVisibility;
        
        // Zastosuj zapisany stan widoczno≈õci
        if (table) {
            Object.keys(visibilityState).forEach(columnIndex => {
                table.column(columnIndex).visible(visibilityState[columnIndex]);
            });
        }
    }

    toggleColumnsBtn.on('click', function() {
        columnsCheckboxesDiv.toggle();
        $(this).text(columnsCheckboxesDiv.is(':visible') ? 'Ukryj kolumny' : 'Poka≈º kolumny');
        
        // Od≈õwie≈º checkboxy dla aktualnego widoku
        if (columnsCheckboxesDiv.is(':visible')) {
            const view = yearlyTableContainer.is(':visible') ? 'yearly' : 'detail';
            updateColumnCheckboxes(view);
        }
    });

    // Inicjalizuj tabele
    initializeDetailTable();
    initializeYearlyTable();
    
    // Inicjalizuj checkboxy kolumn dla widoku szczeg√≥≈Çowego
    updateColumnCheckboxes('detail');
    
    // Zastosuj filtry
    applyFilters();

    // Add data quality summary
    const qualityInfo = $('<div>', {
        class: 'mt-4 p-3 bg-gray-100 rounded-lg text-sm',
        html: `
            <h4 class="font-bold mb-2">Legenda jako≈õci danych:</h4>
            <ul class="list-disc list-inside space-y-1">
                <li><span style="color: green;">Zielony</span> - Dane wysokiej jako≈õci (rzeczywiste odczyty)</li>
                <li><span style="color: orange;">Pomara≈Ñczowy</span> - Dane ≈õredniej jako≈õci</li>
                <li><span style="color: red;">Czerwony</span> - Dane niskiej jako≈õci</li>
                <li><span style="color: purple; font-weight: bold; font-style: italic;">Fioletowy kursywa</span> - Dane szacunkowe</li>
                <li><span style="font-weight: bold;">Pogrubienie</span> - Anomalie w spalaniu</li>
            </ul>
        `
    });
    
    container.append(qualityInfo);
}

function generateAveragePriceSummary() {
    const averagePrices = {};

    // Iteracja po danych i obliczanie sum i ilo≈õci
    jsonData.slice(1).forEach(row => {
        const group = row[columnIndices['Grupa prod']];
        const value = parseFloat(row[columnIndices['Warto≈õƒá netto']]);
        const quantity = parseFloat(row[columnIndices['Ilo≈õƒá']]);
        const date = new Date(row[columnIndices['Data realizacji']]);

        // WyciƒÖgniƒôcie roku i miesiƒÖca
        const year = date.getFullYear();
        const monthIndex = date.getMonth(); // Indeks miesiƒÖca (0 - stycze≈Ñ, 11 - grudzie≈Ñ)
        const key = `${group} - ${year}`; // Unikalny klucz dla produktu i roku

        // Filtrujemy tylko dla wybranych produkt√≥w
        if (["Olej napƒôdowy", "Benzyna", "LPG"].includes(group)) {
            // Inicjalizacja obiektu dla danego klucza
            if (!averagePrices[key]) {
                averagePrices[key] = { months: Array(12).fill(null).map(() => ({ total: 0, quantity: 0 })) };
            }

            if (!isNaN(value) && !isNaN(quantity)) {
                // Dodawanie warto≈õci do odpowiedniego miesiƒÖca
                averagePrices[key].months[monthIndex].total += value;
                averagePrices[key].months[monthIndex].quantity += quantity;
            }
        }
    });

    // Generowanie tabeli podsumowujƒÖcej
    let summaryHtml = '<table id="summary14Table" class="display"><thead><tr><th>Produkt</th><th>Rok</th>';

    // Dodanie nag≈Ç√≥wk√≥w dla skr√≥conych miesiƒôcy
    const months = [
        'Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze',
        'Lip', 'Sie', 'Wrz', 'Pa≈∫', 'Lis', 'Gru'
    ];

    months.forEach(month => {
        summaryHtml += `<th>${month}</th>`;
    });
    summaryHtml += '</tr></thead><tbody>';

    // Wype≈Çnianie danych do tabeli
    for (const [key, data] of Object.entries(averagePrices)) {
        const [product, year] = key.split(' - ');
        summaryHtml += `<tr><td>${product}</td><td>${year}</td>`;

        // Wype≈Çnienie warto≈õci dla miesiƒôcy
        data.months.forEach(monthData => {
            const averagePrice = monthData.quantity > 0 ? (monthData.total / monthData.quantity).toFixed(2) : 0;
            summaryHtml += `<td>${averagePrice}</td>`;
        });

        summaryHtml += '</tr>';
    }

    summaryHtml += '</tbody></table>';

    // Wstawianie tabeli do kontenera
    document.getElementById('summary14-table-container').innerHTML = summaryHtml;

    // Inicjalizacja DataTables z opcjami eksportu
    $('#summary14Table').DataTable({
        paging: false,
        searching: false,
        ordering: true,
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'collection',
                text: 'Export',
                className: 'ex-buttons',
                buttons: [
                    {
                        extend: 'csv',
                        charset: 'UTF-8',
                        bom: true,
                        filename: `Podsumowanie_${new Date().toISOString().replace(/[:\.]/g, '-')}_14`,
                    },
                    { 
                        extend: 'excel', 
                        title: null 
                    },
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape',
                        pageSize: 'A4',
                    }
                ]
            }
        ]
    });
}

let transactionCount = {};
let correctRegistrationNumbers = {};

// Funkcja do zliczania transakcji dla ka≈ºdego Nr rejestracyjny dla danej karty
function calculateTransactionCounts() {
    transactionCount = {};
    correctRegistrationNumbers = {};

    jsonData.slice(1).forEach(row => {
        const cardNumber = row[columnIndices['Nr karty']];
        const registrationNumber = row[columnIndices['Nr rejestracyjny']];
        
        if (!transactionCount[cardNumber]) {
            transactionCount[cardNumber] = {};
        }

        if (!transactionCount[cardNumber][registrationNumber]) {
            transactionCount[cardNumber][registrationNumber] = 0;
        }

        transactionCount[cardNumber][registrationNumber]++;
    });

    // Ustalanie w≈Ça≈õciwego numeru rejestracyjnego
    for (const cardNumber in transactionCount) {
        const regNumbers = transactionCount[cardNumber];
        let maxTransactions = 0;
        let correctRegNumber = '';

        for (const regNumber in regNumbers) {
            if (regNumbers[regNumber] > maxTransactions) {
                maxTransactions = regNumbers[regNumber];
                correctRegNumber = regNumber;
            }
        }
        correctRegistrationNumbers[cardNumber] = correctRegNumber;
    }
}

// Funkcja do generowania zestawienia z pe≈Çnymi danymi
function identifyRegistrationStatus() {
    const summaryData = jsonData.slice(1).map(row => {
        const cardNumber = row[columnIndices['Nr karty']];
        const registrationNumber = row[columnIndices['Nr rejestracyjny']];
        const dateRealization = formatDate(row[columnIndices['Data realizacji']]); // Formatuj datƒô
        const quantity = row[columnIndices['Ilo≈õƒá']];
        const netValue = row[columnIndices['Warto≈õƒá netto']];
        const groupProd = row[columnIndices['Grupa prod']];
        const correctRegNumber = correctRegistrationNumbers[cardNumber];

        return {
            'Nr karty': cardNumber,
            'Nr rejestracyjny': registrationNumber,
            'Data realizacji': dateRealization,
            'Ilo≈õƒá': quantity,
            'Warto≈õƒá netto': netValue,
            'Grupa prod': groupProd,
            'Status': registrationNumber === correctRegNumber ? 'W≈Ça≈õciwy' : 'Inny',
            'W≈Ça≈õciwy Nr rejestracyjny': correctRegNumber
        };
    });

    renderSummaryTable(summaryData);
}

// Funkcja formatujƒÖca datƒô do formatu YYYY-MM-DD
function formatDate(dateString) {
    const date = new Date(dateString);
    if (!isNaN(date.getTime())) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    return dateString; // Zwraca oryginalny ciƒÖg, je≈õli nie mo≈ºna sparsowaƒá daty
}

// Funkcja renderujƒÖca tabelƒô z wynikami
function renderSummaryTable(data) {
    const tableId = 'summary15Table';
    const containerId = 'summary15-table-container';
    const container = $(`#${containerId}`);
    container.empty();

    // Dodaj unikalny przycisk filtr√≥w dla tej tabeli
    if ($(`#toggleFilters_${tableId}`).length === 0) {
        $('#generateSummary15Button').after(`
            <button id="toggleFilters_${tableId}" class="bg-gray-700 text-white py-2 px-4 rounded-md ml-3">
                Poka≈º filtry
            </button>
        `);
    }

    // Dodanie tabeli do kontenera
    container.append(`<table id="${tableId}" class="display" width="100%"></table>`);

    // Usuniƒôcie istniejƒÖcej instancji tabeli, je≈õli istnieje
    if (typeof window.dataTables === 'undefined') {
        window.dataTables = {};
    }
    
    if (window.dataTables[tableId]) {
        window.dataTables[tableId].destroy();
    }

    // Konfiguracja przycisk√≥w eksportu
    const exportButtons = [
        {
            extend: 'excel',
            text: 'Eksport do Excel',
            className: 'bg-green-600 text-white py-2 px-4 rounded-md ml-3',
            title: 'Zestawienie_danych',
            exportOptions: {
                columns: ':visible'
            }
        },
        {
            extend: 'csv',
            text: 'Eksport do CSV',
            className: 'bg-blue-600 text-white py-2 px-4 rounded-md ml-3',
            title: 'Zestawienie_danych',
            exportOptions: {
                columns: ':visible'
            }
        },
        {
            extend: 'pdf',
            text: 'Eksport do PDF',
            className: 'bg-red-600 text-white py-2 px-4 rounded-md ml-3',
            title: 'Zestawienie_danych',
            exportOptions: {
                columns: ':visible'
            }
        }
    ];

    // Generowanie tabeli
    window.dataTables[tableId] = $(`#${tableId}`).DataTable({
        data: data,
        dom: 'Bfrtip',
        buttons: exportButtons,
        columns: [
            { title: 'Nr karty', data: 'Nr karty', width: '10%' },
            { 
                title: 'Nr rejestracyjny', 
                data: 'Nr rejestracyjny', 
                width: '10%',
                render: function(data, type, row) {
                    if (row['Status'] === 'Inny') {
                        return `<span style="color: red;">${data}</span>`;
                    }
                    return data;
                }
            },
            { title: 'Data realizacji', data: 'Data realizacji', width: '15%' },
            { title: 'Ilo≈õƒá', data: 'Ilo≈õƒá', width: '10%' },
            { title: 'Warto≈õƒá netto', data: 'Warto≈õƒá netto', width: '15%' },
            { title: 'Grupa prod', data: 'Grupa prod', width: '10%' },
            { title: 'Status', data: 'Status', width: '10%' },
            { title: 'W≈Ça≈õciwy Nr rejestracyjny', data: 'W≈Ça≈õciwy Nr rejestracyjny', width: '15%' }
        ],
        order: [[2, 'desc']],
        language: {
            paginate: {
                first: "Pierwsza",
                last: "Ostatnia",
                next: "Nastƒôpna",
                previous: "Poprzednia"
            },
            search: "Szukaj:",
            zeroRecords: "Nie znaleziono pasujƒÖcych pozycji",
            lengthMenu: "Poka≈º _MENU_ wierszy",
            info: "Wy≈õwietlono _START_ do _END_ z _TOTAL_ wierszy",
            infoEmpty: "Wy≈õwietlono 0 do 0 z 0 wierszy",
            infoFiltered: "(filtrowanie spo≈õr√≥d _MAX_ wszystkich wierszy)",
            buttons: {
                excel: 'Eksport do Excel',
                csv: 'Eksport do CSV',
                pdf: 'Eksport do PDF'
            }
        },
        info: false,
        lengthChange: true,
        lengthMenu: [[15, 25, 40, 100, -1], [15, 25, 40, 100, "Wszystkie"]],
        initComplete: function() {
            addFiltersToTable(tableId);
        }
    });

    // Obs≈Çuga przycisku "Poka≈º filtry"
    $(`#toggleFilters_${tableId}`).off('click').on('click', function() {
        $(`#${tableId} thead tr.filters`).toggle();
    });
}

// Funkcja dodajƒÖca filtry do nag≈Ç√≥wka tabeli
function addFiltersToTable(tableId) {
    const table = $(`#${tableId}`);
    
    // Dodaj wiersz filtr√≥w do nag≈Ç√≥wka tabeli
    if ($(`#${tableId} thead tr.filters`).length === 0) {
        table.find('thead').append(`<tr class="filters" style="display: none;"></tr>`);
    }
    
    // Dodaj filtry dla ka≈ºdej kolumny
    table.find('thead th').each(function(index) {
        const title = $(this).text();
        const columnIndex = index;
        
        if (title === 'Data realizacji') {
            $(`#${tableId} thead tr.filters`).append(`
                <th>
                    <div style="display: flex; gap: 4px;">
                        <input type="date" 
                            id="${tableId}_minDate_${columnIndex}" 
                            class="filter-input" 
                            style="width: 45%; background-color: #333; color: #fff; border: none; padding: 5px; border-radius: 4px;" 
                            placeholder="Od" />
                        <input type="date" 
                            id="${tableId}_maxDate_${columnIndex}" 
                            class="filter-input" 
                            style="width: 45%; background-color: #333; color: #fff; border: none; padding: 5px; border-radius: 4px;" 
                            placeholder="Do" />
                    </div>
                </th>
            `);
            
            // Dodaj nas≈Çuchiwanie zdarze≈Ñ dla filtr√≥w daty
            $(`#${tableId}_minDate_${columnIndex}, #${tableId}_maxDate_${columnIndex}`).on('change', function() {
                filterByDateRange(tableId, columnIndex);
            });
        } else {
            $(`#${tableId} thead tr.filters`).append(`
                <th>
                    <input type="text" 
                        id="${tableId}_filter_${columnIndex}" 
                        class="filter-input" 
                        style="width: 100%; background-color: #333; color: #fff; border: none; padding: 5px; border-radius: 4px;" />
                </th>
            `);
            
            // Dodaj nas≈Çuchiwanie zdarze≈Ñ dla filtr√≥w tekstowych
            $(`#${tableId}_filter_${columnIndex}`).on('keyup change', function() {
                window.dataTables[tableId]
                    .column(columnIndex)
                    .search(this.value)
                    .draw();
            });
        }
    });
}

// Funkcja pomocnicza do parsowania daty
function parseDate(dateStr) {
    if (!dateStr) return null;
    
    const date = new Date(dateStr);
    if (!isNaN(date.getTime())) {
        date.setHours(0, 0, 0, 0);
        return date;
    }
    return null;
}

// Funkcja filtrowania wed≈Çug zakresu dat
function filterByDateRange(tableId, columnIndex) {
    const minDateStr = $(`#${tableId}_minDate_${columnIndex}`).val();
    const maxDateStr = $(`#${tableId}_maxDate_${columnIndex}`).val();
    
    const minDate = parseDate(minDateStr);
    const maxDate = parseDate(maxDateStr);
    
    if (maxDate) {
        maxDate.setHours(23, 59, 59, 999);
    }

    // Usu≈Ñ poprzedni filtr dla tej tabeli
    if (!window.dateFilters) {
        window.dateFilters = {};
    }
    
    if (window.dateFilters[tableId]) {
        $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(func => 
            func !== window.dateFilters[tableId]
        );
    }

    // Dodaj nowy filtr tylko je≈õli wybrano jakƒÖ≈õ datƒô
    if (minDate || maxDate) {
        window.dateFilters[tableId] = function(settings, data, dataIndex) {
            // Sprawd≈∫, czy to odpowiednia tabela
            if (settings.nTable.id !== tableId) return true;
            
            const dateStr = data[columnIndex];
            let dateValue = parseDate(dateStr);
            
            if (!dateValue) return true;
            
            let valid = true;
            if (minDate) {
                valid = valid && dateValue >= minDate;
            }
            if (maxDate) {
                valid = valid && dateValue <= maxDate;
            }
            return valid;
        };
        
        $.fn.dataTable.ext.search.push(window.dateFilters[tableId]);
    }

    window.dataTables[tableId].draw();
}

// Initialize buttons
document.addEventListener('DOMContentLoaded', function() {
    const buttonConfigurations = [
        { id: "generateSummary3Button", callback: generateSummary3Table },
        { id: "generateSummary4Button", callback: generateSummary4Table },
        { id: "generateSummary5Button", callback: generateSummary5Table },
        { id: "generateSummary6Button", callback: generateSummary6Table },
        { id: "generateSummary7Button", callback: generateSummary7Table },
        { id: "generateSummary8Button", callback: generateSummary8Table },
        { id: "generateSummary14Button", callback: generateAveragePriceSummary },
        { id: "generateSummary9Button", callback: () => generateSummaryTables(9, 10) },
        { id: "generateSummary11Button", callback: () => generateSummaryTables(11, 12) },
        { id: "generateSummary13Button", callback: generateSummary13Table },
        { id: "generateSummary15Button", callback: () => {
            calculateTransactionCounts();
            identifyRegistrationStatus();
        }}
    ];
    // Now add configuration for the "Generate All Tables" button
    const generateAllButtonConfig = {
        id: "generateAllTablesButton",
        callback: generateAllTables
    };
    buttonConfigurations.push(generateAllButtonConfig);
    
    buttonConfigurations.forEach(config => {
        handleButtonClick(config.id, config.callback);
    });
});

// Function to handle the click events
function handleButtonClick(buttonId, callback) {
    const button = document.getElementById(buttonId);
    if (button) {
        button.addEventListener("click", function () {
            if (button.disabled) return;
            button.disabled = true;
            button.textContent = "TrwajƒÖ czary ...";
            setTimeout(() => {
                callback();
                button.disabled = false;
                button.textContent = "Wygeneruj ponownie";
            }, 0);
        });
    } else {
        console.warn(`Button with id "${buttonId}" not found.`);
    }
}

// Function to generate all tables
function generateAllTables() {
    generateSummary3Table();
    generateSummary4Table();
    generateSummary5Table();
    generateSummary6Table();
    generateSummary7Table();
    generateSummary8Table();
    generateAveragePriceSummary();
    generateSummaryTables(9, 10);
    generateSummaryTables(11, 12);
    generateSummary13Table();
    calculateTransactionCounts();
    identifyRegistrationStatus();
}

const olejNapedowyData = [
[Date.UTC(2020, 0), 352923.19],
[Date.UTC(2020, 1), 406216.97],
[Date.UTC(2020, 2), 430244.12],
[Date.UTC(2020, 3), 322580.67],
[Date.UTC(2020, 4), 289811.22],
[Date.UTC(2020, 5), 296092.63],
[Date.UTC(2020, 6), 282355.88],
[Date.UTC(2020, 7), 316443.27],
[Date.UTC(2020, 8), 356950.05],
[Date.UTC(2020, 9), 265814.38],
[Date.UTC(2020, 10), 214034.65],
[Date.UTC(2020, 11), 220116.39],
[Date.UTC(2021, 0), 248914.9],
[Date.UTC(2021, 1), 335028],
[Date.UTC(2021, 2), 471463],
[Date.UTC(2021, 3), 440421.01],
[Date.UTC(2021, 4), 409004.62],
[Date.UTC(2021, 5), 366516.04],
[Date.UTC(2021, 6), 339508.85],
[Date.UTC(2021, 7), 420045.53],
[Date.UTC(2021, 8), 473564.35],
[Date.UTC(2021, 9), 410236.1],
[Date.UTC(2021, 10), 354142.72],
[Date.UTC(2021, 11), 329496.21],
[Date.UTC(2022, 0), 350951.02],
[Date.UTC(2022, 1), 417010.28],
[Date.UTC(2022, 2), 779418.35],
[Date.UTC(2022, 3), 603254.44],
[Date.UTC(2022, 4), 559684.13],
[Date.UTC(2022, 5), 455927.22],
[Date.UTC(2022, 6), 446950.48],
[Date.UTC(2022, 7), 585624.94],
[Date.UTC(2022, 8), 608895.3],
[Date.UTC(2022, 9), 456785.65],
[Date.UTC(2022, 10), 402579.17],
[Date.UTC(2022, 11), 356937.52],
[Date.UTC(2023, 0), 374699.55],
[Date.UTC(2023, 1), 376603.73],
[Date.UTC(2023, 2), 472212.71],
[Date.UTC(2023, 3), 429487.62],
[Date.UTC(2023, 4), 343085.6],
[Date.UTC(2023, 5), 284279.92],
[Date.UTC(2023, 6), 258330.28],
[Date.UTC(2023, 7), 354164.49],
[Date.UTC(2023, 8), 356849.3],
[Date.UTC(2023, 9), 283154.93],
[Date.UTC(2023, 10), 238252.6],
[Date.UTC(2023, 11), 184151.88],
[Date.UTC(2024, 0), 253828.96],
[Date.UTC(2024, 1), 328980.59],
[Date.UTC(2024, 2), 430076.18],
[Date.UTC(2024, 3), 448640.63],
[Date.UTC(2024, 4), 331656.74],
[Date.UTC(2024, 5), 293377.78],
[Date.UTC(2024, 6), 299045.92],
[Date.UTC(2024, 7), 329273.54],
[Date.UTC(2024, 8), 330750.84],
[Date.UTC(2024, 9), 298121.92],
[Date.UTC(2024, 10), 197031.82],
[Date.UTC(2024, 11), 178372.52],
[Date.UTC(2025, 0), 272234.78],
[Date.UTC(2025, 1), 323297.77],
[Date.UTC(2025, 2), 385441.34],
[Date.UTC(2025, 3), 351925.24],
[Date.UTC(2025, 4), 266535.54]
// Pozosta≈Çe dane...
];

const benzynaData = [
 [Date.UTC(2020, 0), 67876],
[Date.UTC(2020, 1), 63557.3],
[Date.UTC(2020, 2), 49599.98],
[Date.UTC(2020, 3), 28489.77],
[Date.UTC(2020, 4), 47873.95],
[Date.UTC(2020, 5), 64295.04],
[Date.UTC(2020, 6), 70633.04],
[Date.UTC(2020, 7), 74246.39],
[Date.UTC(2020, 8), 87803.39],
[Date.UTC(2020, 9), 75967.18],
[Date.UTC(2020, 10), 61211.97],
[Date.UTC(2020, 11), 68697.56],
[Date.UTC(2021, 0), 67186.53],
[Date.UTC(2021, 1), 77023.3],
[Date.UTC(2021, 2), 102609.84],
[Date.UTC(2021, 3), 108284.02],
[Date.UTC(2021, 4), 115303.77],
[Date.UTC(2021, 5), 131463.68],
[Date.UTC(2021, 6), 115035.81],
[Date.UTC(2021, 7), 124123.94],
[Date.UTC(2021, 8), 123774.14],
[Date.UTC(2021, 9), 124125.07],
[Date.UTC(2021, 10), 122881.31],
[Date.UTC(2021, 11), 106070.96],
[Date.UTC(2022, 0), 94397.05],
[Date.UTC(2022, 1), 130347.46],
[Date.UTC(2022, 2), 213386.64],
[Date.UTC(2022, 3), 234921.05],
[Date.UTC(2022, 4), 312138.05],
[Date.UTC(2022, 5), 361531.72],
[Date.UTC(2022, 6), 323416.06],
[Date.UTC(2022, 7), 317067.6],
[Date.UTC(2022, 8), 310294.77],
[Date.UTC(2022, 9), 334059.84],
[Date.UTC(2022, 10), 305772.58],
[Date.UTC(2022, 11), 294930.31],
[Date.UTC(2023, 0), 265212.11],
[Date.UTC(2023, 1), 291895.59],
[Date.UTC(2023, 2), 337311.39],
[Date.UTC(2023, 3), 330234.83],
[Date.UTC(2023, 4), 338056.46],
[Date.UTC(2023, 5), 334170.38],
[Date.UTC(2023, 6), 284364.32],
[Date.UTC(2023, 7), 329519.76],
[Date.UTC(2023, 8), 324473.35],
[Date.UTC(2023, 9), 307939.57],
[Date.UTC(2023, 10), 304119.01],
[Date.UTC(2023, 11), 285800.93],
[Date.UTC(2024, 0), 269254.2],
[Date.UTC(2024, 1), 289389.55],
[Date.UTC(2024, 2), 338583.71],
[Date.UTC(2024, 3), 376741.65],
[Date.UTC(2024, 4), 356119.66],
[Date.UTC(2024, 5), 352515.57],
[Date.UTC(2024, 6), 323223.35],
[Date.UTC(2024, 7), 326071.19],
[Date.UTC(2024, 8), 312110.39],
[Date.UTC(2024, 9), 338092.78],
[Date.UTC(2024, 10), 280988.33],
[Date.UTC(2024, 11), 270369.32],
[Date.UTC(2025, 0), 260361.09],
[Date.UTC(2025, 1), 274379.48],
[Date.UTC(2025, 2), 299772.90],
[Date.UTC(2025, 3), 318825.05],
[Date.UTC(2025, 4), 256122.16]
// Pozosta≈Çe dane...
];

const autostradyData = [
[Date.UTC(2020, 0), 6027],
[Date.UTC(2020, 1), 7021.28],
[Date.UTC(2020, 2), 5890.69],
[Date.UTC(2020, 3), 3573.49],
[Date.UTC(2020, 4), 4589.42],
[Date.UTC(2020, 5), 6806.77],
[Date.UTC(2020, 6), 5675.92],
[Date.UTC(2020, 7), 5655.56],
[Date.UTC(2020, 8), 6913.88],
[Date.UTC(2020, 9), 5008.61],
[Date.UTC(2020, 10), 2968.13],
[Date.UTC(2020, 11), 4042.3],
[Date.UTC(2021, 0), 4014.94],
[Date.UTC(2021, 1), 4763.21],
[Date.UTC(2021, 2), 5534.74],
[Date.UTC(2021, 3), 4029.1],
[Date.UTC(2021, 4), 6690.46],
[Date.UTC(2021, 5), 9041.19],
[Date.UTC(2021, 6), 6703.62],
[Date.UTC(2021, 7), 6899.23],
[Date.UTC(2021, 8), 6833.96],
[Date.UTC(2021, 9), 6460.83],
[Date.UTC(2021, 10), 6307.07],
[Date.UTC(2021, 11), 5532.17],
[Date.UTC(2022, 0), 6116.88],
[Date.UTC(2022, 1), 4989.82],
[Date.UTC(2022, 2), 7275.16],
[Date.UTC(2022, 3), 5395.91],
[Date.UTC(2022, 4), 6238.77],
[Date.UTC(2022, 5), 8171.06],
[Date.UTC(2022, 6), 6000.52],
[Date.UTC(2022, 7), 6350.68],
[Date.UTC(2022, 8), 7589.9],
[Date.UTC(2022, 9), 7284.13],
[Date.UTC(2022, 10), 6719.92],
[Date.UTC(2022, 11), 5458.38],
[Date.UTC(2023, 0), 4843.42],
[Date.UTC(2023, 1), 5452.15],
[Date.UTC(2023, 2), 7348.47],
[Date.UTC(2023, 3), 5664.82],
[Date.UTC(2023, 4), 7669.01],
[Date.UTC(2023, 5), 10115.99],
[Date.UTC(2023, 6), 4862.76],
[Date.UTC(2023, 7), 4249.26],
[Date.UTC(2023, 8), 3628.59],
[Date.UTC(2023, 9), 3319.86],
[Date.UTC(2023, 10), 2444.55],
[Date.UTC(2023, 11), 2962.04],
[Date.UTC(2024, 0), 2891.73],
[Date.UTC(2024, 1), 3422.46],
[Date.UTC(2024, 2), 2643.90],
[Date.UTC(2024, 3), 2157.82],
[Date.UTC(2024, 4), 3976.95],
[Date.UTC(2024, 5), 4352.51],
[Date.UTC(2024, 6), 2035.94],
[Date.UTC(2024, 7), 2787.07],
[Date.UTC(2024, 8), 2250.14],
[Date.UTC(2024, 9), 2541.40],
[Date.UTC(2024, 10), 3301.66],
[Date.UTC(2024, 11), 2695.36],
[Date.UTC(2025, 0), 4686.97],
[Date.UTC(2025, 1), 6242.69],
[Date.UTC(2025, 2), 6043.01],
[Date.UTC(2025, 3), 5847.41],
[Date.UTC(2025, 4), 6282.53]
// Pozosta≈Çe dane...
];

const adBlueData = [
[Date.UTC(2020, 0), 905.06],
[Date.UTC(2020, 1), 1160.8],
[Date.UTC(2020, 2), 1418.77],
[Date.UTC(2020, 3), 961.36],
[Date.UTC(2020, 4), 1263.16],
[Date.UTC(2020, 5), 1278.66],
[Date.UTC(2020, 6), 1104.08],
[Date.UTC(2020, 7), 1163.67],
[Date.UTC(2020, 8), 1192.45],
[Date.UTC(2020, 9), 1379.96],
[Date.UTC(2020, 10), 630.34],
[Date.UTC(2020, 11), 952.91],
[Date.UTC(2021, 0), 899.39],
[Date.UTC(2021, 1), 1478.22],
[Date.UTC(2021, 2), 1822.93],
[Date.UTC(2021, 3), 1509.05],
[Date.UTC(2021, 4), 1653.51],
[Date.UTC(2021, 5), 1684.8],
[Date.UTC(2021, 6), 1454.07],
[Date.UTC(2021, 7), 2284.83],
[Date.UTC(2021, 8), 2502.55],
[Date.UTC(2021, 9), 2665.64],
[Date.UTC(2021, 10), 2279.9],
[Date.UTC(2021, 11), 2248.47],
[Date.UTC(2022, 0), 2932.68],
[Date.UTC(2022, 1), 3242.09],
[Date.UTC(2022, 2), 5596.8],
[Date.UTC(2022, 3), 4770.45],
[Date.UTC(2022, 4), 5526.37],
[Date.UTC(2022, 5), 3932.7],
[Date.UTC(2022, 6), 5411.72],
[Date.UTC(2022, 7), 7207.67],
[Date.UTC(2022, 8), 9422.54],
[Date.UTC(2022, 9), 7789.96],
[Date.UTC(2022, 10), 5317.52],
[Date.UTC(2022, 11), 5462.6],
[Date.UTC(2023, 0), 5612.07],
[Date.UTC(2023, 1), 5622.65],
[Date.UTC(2023, 2), 6967.55],
[Date.UTC(2023, 3), 7114.83],
[Date.UTC(2023, 4), 6529.13],
[Date.UTC(2023, 5), 4919.09],
[Date.UTC(2023, 6), 5989.54],
[Date.UTC(2023, 7), 6557.7],
[Date.UTC(2023, 8), 8252.59],
[Date.UTC(2023, 9), 4554.19],
[Date.UTC(2023, 10), 3131.32],
[Date.UTC(2023, 11), 3006.75],
[Date.UTC(2024, 0), 3722.95],
[Date.UTC(2024, 1), 3468.19],
[Date.UTC(2024, 2), 4596.94],
[Date.UTC(2024, 3), 6699.24],
[Date.UTC(2024, 4), 4922.84],
[Date.UTC(2024, 5), 4150.27],
[Date.UTC(2024, 6), 4996.27],
[Date.UTC(2024, 7), 4704.71],
[Date.UTC(2024, 8), 4761.59],
[Date.UTC(2024, 9), 5311.33],
[Date.UTC(2024, 10), 2244.48],
[Date.UTC(2024, 11), 2159.94],
[Date.UTC(2025, 0), 4386.79],
[Date.UTC(2025, 1), 3016.39],
[Date.UTC(2025, 2), 5331.12],
[Date.UTC(2025, 3), 5460.85],
[Date.UTC(2025, 4), 4448.94]
// Pozosta≈Çe dane...
];

const olejeSilnikoweData = [
[Date.UTC(2020, 0), 260.77],
[Date.UTC(2020, 1), 258.74],
[Date.UTC(2020, 2), 364.35],
[Date.UTC(2020, 3), 321.89],
[Date.UTC(2020, 4), 251.58],
[Date.UTC(2020, 5), 234.01],
[Date.UTC(2020, 6), 488.81],
[Date.UTC(2020, 7), 474.44],
[Date.UTC(2020, 8), 500.81],
[Date.UTC(2020, 9), 592.17],
[Date.UTC(2020, 10), 200.76],
[Date.UTC(2020, 11), 536.74],
[Date.UTC(2021, 0), 222.49],
[Date.UTC(2021, 1), 306.46],
[Date.UTC(2021, 2), 680.97],
[Date.UTC(2021, 3), 685.92],
[Date.UTC(2021, 4), 1108.6],
[Date.UTC(2021, 5), 628.91],
[Date.UTC(2021, 6), 554.08],
[Date.UTC(2021, 7), 614.52],
[Date.UTC(2021, 8), 312.04],
[Date.UTC(2021, 9), 541.85],
[Date.UTC(2021, 10), 766.75],
[Date.UTC(2021, 11), 480.41],
[Date.UTC(2022, 0), 404.81],
[Date.UTC(2022, 1), 68.27],
[Date.UTC(2022, 2), 605.59],
[Date.UTC(2022, 3), 451.93],
[Date.UTC(2022, 4), 674.7],
[Date.UTC(2022, 5), 388.39],
[Date.UTC(2022, 6), 187.7],
[Date.UTC(2022, 7), 751.1],
[Date.UTC(2022, 8), 377.16],
[Date.UTC(2022, 9), 284.51],
[Date.UTC(2022, 10), 574.69],
[Date.UTC(2022, 11), 138.19],
[Date.UTC(2023, 0), 525.12],
[Date.UTC(2023, 1), 505.6],
[Date.UTC(2023, 2), 456.82],
[Date.UTC(2023, 3), 247.92],
[Date.UTC(2023, 4), 1010.38],
[Date.UTC(2023, 5), 377.98],
[Date.UTC(2023, 6), 422.68],
[Date.UTC(2023, 7), 352.77],
[Date.UTC(2023, 8), 1052.65],
[Date.UTC(2023, 9), 402.94],
[Date.UTC(2023, 10), 197.31],
[Date.UTC(2023, 11), 332.62],
[Date.UTC(2024, 0), 553.37],
[Date.UTC(2024, 1), 443],
[Date.UTC(2024, 2), 502.74],
[Date.UTC(2024, 3), 353.04],
[Date.UTC(2024, 4), 635.78],
[Date.UTC(2024, 5), 635.78],
[Date.UTC(2024, 6), 337.16],
[Date.UTC(2024, 7), 285.00],
[Date.UTC(2024, 8), 591.16],
[Date.UTC(2024, 9), 547.33],
[Date.UTC(2024, 10), 298.60],
[Date.UTC(2024, 11), 319.78],
[Date.UTC(2025, 0), 346.98],
[Date.UTC(2025, 1), 160.26],
[Date.UTC(2025, 2), 608.56],
[Date.UTC(2025, 3), 54.43],
[Date.UTC(2025, 4), 347.75]
// Pozosta≈Çe dane...
];

document.addEventListener('DOMContentLoaded', function () {
    // Konfiguracja jƒôzyka dla polskich miesiƒôcy
    Highcharts.setOptions({
        lang: {
            months: ['Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'],
            shortMonths: ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'Pa≈∫', 'Lis', 'Gru']
        }
    });

    // Dane kt√≥re mogƒÖ byƒá zdefiniowane wcze≈õniej lub wczytane z serwera
    const chartData = {
        olejNapedowy: olejNapedowyData,
        benzyna: benzynaData,
        autostrady: autostradyData,
        adBlue: adBlueData,
        olejeSilnikowe: olejeSilnikoweData
    };

    // Zunifikowana funkcja do obliczania sumy dla zakresu dat
    const calculateSum = (data, dateRange) => {
        return data.reduce((sum, [timestamp, value]) => 
            (timestamp >= dateRange[0] && timestamp <= dateRange[1]) ? sum + value : sum, 0);
    };

    // Funkcja formatujƒÖca sumƒô z separatorami tysiƒôcy
    const formatCurrency = (value) => 
        Math.round(value).toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' z≈Ç';

    // Funkcja do aktualizacji element√≥w DOM z sumami
    const updateSumDisplay = (elementId, periodElementId, sum, dateRange) => {
        const sumElement = document.getElementById(elementId);
        const periodElement = document.getElementById(periodElementId);
        
        if (sumElement && periodElement) {
            sumElement.textContent = formatCurrency(sum);
            periodElement.textContent = `${new Date(dateRange[0]).toLocaleDateString('pl-PL')} - ${new Date(dateRange[1]).toLocaleDateString('pl-PL')}`;
        }
    };

    // G≈Ç√≥wna konfiguracja wykresu
    const chart = Highcharts.stockChart('chart-container-0', {
        chart: {
            type: 'areaspline',
            zoomType: 'x',
            height: 470,
            spacingLeft: 1,
            spacingRight: 1,
            renderer: 'webgl',
            events: {
                redraw: function () {
                    const dateRange = this.xAxis[0].getExtremes();
                    
                    // Aktualizacja sum dla poszczeg√≥lnych kategorii
                    updateSumDisplay(
                        'benzynaSuma', 
                        'benzynaOkres', 
                        calculateSum(chartData.benzyna, [dateRange.min, dateRange.max]),
                        [dateRange.min, dateRange.max]
                    );

                    updateSumDisplay(
                        'olejNapedowySuma', 
                        'olejNapedowyOkres', 
                        calculateSum(chartData.olejNapedowy, [dateRange.min, dateRange.max]),
                        [dateRange.min, dateRange.max]
                    );
                }
            }
        },
        title: { text: 'Analiza wydatk√≥w - karty FLOTA' },
        credits: { enabled: false },
        legend: { enabled: true },
        
        xAxis: {
            type: 'datetime',
            min: Date.UTC(new Date().getFullYear() - 1, 0, 1),
            max: Date.UTC(new Date().getFullYear(), 0, 1)
        },
        
        Axis: [{
            title: { text: 'Warto≈õƒá' },
            opposite: false
        }],
        
        series: [
            { name: 'Olej napƒôdowy', data: chartData.olejNapedowy },
            { name: 'Benzyna', data: chartData.benzyna },
            { name: 'Autostrady', data: chartData.autostrady },
            { name: 'adBlue', data: chartData.adBlue },
            { name: 'Oleje silnikowe', data: chartData.olejeSilnikowe }
        ],
        
        exporting: {
            buttons: {
                contextButton: {
                    menuItems: [
                        'viewFullscreen', 'printChart', 'separator', 
                        'downloadPNG', 'downloadJPEG', 'downloadPDF', 'downloadSVG', 
                        'separator', 'downloadCSV', 'downloadXLSX', 'viewData'
                    ]
                }
            },
            csv: { dateFormat: '%Y-%m-%d %H:%M:%S' },
            menuItemDefinitions: {
                viewData: {
                    onclick: function () {
                        this.viewData();
                        this.chart.container.style.width = '';
                    }
                },
                hideData: {
                    text: 'Hide Data Table',
                    onclick: function () {
                        this.dataTableDiv.style.display = 'none';
                    }
                }
            }
        },
        
        navigation: {
            buttonOptions: {
                enabled: true,
                x: -10
            }
        },
        
        rangeSelector: {
            buttonTheme: {
                width: 'auto',
                padding: 4,
                r: 2,
                style: { fontSize: '10px' }
            },
            inputBoxWidth: 100,
            inputStyle: { fontSize: '10px' }
        },
        
        responsive: {
            rules: [{
                condition: { maxWidth: 500 },
                chartOptions: {
                    legend: {
                        layout: 'horizontal',
                        align: 'center',
                        verticalAlign: 'bottom'
                    }
                }
            }]
        }
    });

    // Wyliczenie poczƒÖtkowych sum po uruchomieniu
    const initialDateRange = chart.xAxis[0].getExtremes();
    updateSumDisplay(
        'benzynaSuma', 
        'benzynaOkres', 
        calculateSum(chartData.benzyna, [initialDateRange.min, initialDateRange.max]),
        [initialDateRange.min, initialDateRange.max]
    );
    updateSumDisplay(
        'olejNapedowySuma', 
        'olejNapedowyOkres', 
        calculateSum(chartData.olejNapedowy, [initialDateRange.min, initialDateRange.max]),
        [initialDateRange.min, initialDateRange.max]
    );
});

// Obliczanie daty wyga≈õniƒôcia
var expiryDate = new Date();
expiryDate.setDate(expiryDate.getDate() + 7); // Dodanie 7 dni

// Formatowanie daty do formatu zgodnego z nag≈Ç√≥wkiem Expires
var formattedExpiryDate = expiryDate.toUTCString();

// Ustawienie nag≈Ç√≥wka Expires
document.cookie = "Expires=" + formattedExpiryDate + "; path=/";

// Informacja o ustawieniu nag≈Ç√≥wka
console.log("Nag≈Ç√≥wek Expires zosta≈Ç ustawiony na:", formattedExpiryDate);

// Funkcja do ustawienia jƒôzyka dla wszystkich tabel DataTables
$.fn.dataTable.defaults.language = {
    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pl.json'
};

function showInfo() {
            alert(`Weryfikacja licznika:
Funkcja rozpoczyna od zbierania wszystkich warto≈õci licznik√≥w dla danego numeru rejestracyjnego i roku z poszczeg√≥lnych miesiƒôcy.
Nastƒôpnie stosuje metodƒô IQR (interkwartylowy zakres), aby zidentyfikowaƒá warto≈õci odstajƒÖce. IQR jest obliczany na podstawie kwartylu pierwszego (Q1) i trzeciego (Q3) zbioru warto≈õci licznik√≥w.
Warto≈õci licznik√≥w spoza zakresu Q1 - 1.5 * IQR do Q3 + 1.5 * IQR sƒÖ uznawane za potencjalnie nieprawid≈Çowe i sƒÖ odfiltrowywane.

Korekty:
Po odfiltrowaniu warto≈õci odstajƒÖcych, funkcja sprawdza, czy sƒÖ dostƒôpne r√≥wnie≈º przysz≈Çe warto≈õci licznik√≥w (z kolejnych miesiƒôcy).
Je≈õli tak, oblicza ≈õredniƒÖ i maksymalnƒÖ warto≈õƒá przysz≈Çych licznik√≥w.
Warto≈õci licznik√≥w sƒÖ dalej filtrowane w taki spos√≥b, ≈ºe nie mogƒÖ przekroczyƒá 10-krotno≈õci ≈õredniej przysz≈Çych warto≈õci lub 5-krotno≈õci maksymalnej przysz≈Çej warto≈õci.
Je≈õli po tej operacji nie pozostaje ≈ºadna warto≈õƒá, kt√≥ra spe≈Çnia kryteria, funkcja zwraca medianƒô przysz≈Çych warto≈õci lub obecnƒÖ warto≈õƒá licznika jako warto≈õƒá skorygowanƒÖ.
W przeciwnym razie, wybierana jest maksymalna warto≈õƒá spo≈õr√≥d przefiltrowanych warto≈õci, co stanowi potencjalnƒÖ poprawƒô licznika.

Czerwony (red) ‚Äì Warto≈õƒá zosta≈Ça skorygowana na podstawie ≈õredniej z dw√≥ch sƒÖsiadujƒÖcych miesiƒôcy (poprzedniego i nastƒôpnego miesiƒÖca). Oznacza to, ≈ºe warto≈õƒá by≈Ça wyra≈∫nie b≈Çƒôdna w stosunku do ≈õredniej z obu sƒÖsiad√≥w.
Pomara≈Ñczowy (orange) ‚Äì Warto≈õƒá zosta≈Ça skorygowana na podstawie warto≈õci z poprzedniego miesiƒÖca. Je≈õli warto≈õƒá by≈Ça zbyt niska lub za wysoka w stosunku do poprzedniego miesiƒÖca, zosta≈Ça poprawiona.
Fioletowy (purple) ‚Äì Warto≈õƒá zosta≈Ça skorygowana na podstawie warto≈õci z nastƒôpnego miesiƒÖca. Oznacza to, ≈ºe warto≈õƒá by≈Ça wyra≈∫nie b≈Çƒôdna w stosunku do warto≈õci kolejnego miesiƒÖca.
Zielony (green) ‚Äì Warto≈õƒá zosta≈Ça skorygowana, gdy brak by≈Ço zar√≥wno poprawnych warto≈õci z poprzedniego, jak i nastƒôpnego miesiƒÖca. Warto≈õƒá zosta≈Ça ustalona na podstawie mediany lub poprawionych warto≈õci w miesiƒÖcu.`);
}
</script>

<!-- Minimalistyczny przycisk i blok z pe≈ÇnƒÖ tre≈õciƒÖ -->
<button class="toggle-button" onclick="toggleVisibility(this)">+</button>
<div class="toggle-content" style="display: none;">
  <h3>G≈Ç√≥wne usprawnienia w zoptymalizowanej wersji:</h3>
  <ol>
    <li><strong>Lepsze zarzƒÖdzanie b≈Çƒôdnymi danymi</strong>
      <ul>
        <li>Walidacja danych wej≈õciowych: Funkcja <code>sanitizeNumericValue()</code> czy≈õci i waliduje wszystkie warto≈õci numeryczne</li>
        <li>Sprawdzanie dat: Weryfikacja poprawno≈õci dat przed przetwarzaniem</li>
        <li>Filtrowanie nierealistycznych warto≈õci: Eliminacja spalania poni≈ºej 2l/100km i powy≈ºej 50l/100km</li>
      </ul>
    </li>
    <li><strong>Zaawansowana detekcja anomalii</strong>
      <ul>
        <li>Metoda IQR: U≈ºywa rozstƒôpu miƒôdzykwartylowego zamiast odchylenia standardowego (bardziej odporna na warto≈õci odstajƒÖce)</li>
        <li>Progowanie statystyczne: Wymaga minimum 3 pr√≥bek do obliczania wiarygodnych statystyk</li>
        <li>Detekcja cofniƒôcia licznika: Identyfikuje potencjalne problemy z odczytem licznika</li>
      </ul>
    </li>
    <li><strong>Realistyczne modelowanie zu≈ºycia</strong>
      <ul>
        <li>Minimalna odleg≈Ço≈õƒá: Wymaga co najmniej 10km do obliczenia spalania</li>
        <li>Ograniczenia czasowe: Minimum 1 dzie≈Ñ miƒôdzy tankowaniami</li>
        <li>Maksymalny dzienny przebieg: Ograniczenie do 1000km/dzie≈Ñ</li>
        <li>Estymacja na podstawie profilu pojazdu: Lepsze szacowanie brakujƒÖcych danych</li>
      </ul>
    </li>
    <li><strong>System pewno≈õci danych</strong>
      <ul>
        <li>Poziomy pewno≈õci: Wysoki, ≈õredni, niski, szacowany</li>
        <li>Wizualne oznaczenia: Kolorowe kodowanie wed≈Çug jako≈õci danych</li>
        <li>Legenda jako≈õci: Wyja≈õnienie znaczenia kolor√≥w dla u≈ºytkownika</li>
      </ul>
    </li>
    <li><strong>Ulepszona analiza statystyczna</strong>
      <ul>
        <li>Mediana i kwartyle: Dodatkowe metryki odporne na warto≈õci odstajƒÖce</li>
        <li>Usuwanie anomalii: Automatyczne wykluczanie nietypowych warto≈õci z oblicze≈Ñ ≈õredniej</li>
        <li>Profil pojazdu: ≈öledzenie historii ka≈ºdego pojazdu osobno</li>
      </ul>
    </li>
    <li><strong>Lepsza wydajno≈õƒá</strong>
      <ul>
        <li>Dwuprzebiegowe przetwarzanie: Najpierw budowanie profili, potem przetwarzanie</li>
        <li>Konfiguracja przez sta≈Çe: ≈Åatwe dostosowanie parametr√≥w</li>
        <li>Optymalizowana struktura danych: Mniej powtarzajƒÖcych siƒô oblicze≈Ñ</li>
      </ul>
    </li>
    <li><strong>Dodatkowe funkcje</strong>
      <ul>
        <li>Podsumowanie jako≈õci danych: Wizualne wyja≈õnienie oznacze≈Ñ</li>
        <li>Lepsze grupowanie: Uwzglƒôdnia ≈õrednie spalanie w podsumowaniach grup</li>
        <li>Ukryta kolumna pewno≈õci: Dodatkowe informacje dostƒôpne na ≈ºƒÖdanie</li>
      </ul>
    </li>
  </ol>
</div>

<!-- Skrypt lokalny do prze≈ÇƒÖczania widoczno≈õci -->
<script>
  function toggleVisibility(btn) {
    const content = btn.nextElementSibling;
    if (content.style.display === "none") {
      content.style.display = "block";
      btn.textContent = "‚Äì";
    } else {
      content.style.display = "none";
      btn.textContent = "+";
    }
  }
</script>

<!-- Minimalny styl -->
<style>
  .toggle-button {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 1.2rem;
    font-weight: bold;
    line-height: 32px;
    text-align: center;
    cursor: pointer;
    margin-bottom: 0.5rem;
  }

  .toggle-button:hover {
    background-color: #0056b3;
  }

  .toggle-content {
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    background-color: #f8f9fa;
    margin-bottom: 1rem;
  }

  .toggle-content h3 {
    margin-top: 0;
  }

  .toggle-content ul {
    padding-left: 1.2rem;
    margin-bottom: 1rem;
  }
</style>
</body>
</html>
